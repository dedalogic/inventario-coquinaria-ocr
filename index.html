<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Coquinaria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4a0404">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --header-bg-gradient: linear-gradient(135deg, #4a0404 0%, #2c0202 100%);
            --accent-burdeo: #5e0808;
            --text-rosa-palo: #b85c67;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --body-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-light: #e2e8f0;
            --color-green: #059669;
            --progress-color: #27ae60;
            
            /* Colores Pantone */
            --pantone-7747c: #2F5C39;
            --pantone-131c: #CC8A00;
            --pantone-2379c: #C31F75;
            
            --btn-cta-gradient: linear-gradient(135deg, #d48790 0%, #b85c67 100%); 
            --btn-cta-shadow: rgba(184, 92, 103, 0.4);

            --header-height: 75px; 
            --controls-height: 145px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: 200px;
            padding-bottom: 90px; 
            font-weight: 400;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background: var(--header-bg-gradient);
            height: var(--header-height);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header-logo { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 200; color: white; letter-spacing: 2px; text-transform: uppercase; }
        .header-actions { display: flex; flex-direction: row; align-items: center; color: rgba(255, 255, 255, 0.95); gap: 4px; }
        .header-control { display: flex; align-items: center; gap: 4px; }
        .header-control input[type="date"] { background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 10px; border-radius: 6px; font-size: 13px; cursor: pointer; }
        .header-control input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .header-icon-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 4px; transition: all 0.2s; }
        .header-icon-btn:hover { opacity: 0.8; transform: scale(1.1); }
        .header-icon-btn svg { width: 22px; height: 22px; stroke-width: 2; }
        .progress-line { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }

        /* CONTROLES */
.sticky-controls {
    position: fixed; 
    top: var(--header-height); 
    left: 0; 
    right: 0;
    background: var(--body-bg); 
    z-index: 900;
    display: flex; 
    flex-direction: column;
    border-bottom: 1px solid rgba(0,0,0,0.05); 
    box-shadow: 0 4px 6px -4px rgba(0,0,0,0.05);
    padding-bottom: 8px;
}
        .search-container { padding: 10px 20px 8px 20px; 
        background: var(--body-bg);
                          }
        .search-wrapper { position: relative; width: 100%; }
        .search-input { width: 100%; background: white; border: 1px solid var(--border-light); padding: 10px 40px; border-radius: 12px; font-size: 14px; height: 44px; transition: all 0.2s; outline: none; }
        .search-input:focus { border-color: var(--text-rosa-palo); box-shadow: 0 0 0 3px rgba(184, 92, 103, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; }
        .clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background:none; border:none; font-size:16px; color:#999; display:none; padding:5px; }

        .menu-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 10px 20px; scrollbar-width: none; align-items: center; height: 50px; }
        .menu-scroll::-webkit-scrollbar { display: none; }

        .menu-chip { display: inline-flex; align-items: center; gap: 6px; background: white; border: 1px solid var(--border-light); padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.03); flex-shrink: 0; height: 38px; }
        .menu-chip.active { background: var(--text-rosa-palo); color: white; border-color: var(--text-rosa-palo); box-shadow: 0 4px 10px rgba(184, 92, 103, 0.3); font-weight: 600; }
        .menu-chip.completed { color: #10b981; font-weight: 600; }
        /* Colores Espec√≠ficos */
        .menu-chip.count-active { background: var(--pantone-7747c); color: white; border-color: var(--pantone-7747c); box-shadow: 0 4px 10px rgba(47, 92, 57, 0.3); }
        .menu-chip.recep-active { background: var(--pantone-131c); color: white; border-color: var(--pantone-131c); box-shadow: 0 4px 10px rgba(204, 138, 0, 0.3); }
        .menu-chip.sugg-active { background: var(--pantone-2379c); color: white; border-color: var(--pantone-2379c); box-shadow: 0 4px 10px rgba(195, 31, 117, 0.3); }
        
        .menu-chip svg { width: 16px; height: 16px; stroke-width: 2; }
        .menu-chip:active { transform: scale(0.97); }
        
        .btn-finalizar-marca { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; height: 38px; transition: all 0.2s; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); flex-shrink: 0; margin-left: 8px; }
        .btn-finalizar-marca:hover { background: #059669; box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4); }
        .btn-finalizar-marca:active { transform: scale(0.95); }

        /* LISTA */
        .products-list { padding: 0 20px; }
        .product-card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .product-card:active { transform: scale(0.99); background-color: #fafafa; }
        .product-card.counted { border-left: 4px solid var(--pantone-7747c); }
        .product-card.reception-counted { border-left: 4px solid var(--pantone-131c); }
        .product-card.suggestion-counted { border-left: 4px solid var(--pantone-2379c); }

        .product-info { flex: 1; margin-right: 15px; }
        .product-info h4 { font-size: 14px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; font-weight: 600; }
        .product-sku { font-size: 11px; color: var(--text-secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; display: inline-block; font-weight: 500; }
        
        .stock-control { display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .stock-control.count-mode { border-color: var(--pantone-7747c); background: #f0fdf4; }
        .stock-control.reception-mode { border-color: var(--pantone-131c); background: #fffbf0; }
        .stock-control.suggestion-mode { border-color: var(--pantone-2379c); background: #fdf2f8; }

        .btn-stock { width: 30px; height: 30px; border: none; background: white; border-radius: 6px; color: var(--text-primary); font-weight: 700; font-size: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-stock:active { background: #e2e8f0; }
        .stock-input { width: 34px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 15px; color: var(--text-primary); }
        .catalog-display { font-size: 13px; font-weight: 600; color: #94a3b8; min-width: 40px; text-align: center; }

        /* Document Input (Recepci√≥n) */
        .doc-input-container {
            padding: 10px 20px;
            background: #fffbf0;
            border-bottom: 1px solid #f0e6d2;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }
        .doc-input {
            width: 100%; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;
            font-size: 14px; outline: none;
        }

        /* CTA */
        .cta-container { padding: 20px; padding-bottom: 40px; display: flex; gap: 10px; flex-direction: column; }
        .btn-cta { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px var(--btn-cta-shadow); background: var(--btn-cta-gradient); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-cta:active { transform: scale(0.98); }
        .btn-cta.secondary { background: white; color: var(--text-primary); border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* OVERLAY */
        .product-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .product-overlay.active { opacity: 1; pointer-events: auto; }
        .detail-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; max-height: 85vh; display: flex; flex-direction: column; }
        .product-overlay.active .detail-card { transform: scale(1); }
        .detail-image-box { display: none; }
        .detail-img { width: 100%; height: 100%; object-fit: contain; padding: 20px; }
        .detail-placeholder { font-size: 50px; opacity: 0.1; }
        .detail-content { padding: 25px; overflow-y: auto; }
        .detail-brand { font-size: 11px; text-transform: uppercase; color: var(--text-rosa-palo); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
        .detail-origin { font-size: 10px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; margin-left: 8px; }
        .detail-title { font-size: 20px; font-weight: 700; color: var(--text-primary); line-height: 1.3; margin-bottom: 8px; }
        .detail-sku { font-size: 13px; color: #94a3b8; font-family: monospace; margin-bottom: 15px; }
        .detail-desc { font-size: 15px; line-height: 1.6; color: #475569; }
        .close-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.9); border: none; font-size: 20px; color: #333; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bg); height: 80px; display: flex; justify-content: space-around; align-items: flex-start; padding-top: 12px; border-top: 1px solid var(--border-light); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; cursor: pointer; }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }
        .nav-item.active { color: var(--accent-burdeo); }
        .nav-item.active svg { stroke-width: 2.5; }

        .floating-scroll-btn { position: fixed; bottom: 100px; right: 20px; width: 30px; height: 30px; background: var(--text-rosa-palo); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(184, 92, 103, 0.4); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; z-index: 1900; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; pointer-events: none; transform: translateY(20px); }
        .floating-scroll-btn.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .floating-scroll-btn svg { width: 16px; height: 16px; stroke-width: 2.5; }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 5000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }
        #dateInput { position: absolute; opacity: 0; width: 0; height: 0; bottom: 0; right: 0; pointer-events: none; }
        .history-item { background: white; padding: 18px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        #scanInput { display: none; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }

        /* FILTROS EXPANDIBLES */
        .filter-toggle-container {
            display: flex; gap: 8px; padding: 0 20px 8px 20px;
        }
        .filter-toggle {
            flex: 1;
            background: white;
            border: 1px solid var(--border-light);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .filter-toggle:active { transform: scale(0.98); }
        .filter-toggle.active {
            background: var(--text-rosa-palo);
            color: white;
            border-color: var(--text-rosa-palo);
            box-shadow: 0 4px 10px rgba(184, 92, 103, 0.3);
        }
        .filter-toggle svg {
            width: 16px; height: 16px; 
            transition: transform 0.2s;
        }
        .filter-toggle.expanded svg {
            transform: rotate(180deg);
        }
        .filter-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-selected {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 400;
        }

/* OPCIONES DE FILTRO */
.filter-options {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    padding: 0 20px;
}
.filter-options.expanded {
    max-height: 100px; /* üëà AUMENTAR de 60px a 100px */
    padding: 0 20px 10px 20px;
}
.filter-chips {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    scrollbar-width: none;
    padding: 2px 0;
}
.filter-chips::-webkit-scrollbar { display: none; }
.filter-chip {
    display: inline-flex;
    align-items: center;
    background: white;
    border: 1px solid var(--border-light);
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    flex-shrink: 0;
}
.filter-chip.active {
    background: var(--text-rosa-palo);
    color: white;
    border-color: var(--text-rosa-palo);
    box-shadow: 0 4px 10px rgba(184, 92, 103, 0.3);
    font-weight: 600;
}
.filter-chip:active { transform: scale(0.97); }

        /* B√öSQUEDA INTELIGENTE */
        .search-suggestions {
            display: none !important;
        }
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            display: none;
        }
        .search-suggestions.active {
            display: block;
        }
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .suggestion-item:hover {
            background: #f8fafc;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-icon {
            width: 16px;
            height: 16px;
            color: #94a3b8;
            flex-shrink: 0;
        }
        .suggestion-text {
            flex: 1;
            font-size: 14px;
            color: #1e293b;
        }
        .suggestion-meta {
            font-size: 11px;
            color: #94a3b8;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .suggestion-highlight {
            background: #fef3c7;
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }
        .suggestion-header {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clear-history {
            color: var(--text-rosa-palo);
            cursor: pointer;
            font-size: 10px;
        }
        .clear-history:hover {
            text-decoration: underline;
        }
.no-results {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }

/* HISTORIAL MODERNO - ACTUALIZADO */
.history-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid #e2e8f0;
}

.history-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f1f5f9;
}

.history-card-type {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
}

.history-card-type.inventario {
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #86efac;
}

.history-card-type.recepcion {
    background: #fffbf0;
    color: #92400e;
    border: 1px solid #fde68a;
}

.history-card-delete {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.history-card-delete:hover {
    background: #fee2e2;
    transform: scale(1.05);
}

.history-card-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 8px;
}

.history-card-meta {
    font-size: 13px;
    color: #64748b;
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.history-card-meta span {
    display: flex;
    align-items: center;
    gap: 6px;
}

.history-card-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.history-stat {
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
}

.history-stat-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    font-weight: 600;
}

.history-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
}

.history-stat.ok .history-stat-value { 
    color: #059669; 
}

.history-stat.diff .history-stat-value { 
    color: #dc2626; 
}

.history-card-actions {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
}

.history-action-btn {
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.history-action-btn.primary {
    background: linear-gradient(135deg, #4a0404 0%, #7f1d1d 100%);
    color: white;
}

.history-action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 4, 4, 0.3);
}

.history-action-btn.secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}

.history-action-btn.secondary:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
}
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div style="background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 280px;">
    <div style="font-size: 40px; margin-bottom: 15px;">‚òÅÔ∏è</div>
<div style="font-weight: 700; color: #1e293b; font-size: 16px; margin-bottom: 10px;">Procesando...</div>
<div style="font-size: 13px; color: #64748b;">Esto puede tomar unos segundos</div>
            <div style="margin-top: 15px;">
                <div style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;">
                    <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #4a0404, #7f1d1d); animation: loading 1.5s infinite;"></div>
                </div>
            </div>
        </div>
    </div>
    <style>
        @keyframes loading {
            0% { width: 10%; margin-left: 0; }
            50% { width: 50%; margin-left: 25%; }
            100% { width: 10%; margin-left: 90%; }
        }
    </style>

    <input type="file" id="fileImport" accept=".csv,.txt" style="display:none" onchange="handleFileImport(this)">
    <input type="file" id="scanInput" accept="image/*" capture="environment" onchange="handleScan(this)">
    <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none" onchange="importarExcelRecepcion(this.files[0])">
    <input type="file" id="importInventoryExcel" accept=".xlsx,.xls" style="display:none" onchange="importarExcelInventario(this.files[0])">
    <input type="file" id="importReceptionExcel" accept=".xlsx,.xls" style="display:none" onchange="importarExcelRecepcion(this.files[0])">
    <input type="file" id="importGuidaPDF" accept=".pdf,image/*" style="display:none" onchange="importarGuidaPDF(this.files[0])">
    <input type="file" id="importCatalogo" accept=".xlsx,.xls,.json" style="display:none" onchange="importarCatalogo(this.files[0])">
    <input type="file" id="importGuiaExcel" accept=".xlsx,.xls" style="display:none" onchange="importarGuiaDesdeExcel(this.files[0])">
    
    <!-- HEADER -->
    <div class="header">
        <div class="header-logo">COQUINARIA</div>
        <div class="header-actions" id="headerActions">
            <!-- Se llena din√°micamente seg√∫n la vista -->
        </div>
        <input type="date" id="dateInput">
        <div class="progress-line"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <div class="sticky-controls" id="stickyControls">
        <div class="search-container">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre, SKU, marca..." 
                       oninput="handleSearchInput(this)" 
                       onfocus="showSuggestions()" 
                       onblur="hideSuggestionsDelayed()">
                <button class="clear-search" onclick="clearSearch()">‚úï</button>
                
                <!-- SUGGESTIONS DROPDOWN -->
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
        </div>
        
        <!-- FILTROS TOGGLE -->
        <div id="filterToggles"></div>
        
        <!-- OPCIONES DE FILTROS -->
        <div id="filterOptions"></div>
        
        <!-- TOOLBAR DIN√ÅMICO -->
        <div id="toolbarMenu" class="menu-scroll"></div>
    </div>

    <!-- MAIN PRODUCT LIST -->
    <div id="view-products">
        <div id="docInputContainer"></div>
        <div id="productsContainer" class="products-list"></div>
        <div class="cta-container" id="ctaContainer"></div>
        <button id="floatingSaveBtn" class="floating-scroll-btn" onclick="handleFloatingClick()">
            <svg id="floatingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
        </button>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" style="display:none; padding: 20px; padding-top: 120px;">
        <h3 style="margin-bottom:20px; color:#1e293b; font-size:18px;">Historial</h3>
        
        <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: flex-end;">
            <div style="flex: 1;">
                <input type="text" id="historySearchInput" placeholder="Buscar por fecha (ej: 2026-01), n√∫mero de gu√≠a o responsable..." 
                       style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;"
                       onkeyup="renderHistory()">
            </div>
            <select id="historyFilterType" style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: white; cursor: pointer; min-width: 140px;" onchange="renderHistory()">
                <option value="">Todos los tipos</option>
                <option value="Inventario">Inventario</option>
                <option value="Recepci√≥n">Gu√≠a de Despacho</option>
            </select>
        </div>
        
        <div id="historyContent"></div>
    </div>

    <!-- PRODUCT DETAIL OVERLAY -->
    <div id="productOverlay" class="product-overlay">
        <div class="detail-card" id="detailCard">
            <button class="close-btn" onclick="closeOverlay()">‚úï</button>
            <div class="detail-image-box">
                <img id="dImg" class="detail-img" src="" style="display:none">
            </div>
            <div class="detail-content">
                <div style="display:flex; align-items:center; margin-bottom:5px;">
                    <div class="detail-brand" id="dBrand">MARCA</div>
                    <div class="detail-origin" id="dOrigin" style="display:none;"></div>
                </div>
                <div class="detail-title" id="dName">Producto</div>
                <div class="detail-sku">SKU: <span id="dSku"></span></div>
                <div class="detail-desc" id="dDesc">Descripci√≥n...</div>
            </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="shareModalTitle">Compartir Reporte</h3>
            <div class="modal-actions">
                <button class="btn-cta" onclick="executeShare('whatsapp')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                    Enviar por WhatsApp
                </button>
                <button class="btn-cta secondary" onclick="executeShare('email')">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/></svg>
                    Enviar por Correo
                </button>
                <button class="btn-cta secondary" style="border:none; color:#64748b; margin-top:5px;" onclick="closeShareModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- FIRMA MODAL (EXCLUSIVO) -->
    <div id="firmaModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Finalizar Conteo</h3>
            <div id="firmaModalContent"></div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-item active" id="nav-catalog" onclick="switchMainView('catalog')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
            <span>Cat√°logo</span>
        </button>
        <button class="nav-item" id="nav-inventory" onclick="switchMainView('inventory')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
            <span>Inventario</span>
        </button>
        <button class="nav-item" id="nav-reception" onclick="switchMainView('reception')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            <span>Recepci√≥n</span>
        </button>
        <button class="nav-item" id="nav-history" onclick="switchMainView('history')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Historial</span>
        </button>
    </div>

    <div id="toast" class="toast"></div>

    
    <script>
        // ============================================
        // CONFIGURACI√ìN GOOGLE SHEETS
        // ============================================
        const GOOGLE_CLIENT_ID = '319683500693-qi5gip7glasaor54hk5rlmflj49oi4kf.apps.googleusercontent.com';
        const GOOGLE_API_KEY = ''; // No necesario para OAuth
        const SPREADSHEET_ID = '1Z-XxiwIpWoZoc0ir0rTjOgKwmkwibrFzVWH9Fg5hu6A';
        const FOLDER_INVENTARIOS = '1SfsGcdSJ1Z7vv9QdAw-K505ZGy4EDs0C';
        const FOLDER_RECEPCIONES = '1D167fOyyRMwBUFuM63_6HD3ObdlRAO63';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        
        let googleToken = null;
        let tokenClient = null;

        // ============================================
        // CONFIGURACI√ìN
        // ============================================

        const CATEGORIES = ["Aperitivo", "Aderezos y Condimentos", "Bar y Mixolog√≠a", "Gourmet", "Mesa y Cocina", "Momentos Dulces", "Regalos", "T√© y Caf√©", "Otros"];

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let mainView = 'catalog'; 
        let stockMode = 'count'; 
        let currentCategory = 'Todos';
        let selectedDateKey = "";
        let searchTerm = '';
        let searchSuggestions = [];
let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let currentBrand = 'Todas';
let filterExpanded = null; // 'category' | 'brand' | null
        
        let dataCount = {};
        let dataReception = {};
        let dataSuggestion = {};
        let currentDocNumber = "";
        
        var swipeStartX = 0;
        var swipeCurrentX = 0;
        let activeDetailSku = null;
        let shareTypeTemp = '';

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            initDate();
            loadAllData();
            switchMainView('catalog'); 
            setupSearch();
            setupOverlaySwipe();
            window.addEventListener('scroll', handleScroll);
            
            // Inicializar Google API despu√©s de que cargue
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    initGoogleAPI();
                }
            }, 1000);
        });

        function initDate() {
            const dateInput = document.getElementById('dateInput');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            selectedDateKey = today;
            updateDateDisplay(today);
            dateInput.addEventListener('change', (e) => {
                selectedDateKey = e.target.value;
                updateDateDisplay(selectedDateKey);
                loadAllData();
                renderProducts();
            });
        }

        function updateDateDisplay(dateStr) {
            const parts = dateStr.split('-');
            const el = document.querySelector('.header-date span');
            if (el) el.textContent = `${parts[2]}/${parts[1]}`;
        }
        function openDate() { document.getElementById('dateInput').showPicker(); }

        // ============================================
        // DATA MANAGER
        // ============================================
        function loadAllData() {
            try {
                dataCount = JSON.parse(localStorage.getItem(`inv_count_${selectedDateKey}`)) || {};
                dataReception = JSON.parse(localStorage.getItem(`inv_recep_${selectedDateKey}`)) || {};
                dataSuggestion = JSON.parse(localStorage.getItem(`inv_sugg_${selectedDateKey}`)) || {};
                const savedDoc = localStorage.getItem(`inv_recep_doc_${selectedDateKey}`);
                if(savedDoc) currentDocNumber = savedDoc;
                
                // Cargar estados de marcas por vista
                window.brandStatusInventory = JSON.parse(localStorage.getItem(`brand_status_inv_${selectedDateKey}`)) || {};
                window.brandStatusReception = JSON.parse(localStorage.getItem(`brand_status_recep_${selectedDateKey}`)) || {};
            } catch (e) {
                dataCount = {}; dataReception = {}; dataSuggestion = {};
                window.brandStatusInventory = {};
                window.brandStatusReception = {};
            }
        }

        function saveData() {
            localStorage.setItem(`inv_count_${selectedDateKey}`, JSON.stringify(dataCount));
            localStorage.setItem(`inv_recep_${selectedDateKey}`, JSON.stringify(dataReception));
            localStorage.setItem(`inv_sugg_${selectedDateKey}`, JSON.stringify(dataSuggestion));
            if(stockMode === 'reception') localStorage.setItem(`inv_recep_doc_${selectedDateKey}`, currentDocNumber);
            
            // Guardar estados de marcas por vista
            if (window.brandStatusInventory) localStorage.setItem(`brand_status_inv_${selectedDateKey}`, JSON.stringify(window.brandStatusInventory));
            if (window.brandStatusReception) localStorage.setItem(`brand_status_recep_${selectedDateKey}`, JSON.stringify(window.brandStatusReception));
        }

        function updateInventoryDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const dateDisplay = document.getElementById('dateDisplay');
            if (dateDisplay) {
                dateDisplay.textContent = `${day}/${month}/${year}`;
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
       function switchMainView(view) {
    mainView = view;
    filterExpanded = null;
    // Solo resetear brand si no estamos cargando del historial
    if (mainView !== 'history') {
        currentBrand = 'Todas';
    }
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${view}`).classList.add('active');
    
    const prodView = document.getElementById('view-products');
    const histView = document.getElementById('view-history');
    const headerActions = document.getElementById('headerActions');
    
    // Actualizar header seg√∫n la vista
    if (view === 'inventory') {
        headerActions.innerHTML = `
            <div class="header-control" id="dateDisplay" style="background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 6px; font-size: 13px;">
                26/01
            </div>
            <button class="header-icon-btn" onclick="confirmarReiniciarInventario()" title="Limpiar Conteo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="document.getElementById('importInventoryExcel').click()" title="Importar Excel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
        `;
        updateInventoryDate();
    } else if (view === 'reception') {
        headerActions.innerHTML = `
            <div class="header-control">
                <input type="text" id="guideNumber" placeholder="N¬∞" style="background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 8px; border-radius: 6px; font-size: 12px; width: 55px; text-align: center;" onchange="saveData()">
            </div>
            <button class="header-icon-btn" onclick="confirmarReiniciar()" title="Limpiar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="document.getElementById('importGuidaPDF').click()" title="Cargar Gu√≠a (PDF/Imagen)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="document.getElementById('importGuiaExcel').click()" title="Cargar Gu√≠a Excel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
        `;
    } else if (view === 'catalog') {
        headerActions.innerHTML = `
            <button class="header-icon-btn" onclick="sincronizarCatalogoDesdeSheets()" title="Sincronizar con Google">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="mostrarModalAgregarProducto()" title="Agregar Producto">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="exportarCatalogo()" title="Exportar Cat√°logo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4" />
                </svg>
            </button>
            <button class="header-icon-btn" onclick="document.getElementById('importCatalogo').click()" title="Importar Cat√°logo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4" />
                </svg>
            </button>
        `;
    } else if (view === 'history') {
        headerActions.innerHTML = '';
    }
    
    if (view === 'history') {
        prodView.style.display = 'none';
        histView.style.display = 'block';
        document.body.style.paddingTop = '0px';
        document.getElementById('toolbarMenu').innerHTML = '';
        document.getElementById('stickyControls').style.display = 'none';
        renderHistory();
    } else {
        prodView.style.display = 'block';
        histView.style.display = 'none';
        document.body.style.paddingTop = '200px';
        document.getElementById('stickyControls').style.display = 'flex';
        renderBrandFilters(document.getElementById('toolbarMenu'));
    }

    if (view === 'inventory') {
        stockMode = 'count';
    } else if (view === 'reception') {
        stockMode = 'reception';
    } else if (view === 'catalog') {
        stockMode = null;
    }
    
    renderProducts();
    window.scrollTo(0,0);
}
        // ============================================
// FILTROS EXPANDIBLES
// ============================================
function toggleFilter(type) {
    if (filterExpanded === type) {
        filterExpanded = null;
    } else {
        filterExpanded = type;
    }
    renderFilters();
}

function selectFilterOption(type, value) {
    if (type === 'category') {
        currentCategory = value;
    } else if (type === 'brand') {
        currentBrand = value;
    }
    renderFilters();
    renderProducts();
}
function renderFilters() {
    const togglesContainer = document.getElementById('filterToggles');
    const optionsContainer = document.getElementById('filterOptions');
    
    if (!togglesContainer || !optionsContainer) return;
    
    // üî• OCULTAR FILTROS SI NO ESTAMOS EN CAT√ÅLOGO
    if (mainView !== 'catalog') {
        togglesContainer.innerHTML = '';
        optionsContainer.innerHTML = '';
        return;
    }
    
    // BOTONES TOGGLE
    const categoryLabel = currentCategory !== 'Todos' ? currentCategory : '';
    const brandLabel = currentBrand !== 'Todas' ? currentBrand : '';
    
    togglesContainer.innerHTML = `
        <div class="filter-toggle-container">
            <div class="filter-toggle ${filterExpanded === 'category' ? 'expanded active' : ''}" onclick="toggleFilter('category')">
                <div class="filter-label">
                    <span>üìë Categor√≠a</span>
                    ${categoryLabel ? `<span class="filter-selected">${categoryLabel}</span>` : ''}
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            
            <div class="filter-toggle ${filterExpanded === 'brand' ? 'expanded active' : ''}" onclick="toggleFilter('brand')">
                <div class="filter-label">
                    <span>üè∑Ô∏è Marca</span>
                    ${brandLabel ? `<span class="filter-selected">${brandLabel}</span>` : ''}
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
    `;
    
    // OPCIONES
    if (filterExpanded === 'category') {
        const categories = ['Todos', ...CATEGORIES];
        optionsContainer.innerHTML = `
            <div class="filter-options expanded">
                <div class="filter-chips">
                    ${categories.map(cat => `
                        <div class="filter-chip ${currentCategory === cat ? 'active' : ''}" 
                             onclick="selectFilterOption('category', '${cat}')">
                            ${cat}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (filterExpanded === 'brand') {
        const brands = ['Todas', ...Array.from(new Set(rawProducts.map(p => p.brand).filter(Boolean))).sort()];
        optionsContainer.innerHTML = `
            <div class="filter-options expanded">
                <div class="filter-chips">
                    ${brands.map(brand => `
                        <div class="filter-chip ${currentBrand === brand ? 'active' : ''}" 
                             onclick="selectFilterOption('brand', '${brand}')">
                            ${brand}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        optionsContainer.innerHTML = '';
    }
}

        function renderCategories(container) {
            const cats = ['Todos', ...CATEGORIES];
            container.innerHTML = cats.map(cat => `
                <div class="menu-chip ${currentCategory === cat ? 'active' : ''}" 
                     onclick="selectCategory('${cat}')">${cat}</div>
            `).join('');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            switchMainView('catalog');
        }

        function renderStockTools(container) {
            const modes = [
                {id: 'date', label: 'Fecha', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />'},
                {id: 'count', label: 'Conteo', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />'},
                {id: 'reception', label: 'Recepci√≥n', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />'},
                {id: 'suggestion', label: 'Sugerido', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />'},
                {id: 'import', label: 'Importar', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />'}
            ];

            container.innerHTML = modes.map(m => {
                let activeClass = '';
                if(stockMode === m.id) {
                    if(m.id === 'count') activeClass = 'count-active';
                    else if(m.id === 'reception') activeClass = 'recep-active';
                    else if(m.id === 'suggestion') activeClass = 'sugg-active';
                }

                let onclick = `setStockMode('${m.id}')`;
                if(m.id === 'date') onclick = `openDate()`;
                if(m.id === 'import') onclick = `document.getElementById('fileImport').click()`;

                return `
                <div class="menu-chip ${activeClass}" onclick="${onclick}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">${m.icon}</svg>
                    ${m.label}
                </div>`;
            }).join('');
            
            if (stockMode === 'reception') {
                container.innerHTML += `
                <div class="menu-chip" onclick="triggerCamera()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Escanear Gu√≠a
                </div>
                <div class="menu-chip" onclick="document.getElementById('importExcelInput').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    Importar Excel
                </div>`;
            }
        }

        function setStockMode(mode) {
            stockMode = mode;
            switchMainView('stock');
        }

        function renderBrandFilters(container) {
            if (mainView === 'history') {
                container.innerHTML = '';
                return;
            }

            // Inicializar status por vista
            if (mainView === 'inventory' && !window.brandStatusInventory) window.brandStatusInventory = {};
            if (mainView === 'reception' && !window.brandStatusReception) window.brandStatusReception = {};
            
            const brands = ['Todas', ...Array.from(new Set(rawProducts.map(p => p.brand).filter(Boolean))).sort()];
            
            // Usar el objeto de estado correcto seg√∫n la vista
            let statusObj = null;
            if (mainView === 'inventory') statusObj = window.brandStatusInventory;
            else if (mainView === 'reception') statusObj = window.brandStatusReception;
            
            let html = '';
            
            brands.forEach(brand => {
                const isActive = currentBrand === brand;
                // Solo mostrar marcas completadas en Inventario y Recepci√≥n, NUNCA en Cat√°logo
                const isCompleted = brand !== 'Todas' && statusObj && statusObj[brand] && (mainView === 'inventory' || mainView === 'reception');
                
                let chipClass = isActive ? 'active' : '';
                if (isCompleted) chipClass += ' completed';
                
                html += `<div class="menu-chip ${chipClass}" onclick="selectBrand('${brand.replace(/'/g, "\\'")}')">${brand}</div>`;
            });
            
            // Mostrar bot√≥n Finalizar solo si est√° en una marca espec√≠fica (no "Todas") en Inventario o Recepci√≥n
            if (currentBrand !== 'Todas' && (mainView === 'inventory' || mainView === 'reception')) {
                html += `<button class="btn-finalizar-marca" onclick="finalizarMarca('${currentBrand.replace(/'/g, "\\'")}')"}>Finalizar ${currentBrand}</button>`;
            }
            
            container.innerHTML = html;
        }

        function selectBrand(brand) {
            currentBrand = brand;
            renderProducts();
            renderBrandFilters(document.getElementById('toolbarMenu'));
        }

        function finalizarMarca(brand) {
            let statusObj = null;
            
            if (mainView === 'inventory') {
                if (!window.brandStatusInventory) window.brandStatusInventory = {};
                statusObj = window.brandStatusInventory;
            } else if (mainView === 'reception') {
                if (!window.brandStatusReception) window.brandStatusReception = {};
                statusObj = window.brandStatusReception;
            }
            
            if (statusObj) {
                statusObj[brand] = true;
                saveData();
            }
            
            showToast(`‚úì ${brand} completada`);
            
            // Ir a la siguiente marca sin completar
            const brands = ['Todas', ...Array.from(new Set(rawProducts.map(p => p.brand).filter(Boolean))).sort()];
            const currentIndex = brands.indexOf(brand);
            
            let nextBrand = null;
            for (let i = currentIndex + 1; i < brands.length; i++) {
                if (!statusObj[brands[i]]) {
                    nextBrand = brands[i];
                    break;
                }
            }
            
            if (!nextBrand) {
                for (let i = 1; i < currentIndex; i++) {
                    if (!statusObj[brands[i]]) {
                        nextBrand = brands[i];
                        break;
                    }
                }
            }
            
            if (nextBrand) {
                selectBrand(nextBrand);
            } else {
                selectBrand('Todas');
                renderBrandFilters(document.getElementById('toolbarMenu'));
            }
        }

  // ============================================
// ESCANEO EN 2 PASOS: GU√çA ‚Üí PRODUCTOS
// ============================================
let escaneoActual = {
    paso: 1, // 1 = N√∫mero de gu√≠a, 2 = Productos
    numeroGuia: '',
    productosDetectados: []
};

function mostrarInstruccionEscaneo() {
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    const paso = escaneoActual.paso;
    
    if (paso === 1) {
        modalContent.innerHTML = `
            <div style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 48px; margin-bottom: 15px; animation: pulse 2s infinite;">üìã</div>
                <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">Ayudemos a la IA a leer mejor</h3>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 25px; line-height: 1.6;">
                    Primero, enfoca <strong>solo el n√∫mero de la gu√≠a</strong> para detectarlo correctamente
                </p>
                
                <div style="background: #fffbf0; border: 2px dashed #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="font-size: 14px; color: #92400e; font-weight: 600; margin-bottom: 8px;">üì∏ PASO 1 de 2</div>
                    <div style="font-size: 13px; color: #78350f;">Acerca el tel√©fono al <strong>n√∫mero de gu√≠a</strong></div>
                </div>
                
                <button class="btn-cta" onclick="abrirCamaraPaso1()" style="width: 100%;">
                    üì∑ Escanear N√∫mero de Gu√≠a
                </button>
                <button class="btn-cta secondary" onclick="closeShareModal()" style="width: 100%; margin-top: 10px;">
                    Cancelar
                </button>
            </div>
            
            <style>
                @keyframes pulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.1); opacity: 0.8; }
                }
            </style>
        `;
    } else {
        modalContent.innerHTML = `
            <div style="text-align: center; padding: 30px 20px;">
                <div style="font-size: 48px; margin-bottom: 15px; animation: pulse 2s infinite;">üì¶</div>
                <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">¬°Perfecto!</h3>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 15px; line-height: 1.6;">
                    Gu√≠a detectada: <strong style="color: #059669;">${escaneoActual.numeroGuia}</strong>
                </p>
                <p style="font-size: 15px; color: #64748b; margin-bottom: 25px; line-height: 1.6;">
                    Ahora, enfoca la <strong>lista de productos completa</strong> (c√≥digos, nombres y cantidades)
                </p>
                
                <div style="background: #f0fdf4; border: 2px dashed #059669; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 8px;">üì∏ PASO 2 de 2</div>
                    <div style="font-size: 13px; color: #15803d;">Muestra todos los productos de la gu√≠a</div>
                </div>
                
                <button class="btn-cta" onclick="abrirCamaraPaso2()" style="width: 100%;">
                    üì∑ Escanear Productos
                </button>
                <button class="btn-cta secondary" onclick="closeShareModal()" style="width: 100%; margin-top: 10px;">
                    Cancelar
                </button>
            </div>
            
            <style>
                @keyframes pulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.1); opacity: 0.8; }
                }
            </style>
        `;
    }
    
    modal.classList.add('active');
}

function confirmarReiniciar() {
    const viewProducts = document.getElementById('view-products');
    const viewHistory = document.getElementById('view-history');
    
    // Si estamos en historial, no permitir
    if (viewHistory && viewHistory.style.display !== 'none') {
        alert('‚ö†Ô∏è No se puede reiniciar desde el Historial');
        return;
    }
    
    if (confirm('¬øReiniciar la recepci√≥n actual?\n\nEsto borrar√° todos los datos ingresados.')) {
        // Limpiar datos de recepci√≥n
        dataReception = {};
        currentDocNumber = '';
        window.productosGuiaActual = null;
        window.cantidadesEsperadas = null;
        
        const guideInput = document.getElementById('guideNumber');
        if (guideInput) guideInput.value = '';
        
        // Reiniciar UI
        renderProducts();
        saveData();
        
        showToast('‚úÖ Recepci√≥n reiniciada');
    }
}

function confirmarReiniciarInventario() {
    if (confirm('¬øReiniciar el conteo de inventario?\n\nEsto borrar√° todos los datos ingresados.')) {
        // Limpiar datos de inventario
        dataCount = {};
        
        // Reiniciar UI
        renderProducts();
        saveData();
        
        showToast('‚úÖ Inventario reiniciado');
    }
}

function abrirCamaraPaso1() {
    closeShareModal();
    document.getElementById('scanInput').click();
}

function abrirCamaraPaso2() {
    closeShareModal();
    document.getElementById('scanInput').click();
}

// ============================================
// MODIFICAR handleScan PARA 2 PASOS
// ============================================
async function handleScan(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    
    if (file.size > 10 * 1024 * 1024) {
        showToast("‚ö†Ô∏è Imagen muy grande. M√°ximo 10MB.");
        return;
    }
    
    showToast("üì∏ Procesando gu√≠a...");
    
    try {
        const compressedImage = await compressImage(file);
        showToast("ü§ñ Extrayendo informaci√≥n con AI...");
        
        const response = await fetch('/.netlify/functions/process-guia', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: compressedImage })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Error procesando imagen');
        }
        
        showToast("üîç Analizando datos...");
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'No se pudo procesar la imagen');
        }
        
        if (data.productos && data.productos.length > 0) {
            showToast(`‚úÖ ${data.productos.length} productos detectados`);
            
            // Aplicar directamente a dataReception
            currentDocNumber = data.numeroFactura;
            const docInput = document.getElementById('docNumberInput');
            if (docInput) docInput.value = data.numeroFactura;
            
            let productosImportados = 0;
            let productosNoEncontrados = [];
            
            data.productos.forEach(prod => {
                const productoExiste = rawProducts.find(p => p.sku === prod.codigo);
                
                if (productoExiste) {
                    dataReception[prod.codigo] = prod.cantidad;
                    productosImportados++;
                } else {
                    productosNoEncontrados.push(prod.codigo);
                }
            });
            
            saveData();
            renderProducts();
            mostrarResumenGuia(data, productosImportados, productosNoEncontrados);
            
        } else {
            showToast("‚ùå No se detectaron productos. Intenta de nuevo.");
        }
        
    } catch (error) {
        console.error('Error:', error);
        showToast("‚ùå Error: " + error.message);
    } finally {
        // üëà AGREGAR ESTO: Limpiar el input para permitir seleccionar la misma imagen otra vez
        input.value = '';
    }
}
function procesarGuiaCompleta(dataIA) {
    // 1. Validar que recibimos datos
    if (!dataIA || !dataIA.success) {
        alert("No hay datos v√°lidos para procesar.");
        return;
    }

    // 2. Actualizar el n√∫mero de gu√≠a/factura en tu sistema
    currentDocNumber = dataIA.numeroGuia;
    const docInput = document.getElementById('docNumberInput');
    if (docInput) docInput.value = dataIA.numeroGuia;

    console.log(`Procesando Factura: ${dataIA.numeroGuia} del ${dataIA.fecha}`);

    // 3. Recorrer los productos detectados por la IA
    dataIA.productos.forEach(prodScanner => {
        // A. SUMAR AL STOCK REAL (En tu lista maestra 'products')
        const productoMaestro = products.find(p => p.sku === prodScanner.sku);
        
        if (productoMaestro) {
            const stockActual = parseInt(productoMaestro.units) || 0;
            productoMaestro.units = stockActual + prodScanner.unidades;
            
            // B. REGISTRAR EN LA RECEPCI√ìN (Para que aparezca en el conteo actual)
            // Usamos += para que si el producto ya estaba, se sume lo nuevo
            dataReception[prodScanner.sku] = (dataReception[prodScanner.sku] || 0) + prodScanner.unidades;
        } else {
            console.warn(`El SKU ${prodScanner.sku} no existe en el inventario maestro.`);
        }
    });

    // 4. Guardar cambios y refrescar la pantalla
    // Uso tus funciones originales: saveData y renderProducts
    if (typeof saveData === 'function') saveData();
    if (typeof renderProducts === 'function') renderProducts();

    // 5. Notificar √©xito
    alert(`‚úÖ Factura ${dataIA.numeroGuia} procesada.\nSe sumaron ${dataIA.productos.length} productos al stock actual.`);
}
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        
                        const MAX_WIDTH = 1200;
                        const MAX_HEIGHT = 1600;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        console.log('üì∏ Original:', (file.size / 1024).toFixed(0), 'KB');
                        console.log('‚ö° Comprimida:', (compressedBase64.length * 0.75 / 1024).toFixed(0), 'KB');
                        
                        resolve(compressedBase64);
                    };
                    
                    img.onerror = () => reject(new Error('Error al cargar imagen'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('Error al leer archivo'));
                reader.readAsDataURL(file);
            });
        }

        function procesarGuiaOCR(data) {
            if (data.numeroGuia) {
                currentDocNumber = data.numeroGuia;
                const docInput = document.getElementById('docNumberInput');
                if (docInput) docInput.value = data.numeroGuia;
            }
            
            if (data.productos && data.productos.length > 0) {
                let productosImportados = 0;
                let productosNoEncontrados = [];
                
                data.productos.forEach(prod => {
                    const productoExiste = rawProducts.find(p => p.sku === prod.codigo);
                    
                    if (productoExiste) {
                        dataReception[prod.codigo] = prod.cantidad;
                        productosImportados++;
                    } else {
                        productosNoEncontrados.push(prod.codigo);
                    }
                });
                
                saveData();
                renderProducts();
                mostrarResumenGuia(data, productosImportados, productosNoEncontrados);
                
            } else {
                showToast("‚ö†Ô∏è No se detectaron productos en la gu√≠a");
            }
        }

function mostrarResumenGuia(data, importados, noEncontrados) {
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    const totalUnidades = data.totalUnidades || data.productos.reduce((sum, p) => sum + p.cantidad, 0);
    
    let html = `
        <div style="text-align: center; padding: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
            <h3 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 5px;">Gu√≠a Kitchen Center Escaneada</h3>
            <div style="font-size: 32px; font-weight: 800; color: #4a0404; letter-spacing: 2px; margin-bottom: 10px;">#${data.numeroFactura || 'N/A'}</div>
            ${data.folio ? `<div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">Folio: ${data.folio}</div>` : ''}
            ${data.fechaFactura ? `<div style="font-size: 13px; color: #64748b;">Fecha: ${data.fechaFactura}</div>` : ''}
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
            ${data.tienda ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0;">
                <span style="color: #64748b; font-size: 13px;">Tienda:</span>
                <span style="font-weight: 600; color: #1e293b; font-size: 12px; text-align: right; max-width: 60%;">${data.tienda}</span>
            </div>
            ` : ''}
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #64748b; font-size: 14px;">Productos detectados</span>
                <span style="font-size: 24px; font-weight: 700; color: #059669;">${importados}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Total unidades</span>
                <span style="font-size: 24px; font-weight: 700; color: #1e293b;">${totalUnidades}</span>
            </div>
        </div>
        
        ${noEncontrados.length > 0 ? `
        <div style="background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
            <div style="font-weight: 700; color: #991b1b; margin-bottom: 8px;">‚ö†Ô∏è Productos no encontrados en cat√°logo:</div>
            ${noEncontrados.slice(0, 5).map(sku => `
                <div style="font-size: 12px; color: #7f1d1d;">‚Ä¢ SKU ${sku}</div>
            `).join('')}
            ${noEncontrados.length > 5 ? `<div style="font-size: 12px; color: #7f1d1d;">... y ${noEncontrados.length - 5} m√°s</div>` : ''}
        </div>
        ` : ''}
        
        <button class="btn-cta" onclick="iniciarRecepcionGuia()" style="width: 100%;">
            üìã Iniciar Recepci√≥n ‚Üí
        </button>
    `;
    
    // Guardar datos en variable global
    window.tempRecepcionData = {
        productos: data.productos,
        numeroGuia: data.numeroFactura,
        numeroFactura: data.numeroFactura,
        fechaFactura: data.fechaFactura,
        fechaOrden: data.fechaOrden,
        folio: data.folio,
        tienda: data.tienda
    };
    
    modalContent.innerHTML = html;
    modal.classList.add('active');
}
        // ============================================
        // RENDER PRODUCTS
        // ============================================
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const ctaContainer = document.getElementById('ctaContainer');
            const docContainer = document.getElementById('docInputContainer');
            
            if(!container) return;

            ctaContainer.innerHTML = ''; 
            docContainer.innerHTML = '';

            let filtered = rawProducts.filter(p => {
                // Si hay t√©rmino de b√∫squeda
                if (searchTerm) {
                    const term = searchTerm;
                    const matchesName = p.name.toLowerCase().includes(term);
                    const matchesSku = p.sku.includes(term);
                    const matchesBrand = p.brand.toLowerCase().includes(term);
                    const matchesOrigin = p.origin ? p.origin.toLowerCase().includes(term) : false;
                    
                    // Si busca por SKU exacto o parcial, ignorar filtro de marca (b√∫squeda global)
                    if (matchesSku) {
                        return true; // Encontrado por SKU, mostrar sin importar marca
                    }
                    
                    if (!matchesName && !matchesBrand && !matchesOrigin) return false;
                }
                
if (mainView === 'catalog') {
    // Filtro por categor√≠a
    if (currentCategory !== 'Todos') {
        if (currentCategory === 'Otros') {
            if (p.category) return false;
        } else {
            if (p.category !== currentCategory) return false;
        }
    }
}

// Filtro por marca en todas las vistas (solo si no hay b√∫squeda activa)
if (currentBrand !== 'Todas' && !searchTerm) {
    if (p.brand !== currentBrand) return false;
}
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No se encontraron productos</div>';
                return;
            }

            if (mainView === 'reception' && stockMode === 'reception') {
                // N¬∞ Gu√≠a est√° en el header, no lo mostramos aqu√≠
            }

            if (mainView === 'inventory' || mainView === 'reception') {
                // Mostrar bot√≥n Finalizar marca cuando se ve una marca espec√≠fica
                if (currentBrand !== 'Todas') {
                    ctaContainer.innerHTML = `
                        <button class="btn-cta" onclick="finalizarMarca('${currentBrand.replace(/'/g, "\\'")}')"}>
                            Finalizar ${currentBrand}
                        </button>
                    `;
                }
                // Mostrar bot√≥n Finalizar Todo si estamos en "Todas"
                else if (currentBrand === 'Todas') {
                    if (mainView === 'inventory') { 
                        ctaContainer.innerHTML = `
                            <button class="btn-cta" onclick="abrirModalFirmaConteo()">
                                Finalizar Conteo
                            </button>
                        `;
                    }
                    if (mainView === 'reception') { 
                        ctaContainer.innerHTML = `
                            <button class="btn-cta" onclick="abrirModalFirmaRecepcion()">
                                Finalizar Recepci√≥n
                            </button>
                        `;
                    }
                }
            }

            container.innerHTML = filtered.map(p => {
                const qtyCount = dataCount[p.sku] || 0;
                const qtyRecep = dataReception[p.sku] || 0;
                const qtySugg = dataSuggestion[p.sku] || 0;

                let controls = '';
                let borderClass = '';
                let displayVal = 0;

                if (mainView === 'inventory' || mainView === 'reception') {
                    let currentModeClass = '';
                    if (mainView === 'inventory') {
                        displayVal = qtyCount;
                        currentModeClass = 'count-mode';
                        if(qtyCount > 0) borderClass = 'counted';
                    } else if (mainView === 'reception') {
                        displayVal = qtyRecep;
                        currentModeClass = 'reception-mode';
                        if(qtyRecep > 0) borderClass = 'reception-counted';
                    }

                    controls = `
                        <div class="stock-control ${currentModeClass}" onclick="event.stopPropagation()">
                            <button class="btn-stock" onclick="modifyStock('${p.sku}', -1)">-</button>
                            <input class="stock-input" value="${displayVal}" readonly>
                            <button class="btn-stock" onclick="modifyStock('${p.sku}', 1)">+</button>
                        </div>
                    `;
                } else {
                    // Cat√°logo: sin controles ni contador
                    controls = '';
                }

                return `
                    <div class="product-card ${borderClass}" onclick="${mainView === 'catalog' ? `openDetail('${p.sku}')` : ''}">
                        <div class="product-info">
                            <h4>${p.name}</h4>
                            <div class="product-sku">SKU: ${p.sku}</div>
                        </div>
                        ${controls}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // LOGIC
        // ============================================
        function updateDocNumber(val) {
            currentDocNumber = val;
            saveData();
        }

        function modifyStock(sku, delta) {
            let db;
            if (mainView === 'inventory') db = dataCount;
            else if (mainView === 'reception') db = dataReception;
            
            if (!db) return;
            
            const current = db[sku] || 0;
            const newVal = Math.max(0, current + delta);
            db[sku] = newVal;
            
            saveData();
            renderProducts(); 
        }

        // ============================================
        // SHARE MODAL & EXPORT
        // ============================================
        
        function abrirModalFirmaConteo() {
            abrirModalFirma('Inventario');
        }
        
        function abrirModalFirmaRecepcion() {
            // Verificar que hay productos contados
            const productosContados = Object.keys(dataReception).filter(sku => dataReception[sku] > 0);
            
            if (productosContados.length === 0) {
                showToast('‚ö†Ô∏è No hay productos contados para finalizar');
                return;
            }
            
            // Si no hay n√∫mero de gu√≠a, usar fecha/hora
            if (!currentDocNumber) {
                currentDocNumber = new Date().toISOString().slice(0,10).replace(/-/g,'');
            }
            
            abrirModalFirma(`Recepci√≥n #${currentDocNumber}`);
        }
        
function abrirModalFirma(tipo) {
    const modal = document.getElementById('firmaModal');
    const modalContent = document.getElementById('firmaModalContent');
    
    modal.querySelector('.modal-title').textContent = `Finalizar ${tipo}`;
    
    let html = `
        <button onclick="cerrarFirmaModal()" style="position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: #f1f5f9; border: none; font-size: 16px; color: #64748b; cursor: pointer;">‚úï</button>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Nombre:</label>
                    <input type="text" id="inputNombre" placeholder="Ej: Juan P√©rez" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-family: 'Inter', sans-serif;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 500;">Firma:</label>
                    <canvas id="canvasFirma" style="width: 100%; height: 120px; border: 2px dashed #e2e8f0; border-radius: 8px; background: white; cursor: crosshair; display: block;"></canvas>
                    <button onclick="limpiarFirma()" style="width: 100%; margin-top: 8px; padding: 8px; border: none; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b; cursor: pointer; font-weight: 500;">
                        üîÑ Limpiar
                    </button>
                </div>
                
                <div class="modal-actions">
                    <button onclick="guardarConFirma('${tipo}')" class="btn-cta" style="width: 100%;">
                        Guardar
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
            
            setTimeout(inicializarCanvasFirma, 500);
        }
        
        function cerrarFirmaModal() {
            document.getElementById('firmaModal').classList.remove('active');
        }
        
        function inicializarCanvasFirma() {
            console.log('üîÑ Intentando inicializar canvas...');
            
            const canvas = document.getElementById('canvasFirma');
            
            if (!canvas) {
                console.error('‚ùå Canvas element no existe en el DOM');
                console.log('üìã Retentando en 200ms...');
                setTimeout(inicializarCanvasFirma, 200);
                return;
            }
            
            console.log('‚úÖ Canvas encontrado');
            
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('‚ùå No se pudo obtener contexto 2D');
                    return;
                }
                
                canvas.width = canvas.offsetWidth;
                canvas.height = 120;
                
                console.log(`üìê Canvas dimensiones: ${canvas.width}x${canvas.height}`);
                
                let dibujando = false;
                
                const inicio = (e) => {
                    dibujando = true;
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                };
                
                const dibujo = (e) => {
                    if (!dibujando) return;
                    e.preventDefault?.();
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = '#1e293b';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.stroke();
                };
                
                const fin = () => {
                    dibujando = false;
                };
                
                canvas.addEventListener('mousedown', inicio, false);
                canvas.addEventListener('mousemove', dibujo, false);
                canvas.addEventListener('mouseup', fin, false);
                canvas.addEventListener('mouseout', fin, false);
                canvas.addEventListener('touchstart', inicio, false);
                canvas.addEventListener('touchmove', dibujo, false);
                canvas.addEventListener('touchend', fin, false);
                
                console.log('‚úÖ Canvas completamente inicializado y funcional');
                
            } catch (e) {
                console.error('‚ùå Error al inicializar:', e.message);
            }
        }
        
        function limpiarFirma() {
            const canvas = document.getElementById('canvasFirma');
            if (!canvas) {
                return;
            }
            try {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } catch (e) {
                console.log('No se pudo limpiar canvas');
            }
        }
        
        function guardarConFirma(tipo) {
            const nombre = document.getElementById('inputNombre').value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirma');
            
            if (!canvas) {
                showToast('‚ùå Error: Canvas no encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some(channel => channel !== 0);
            
            if (!hasDrawing) {
                showToast('‚ö†Ô∏è Por favor dibuje su firma');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            guardarConteoConFirma(tipo, nombre, firmaDataURL);
        }
        
        let conteoActualGuardado = null;
        let conteoTemporal = null;
        
        function guardarConteoConFirma(tipo, nombre, firmaDataURL) {
            const hoy = new Date().toISOString().split('T')[0];
            const id = `${tipo}_${hoy}_${Date.now()}`;
            
            // Determinar qu√© datos guardar seg√∫n el tipo
            let datosAGuardar = dataCount;
            if (tipo.includes('Recepci√≥n')) {
                datosAGuardar = dataReception;
            }
            
            const conteo = {
                id: id,
                tipo: tipo,
                fecha: hoy,
                nombre: nombre,
                firma: firmaDataURL,
                datos: {...datosAGuardar},
                numeroGuia: currentDocNumber || '',
                timestamp: new Date().getTime()
            };
            
            // Si es recepci√≥n, preguntar si agregar al inventario anterior
            if (tipo.includes('Recepci√≥n')) {
                mostrarOpcionesRecepcion(conteo);
            } else {
                // Si es inventario, guardar directamente
                guardarEnHistorial(conteo);
            }
        }
        
        function mostrarOpcionesRecepcion(conteo) {
            // CORRECCI√ìN: Guardar el conteo temporalmente Y en historial
            conteoTemporal = conteo;
            
            // Guardar inmediatamente en historial
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            if (!historial.some(h => h.id === conteo.id)) {
                historial.unshift(conteo);
                localStorage.setItem('historial_conteos', JSON.stringify(historial));
            }
            
            const modal = document.getElementById('firmaModal');
            const modalContent = document.getElementById('firmaModalContent');
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 24px; color: #059669; margin-bottom: 10px;">‚úÖ</div>
                    <div style="font-size: 18px; font-weight: 600; color: #1e293b;">Recepci√≥n guardada</div>
                    <div style="font-size: 14px; color: #64748b; margin-top: 5px;">¬øQu√© deseas hacer?</div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-direction: column;">
                    <button onclick="guardarRecepcionYAgregarAlInventario('${conteo.id}')" 
                            class="btn-cta" style="width: 100%; background: #059669;">
                        ‚ûï Agregar al √∫ltimo inventario
                    </button>
                    <button onclick="guardarRecepcionComoNuevo('${conteo.id}')" 
                            class="btn-cta" style="width: 100%;">
                        üìã Crear inventario nuevo
                    </button>
                    <button onclick="soloGuardarRecepcion()" style="width: 100%; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        ‚úï Solo guardar recepci√≥n
                    </button>
                </div>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Finalizar Recepci√≥n';
            modalContent.innerHTML = html;
        }
        
        function soloGuardarRecepcion() {
            // Ya est√° guardado, solo mostrar confirmaci√≥n y cerrar
            conteoActualGuardado = conteoTemporal;
            showToast('‚úÖ Recepci√≥n guardada');
            mostrarModalExportarConteo();
        }
        
        function guardarRecepcionYAgregarAlInventario(recepcionId) {
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            let recepcion = historial.find(h => h.id === recepcionId);
            
            if (!recepcion) {
                // Fallback: usar el conteo temporal
                if (conteoTemporal && conteoTemporal.id === recepcionId) {
                    recepcion = conteoTemporal;
                    historial.unshift(recepcion);
                    localStorage.setItem('historial_conteos', JSON.stringify(historial));
                } else {
                    showToast('‚ùå Error: No se encontr√≥ la recepci√≥n');
                    return;
                }
            }
            
            // Buscar √∫ltimo inventario
            const ultimoInventario = historial.find(h => h.tipo === 'Inventario');
            
            if (!ultimoInventario) {
                showToast('‚ùå No hay inventario anterior. Creando nuevo inventario...');
                guardarRecepcionComoNuevo(recepcionId);
                return;
            }
            
            // Combinar datos: sumar cantidades de recepci√≥n al inventario
            const datosActualizados = {...ultimoInventario.datos};
            Object.entries(recepcion.datos).forEach(([sku, cantidad]) => {
                datosActualizados[sku] = (datosActualizados[sku] || 0) + cantidad;
            });
            
            // Actualizar el √∫ltimo inventario
            ultimoInventario.datos = datosActualizados;
            ultimoInventario.timestamp = new Date().getTime();
            
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = recepcion;
            showToast('‚úÖ Recepci√≥n agregada al inventario anterior');
            mostrarModalExportarConteo();
        }
        
        function guardarRecepcionComoNuevo(recepcionId) {
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            let recepcion = historial.find(h => h.id === recepcionId);
            
            if (!recepcion) {
                // Fallback: usar el conteo temporal
                if (conteoTemporal && conteoTemporal.id === recepcionId) {
                    recepcion = conteoTemporal;
                    if (!historial.some(h => h.id === recepcionId)) {
                        historial.unshift(recepcion);
                    }
                } else {
                    showToast('‚ùå Error: No se encontr√≥ la recepci√≥n');
                    return;
                }
            }
            
            // Crear nuevo inventario con los datos de la recepci√≥n
            const hoy = new Date().toISOString().split('T')[0];
            const nuevoInventario = {
                id: `Inventario_${hoy}_${Date.now()}`,
                tipo: 'Inventario',
                fecha: hoy,
                nombre: recepcion.nombre,
                firma: recepcion.firma,
                datos: {...recepcion.datos},
                timestamp: new Date().getTime()
            };
            
            historial.unshift(nuevoInventario);
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = recepcion;
            showToast('‚úÖ Recepci√≥n guardada y nuevo inventario creado');
            mostrarModalExportarConteo();
        }
        
        function guardarEnHistorial(conteo) {
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            historial.unshift(conteo);
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = conteo;
            
            showToast('‚úÖ Archivo guardado');
            mostrarModalExportarConteo();
        }
        
        function mostrarModalExportarConteo() {
            const modal = document.getElementById('firmaModal');
            const modalContent = document.getElementById('firmaModalContent');
            
            const tipoConteo = conteoActualGuardado?.tipo || '';
            const esRecepcion = tipoConteo.includes('Recepci√≥n');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 40px; color: #059669; margin-bottom: 10px;">‚úì</div>
                    <div style="font-size: 16px; font-weight: 600; color: #1e293b;">Guardado correctamente</div>
                    <div style="font-size: 13px; color: #64748b; margin-top: 5px;">¬øQu√© deseas hacer?</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button onclick="exportarConteoAPDF()" style="flex: 1; padding: 12px; background: #4a0404; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        PDF
                    </button>
                    <button onclick="exportarConteoAExcel()" style="flex: 1; padding: 12px; background: #4a0404; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        Excel
                    </button>
                </div>
                
                <button onclick="exportarYSubirDrive('${esRecepcion ? 'recepcion' : 'inventario'}')" style="width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px; margin-bottom: 10px;">
                    ‚òÅÔ∏è Subir a Drive
                </button>
                
                <button onclick="cerrarFirmaModal()" style="width: 100%; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    Cerrar
                </button>
            `;
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        async function exportarYSubirDrive(tipo) {
            if (!conteoActualGuardado) {
                showToast('No hay datos para subir');
                return;
            }
            
            const token = googleToken || localStorage.getItem('googleToken');
            if (!token) {
                showToast('Conecta Google primero');
                sincronizarCatalogoDesdeSheets(); // Muestra modal de conectar
                return;
            }
            
            mostrarLoading();
            
            try {
                // Generar Excel
                const XLSX = await cargarLibreriaXLSX();
                const conteo = conteoActualGuardado;
                
                const data = [];
                data.push([tipo === 'recepcion' ? 'RECEPCI√ìN' : 'INVENTARIO']);
                data.push(['Fecha:', conteo.fecha]);
                data.push(['Responsable:', conteo.nombre]);
                if (conteo.numeroGuia) data.push(['Gu√≠a:', conteo.numeroGuia]);
                data.push([]);
                
                if (conteo.productosDetalle && conteo.productosDetalle.length > 0) {
                    data.push(['SKU', 'Descripci√≥n', 'Esperado', 'Recibido', 'Diferencia', 'Estado']);
                    conteo.productosDetalle.forEach(p => {
                        const estado = p.diferencia === 0 ? 'OK' : (p.diferencia < 0 ? 'FALTA' : 'EXTRA');
                        data.push([p.sku, p.descripcion || '', p.esperado, p.recibido, p.diferencia, estado]);
                    });
                } else {
                    data.push(['SKU', 'Producto', 'Cantidad']);
                    rawProducts.forEach(p => {
                        const qty = conteo.datos[p.sku] || 0;
                        if (qty > 0) {
                            data.push([p.sku, p.name, qty]);
                        }
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Datos');
                
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                const fecha = conteo.fecha.replace(/-/g, '');
                const nombreArchivo = tipo === 'recepcion' 
                    ? `Recepcion_${conteo.numeroGuia || fecha}_${fecha}.xlsx`
                    : `Inventario_${fecha}.xlsx`;
                
                const folderId = tipo === 'recepcion' ? FOLDER_RECEPCIONES : FOLDER_INVENTARIOS;
                const resultado = await subirArchivoDrive(blob, nombreArchivo, folderId);
                
                ocultarLoading();
                
                if (resultado) {
                    showToast('Subido a Drive correctamente');
                    cerrarFirmaModal();
                } else {
                    showToast('Error al subir');
                }
                
            } catch (error) {
                console.error('Error:', error);
                ocultarLoading();
                showToast('Error al generar archivo');
            }
        }
        
        
        function generarPDF(tipo) {
            const nombre = document.getElementById('inputNombre').value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirma');
            
            if (!canvas) {
                showToast('‚ùå Dibuje su firma primero');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            guardarConteoConFirma(tipo, nombre, firmaDataURL);
        }
        
        function generarExcel(tipo) {
            const nombre = document.getElementById('inputNombre').value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirma');
            
            if (!canvas) {
                showToast('‚ùå Dibuje su firma primero');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            guardarConteoConFirma(tipo, nombre, firmaDataURL);
        }
        
        function exportarConteoAPDF() {
            if (!conteoActualGuardado) {
                showToast('‚ùå No hay conteo para exportar');
                return;
            }
            generarPDFDelConteo(conteoActualGuardado);
            showToast('‚úÖ PDF descargado');
        }
        
        function exportarConteoAExcel() {
            if (!conteoActualGuardado) {
                showToast('‚ùå No hay conteo para exportar');
                return;
            }
            generarExcelDelConteo(conteoActualGuardado);
            showToast('‚úÖ Excel descargado');
        }
        
        function exportarAmbos() {
            if (!conteoActualGuardado) {
                showToast('‚ùå No hay conteo para exportar');
                return;
            }
            generarPDFDelConteo(conteoActualGuardado);
            setTimeout(() => {
                generarExcelDelConteo(conteoActualGuardado);
                showToast('‚úÖ PDF y Excel descargados');
            }, 500);
        }
        
        function generarPDFDelConteo(conteo) {
            if (!window.jspdf) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    _generarPDFInterno(conteo);
                };
                document.head.appendChild(script);
            } else {
                _generarPDFInterno(conteo);
            }
        }
        
        function _generarPDFInterno(conteo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Header rojo
            doc.setFillColor(74, 4, 4);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('COQUINARIA', 105, 16, { align: 'center' });
            
            // Informaci√≥n
            let y = 35;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            doc.text(`Tipo de documento: ${conteo.tipo}`, 20, y);
            y += 8;
            doc.text(`Fecha: ${conteo.fecha}`, 20, y);
            y += 8;
            doc.text(`Responsable: ${conteo.nombre}`, 20, y);
            y += 12;
            
            // Tabla de productos
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.setFillColor(74, 4, 4);
            doc.setTextColor(255, 255, 255);
            doc.rect(20, y - 5, 170, 7, 'F');
            doc.text('SKU', 22, y);
            doc.text('Producto', 40, y);
            doc.text('Cantidad', 170, y);
            
            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0);
            
            // Productos con cantidad > 0
            let totalProductos = 0;
            Object.entries(conteo.datos).forEach(([sku, cantidad]) => {
                if (cantidad > 0) {
                    const producto = rawProducts.find(p => p.sku === sku);
                    const nombre = producto ? producto.name : `Producto ${sku}`;
                    
                    doc.text(sku, 22, y);
                    doc.text(nombre.substring(0, 50), 40, y);
                    doc.text(cantidad.toString(), 170, y);
                    
                    y += 6;
                    totalProductos++;
                }
            });
            
            // Total
            y += 5;
            doc.setFont('helvetica', 'bold');
            doc.text(`Total de productos: ${totalProductos}`, 20, y);
            
            // Firma
            y += 20;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('Firma:', 20, y);
            
            if (conteo.firma) {
                doc.addImage(conteo.firma, 'PNG', 20, y + 5, 50, 20);
            }
            
            doc.save(`Conteo_${conteo.tipo}_${conteo.fecha}_${conteo.nombre.replace(/\\s+/g, '_')}.pdf`);
        }
        
        function generarExcelDelConteo(conteo) {
            if (!window.ExcelJS) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js';
                script.onload = () => {
                    _generarExcelInterno(conteo);
                };
                document.head.appendChild(script);
            } else {
                _generarExcelInterno(conteo);
            }
        }
        
        function _generarExcelInterno(conteo) {
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Conteo');
            
            // Metadata (filas 1-3)
            worksheet.addRow(['FECHA', conteo.fecha]);
            worksheet.addRow(['TIPO', conteo.tipo]);
            worksheet.addRow(['RESPONSABLE', conteo.nombre]);
            worksheet.addRow([]); // Fila vac√≠a
            
            // Header (fila 5)
            worksheet.columns = [
                { header: 'SKU', key: 'sku', width: 12 },
                { header: 'Producto', key: 'producto', width: 50 },
                { header: 'Cantidad', key: 'cantidad', width: 12 }
            ];
            
            // Estilos header
            const headerRow = worksheet.getRow(5);
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4a0404' } };
            headerRow.font = { color: { argb: 'FFFFFFFF' }, bold: true };
            
            // Datos (desde fila 6)
            let rowNum = 6;
            let totalProductos = 0;
            
            Object.entries(conteo.datos).forEach(([sku, cantidad]) => {
                if (cantidad > 0) {
                    const producto = rawProducts.find(p => p.sku === sku);
                    const nombre = producto ? producto.name : `Producto ${sku}`;
                    
                    worksheet.addRow({
                        sku: sku,
                        producto: nombre,
                        cantidad: cantidad
                    });
                    
                    rowNum++;
                    totalProductos++;
                }
            });
            
            // Total
            worksheet.addRow({ sku: 'TOTAL', cantidad: totalProductos });
            const totalRow = worksheet.getRow(rowNum);
            totalRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf0f0f0' } };
            totalRow.font = { bold: true };
            
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Conteo_${conteo.tipo}_${conteo.fecha}_${conteo.nombre.replace(/\\s+/g, '_')}.xlsx`;
                link.click();
                URL.revokeObjectURL(url);
            });
        }
        
        function openShareModal(type) {
            shareTypeTemp = type;
            document.getElementById('shareModalTitle').textContent = `Compartir ${type}`;
            document.getElementById('shareModal').classList.add('active');
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function executeShare(method) {
            const type = shareTypeTemp;
            closeShareModal();
            
            let db;
            let docInfo = "";
            if (type === 'Conteo') db = dataCount;
            else if (type === 'Recepci√≥n') { 
                db = dataReception; 
                if(currentDocNumber) docInfo = `\n*Documento:* ${currentDocNumber}`;
            }
            else if (type === 'Sugerido') db = dataSuggestion;

            let text = `*Reporte ${type} - ${selectedDateKey}*${docInfo}\n\n`;
            let bodyEmail = `Reporte ${type} - ${selectedDateKey} ${docInfo}%0D%0A%0D%0A`;
            
            let hasItems = false;
            
            rawProducts.forEach(p => {
                const val = db[p.sku] || 0;
                if(val > 0) {
                    text += `- ${p.name}: ${val}\n`;
                    bodyEmail += `- ${p.name}: ${val}%0D%0A`;
                    hasItems = true;
                }
            });

            if (!hasItems) { showToast("No hay items para enviar"); return; }
            
            const hist = JSON.parse(localStorage.getItem('appHistory') || '[]');
            let label = type;
            if (type === 'Recepci√≥n' && currentDocNumber) label += ` #${currentDocNumber}`;
            
            hist.push({ 
                date: selectedDateKey, 
                type: label, 
                timestamp: new Date().toISOString(),
                docNum: currentDocNumber 
            });
            localStorage.setItem('appHistory', JSON.stringify(hist));

            if (method === 'whatsapp') {
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            } else if (method === 'email') {
                window.open(`mailto:?subject=Reporte ${type} ${selectedDateKey}&body=${bodyEmail}`, '_blank');
            }
        }
        
function renderHistory() {
    const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
    const container = document.getElementById('historyContent');
    
    if (historial.length === 0) {
        container.innerHTML = '<div class="empty-state">Sin registros a√∫n</div>';
        return;
    }
    
    const searchInput = document.getElementById('historySearchInput');
    const filterType = document.getElementById('historyFilterType');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    const selectedType = filterType ? filterType.value : '';
    
    let filtrado = historial;
    if (searchTerm || selectedType) {
        filtrado = historial.filter(item => {
            const fecha = item.fecha || '';
            const numeroGuia = item.numeroGuia || '';
            const responsable = item.nombre || '';
            const tipo = item.tipo || '';
            
            const cumpleBusqueda = !searchTerm || 
                   fecha.toLowerCase().includes(searchTerm) || 
                   numeroGuia.toLowerCase().includes(searchTerm) ||
                   responsable.toLowerCase().includes(searchTerm);
            
            const cumpleTipo = !selectedType || tipo.includes(selectedType);
            
            return cumpleBusqueda && cumpleTipo;
        });
    }
    
    if (filtrado.length === 0) {
        container.innerHTML = '<div class="empty-state">No se encontraron registros</div>';
        return;
    }
    
    container.innerHTML = filtrado.map(item => {
        const esRecepcion = item.tipo.includes('Recepci√≥n');
        const titulo = esRecepcion ? `Gu√≠a #${item.numeroGuia || 'S/N'}` : `Inventario`;
        const totalProductos = Object.keys(item.datos || {}).filter(k => item.datos[k] > 0).length;
        const totalUnidades = Object.values(item.datos || {}).reduce((a, b) => a + (b || 0), 0);
        
        return `
            <div class="history-card">
                <div class="history-card-header">
                    <span class="history-card-type ${esRecepcion ? 'recepcion' : 'inventario'}">
                        ${esRecepcion ? 'üì¶ Recepci√≥n' : 'üìã Inventario'}
                    </span>
                    <button class="history-card-delete" onclick="confirmarBorrarHistorial('${item.id}')" title="Eliminar">‚úï</button>
                </div>
                
                <div class="history-card-title">${titulo}</div>
                <div class="history-card-meta">
                    <span>üìÖ ${item.fecha}</span>
                    <span>üë§ ${item.nombre || 'Sin nombre'}</span>
                </div>
                
                <div class="history-card-stats">
                    <div class="history-stat">
                        <div class="history-stat-value">${totalProductos}</div>
                        <div class="history-stat-label">Productos</div>
                    </div>
                    <div class="history-stat">
                        <div class="history-stat-value">${totalUnidades}</div>
                        <div class="history-stat-label">Unidades</div>
                    </div>
                    ${item.productosOK !== undefined ? `
                    <div class="history-stat ok">
                        <div class="history-stat-value">${item.productosOK || 0}</div>
                        <div class="history-stat-label">OK</div>
                    </div>
                    <div class="history-stat diff">
                        <div class="history-stat-value">${item.productosDiff || 0}</div>
                        <div class="history-stat-label">Dif.</div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="history-card-actions">
                    <button class="history-action-btn primary" onclick="cargarDelHistorial('${item.id}')">
                        üìÇ Abrir
                    </button>
                    <button class="history-action-btn secondary" onclick="generarPDFDesdeHistorial('${item.id}')">
                        PDF
                    </button>
                    <button class="history-action-btn secondary" onclick="generarExcelDesdeHistorial('${item.id}')">
                        Excel
                    </button>
                </div>
            </div>
        `;
    }).join('');
}
        
        function confirmarBorrarHistorial(id) {
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const item = historial.find(h => h.id === id);
            
            if (!item) return;
            
            const nombre = item.tipo.includes('Recepci√≥n') ? `Gu√≠a #${item.numeroGuia}` : `Inventario del ${item.fecha}`;
            
            if (confirm(`¬øEliminar "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                const nuevoHistorial = historial.filter(h => h.id !== id);
                localStorage.setItem('historial_conteos', JSON.stringify(nuevoHistorial));
                renderHistory();
                showToast('‚úÖ Registro eliminado');
            }
        }
        
        // Reusar variables de swipe existentes
        
        function iniciarSwipeHistorial(e, id) {
            swipeStartX = e.touches[0].clientX;
        }
        
        function moverSwipeHistorial(e, id) {
            swipeCurrentX = e.touches[0].clientX;
        }
        
        function finalizarSwipeHistorial(e, id) {
            const diff = swipeStartX - swipeCurrentX;
            if (diff > 100) {
                // Swipe izquierda - mostrar opci√≥n borrar
                confirmarBorrarHistorial(id);
            }
        }
        
        function mostrarMenuBorrar(e, id) {
            e.preventDefault();
            confirmarBorrarHistorial(id);
        }
        
        function cargarDelHistorial(id) {
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const conteo = historial.find(c => c.id === id);
            if (!conteo) {
                showToast('‚ùå No se encontr√≥ el registro');
                return;
            }
            
            // Cargar datos seg√∫n el tipo
            if (conteo.tipo === 'Inventario') {
                dataCount = {...conteo.datos};
                currentBrand = 'Todos';
                mainView = 'inventory';
                switchMainView('inventory');
                showToast('‚úÖ Inventario cargado');
            } else if (conteo.tipo.includes('Recepci√≥n')) {
                dataReception = {...conteo.datos};
                currentDocNumber = conteo.numeroGuia || '';
                currentBrand = 'Todos';
                mainView = 'reception';
                switchMainView('reception');
                showToast(`‚úÖ Gu√≠a de despacho ${conteo.numeroGuia} cargada`);
            }
            
            saveData();
            renderProducts();
        }
        
        function generarPDFDesdeHistorial(id) {
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const conteo = historial.find(c => c.id === id);
            if (!conteo) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            doc.setFillColor(74, 4, 4);
            doc.rect(0, 0, 210, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('COQUINARIA', 105, 16, { align: 'center' });
            
            let y = 35;
            doc.setTextColor(74, 4, 4);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`CIERRE DE ${conteo.tipo.toUpperCase()}`, 105, y, { align: 'center' });
            
            y += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha: ${conteo.fecha}`, 15, y);
            
            y += 7;
            doc.text(`Responsable: ${conteo.nombre}`, 15, y);
            
            y += 12;
            doc.setFillColor(74, 4, 4);
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            
            doc.text('SKU', 15, y);
            doc.text('Producto', 35, y);
            doc.text('Cantidad', 170, y);
            
            
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            
            let rowCount = 0;
            rawProducts.forEach(p => {
                const qty = conteo.datos[p.sku] || 0;
                if (qty > 0) {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.text(p.sku, 15, y);
                    doc.text(p.name.substring(0, 35), 35, y);
                    doc.text(qty.toString(), 170, y, { align: 'right' });
                    
                    y += 6;
                    rowCount++;
                }
            });
            
            y += 3;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, y, 200, y);
            
            y += 7;
            doc.setFont('helvetica', 'bold');
            doc.text(`TOTAL DE ITEMS: ${rowCount}`, 15, y);
            
            y += 15;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('FIRMA:', 15, y);
            
            y += 3;
            if (conteo.firma) {
                doc.addImage(conteo.firma, 'PNG', 15, y, 60, 20);
            }
            
            y += 25;
            doc.setDrawColor(0, 0, 0);
            doc.line(15, y, 75, y);
            
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text(conteo.nombre, 15, y);
            
            const fileName = `Cierre_${conteo.tipo}_${conteo.fecha}.pdf`;
            doc.save(fileName);
            
            showToast('‚úÖ PDF descargado');
        }
        
        function generarExcelDesdeHistorial(id) {
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const conteo = historial.find(c => c.id === id);
            if (!conteo) return;
            
            const ExcelJS = window.ExcelJS;
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Cierre');
            
            worksheet.columns = [
                { header: 'SKU', key: 'sku', width: 12 },
                { header: 'Producto', key: 'producto', width: 40 },
                { header: 'Cantidad', key: 'cantidad', width: 12 }
            ];
            
            worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4a0404' } };
            worksheet.getRow(1).font = { color: { argb: 'FFFFFFFF' }, bold: true, size: 11 };
            
            let rowNum = 2;
            rawProducts.forEach(p => {
                const qty = conteo.datos[p.sku] || 0;
                if (qty > 0) {
                    worksheet.addRow({
                        sku: p.sku,
                        producto: p.name,
                        cantidad: qty
                    });
                    rowNum++;
                }
            });
            
            const totalRow = rowNum + 1;
            worksheet.getRow(totalRow).getCell(1).value = 'TOTAL';
            worksheet.getRow(totalRow).getCell(3).value = `=SUM(C2:C${rowNum - 1})`;
            worksheet.getRow(totalRow).font = { bold: true, size: 11 };
            worksheet.getRow(totalRow).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe2e8f0' } };
            
            const infoRow = totalRow + 3;
            worksheet.getRow(infoRow).getCell(1).value = 'Tipo:';
            worksheet.getRow(infoRow).getCell(2).value = conteo.tipo;
            worksheet.getRow(infoRow + 1).getCell(1).value = 'Responsable:';
            worksheet.getRow(infoRow + 1).getCell(2).value = conteo.nombre;
            worksheet.getRow(infoRow + 2).getCell(1).value = 'Fecha:';
            worksheet.getRow(infoRow + 2).getCell(2).value = conteo.fecha;
            
            const fileName = `Cierre_${conteo.tipo}_${conteo.fecha}.xlsx`;
            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                
                showToast('‚úÖ Excel descargado');
            });
        }

        // ============================================
        // OVERLAY
        // ============================================
        function openDetail(sku) {
            const p = rawProducts.find(x => x.sku === sku);
            if(!p) return;
            activeDetailSku = sku;
            
            document.getElementById('dBrand').innerText = p.brand;
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dSku').innerText = p.sku;
            document.getElementById('dDesc').innerText = p.description || 'Sin descripci√≥n disponible.';
            
            const originEl = document.getElementById('dOrigin');
            if (p.origin) {
                originEl.textContent = p.origin;
                originEl.style.display = 'inline-block';
            } else {
                originEl.style.display = 'none';
            }

            document.getElementById('productOverlay').classList.add('active');
        }

        function closeOverlay() {
            document.getElementById('productOverlay').classList.remove('active');
        }

        function showGuideSuggestions() {
            const guideInput = document.getElementById('guideNumber');
            if (!guideInput) return;
            
            // Obtener recepciones del historial
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const recepciones = historial.filter(h => h.tipo.includes('Recepci√≥n'));
            
            if (recepciones.length === 0) return;
            
            let suggestionHtml = '<div style="position: absolute; top: 40px; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
            recepciones.forEach(rec => {
                const numeroGuia = rec.numeroGuia || 'Sin n√∫mero';
                const fecha = rec.fecha || '';
                suggestionHtml += `
                    <div style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;" onclick="cargarRecepcionDelHistorial('${rec.id}')">
                        <div>
                            <div style="font-weight: 600; font-size: 13px;">Gu√≠a #${numeroGuia}</div>
                            <div style="font-size: 12px; color: #64748b;">${fecha}</div>
                        </div>
                    </div>
                `;
            });
            suggestionHtml += '</div>';
            
            guideInput.parentElement.style.position = 'relative';
            let existing = guideInput.parentElement.querySelector('[style*="position: absolute"]');
            if (existing) existing.remove();
            guideInput.parentElement.insertAdjacentHTML('beforeend', suggestionHtml);
        }

        function filterGuideSuggestions(value) {
            const guideInput = document.getElementById('guideNumber');
            if (!guideInput) return;
            
            // Obtener recepciones del historial y filtrar
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const recepciones = historial.filter(h => h.tipo.includes('Recepci√≥n'));
            
            const filtered = recepciones.filter(rec => {
                const numeroGuia = rec.numeroGuia || '';
                const fecha = rec.fecha || '';
                const term = value.toLowerCase();
                return numeroGuia.toLowerCase().includes(term) || fecha.toLowerCase().includes(term);
            });
            
            if (filtered.length === 0) {
                let existing = guideInput.parentElement.querySelector('[style*="position: absolute"]');
                if (existing) existing.remove();
                return;
            }
            
            let suggestionHtml = '<div style="position: absolute; top: 40px; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
            filtered.forEach(rec => {
                const numeroGuia = rec.numeroGuia || 'Sin n√∫mero';
                const fecha = rec.fecha || '';
                suggestionHtml += `
                    <div style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;" onclick="cargarRecepcionDelHistorial('${rec.id}')">
                        <div>
                            <div style="font-weight: 600; font-size: 13px;">Gu√≠a #${numeroGuia}</div>
                            <div style="font-size: 12px; color: #64748b;">${fecha}</div>
                        </div>
                    </div>
                `;
            });
            suggestionHtml += '</div>';
            
            guideInput.parentElement.style.position = 'relative';
            let existing = guideInput.parentElement.querySelector('[style*="position: absolute"]');
            if (existing) existing.remove();
            guideInput.parentElement.insertAdjacentHTML('beforeend', suggestionHtml);
        }

        function cargarRecepcionDelHistorial(recepcionId) {
            const historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            const recepcion = historial.find(r => r.id === recepcionId);
            
            if (!recepcion) {
                showToast('‚ùå No se encontr√≥ la recepci√≥n');
                return;
            }
            
            // Cargar datos de la recepci√≥n sin navegar
            dataReception = {...recepcion.datos};
            currentDocNumber = recepcion.numeroGuia || '';
            document.getElementById('guideNumber').value = currentDocNumber;
            
            // Limpiar sugerencias
            const guideInput = document.getElementById('guideNumber');
            let existing = guideInput.parentElement.querySelector('[style*="position: absolute"]');
            if (existing) existing.remove();
            
            saveData();
            renderProducts();
            showToast(`‚úÖ Recepci√≥n #${currentDocNumber} cargada`);
        }

        function setGuide(guide) {
            const guideInput = document.getElementById('guideNumber');
            guideInput.value = guide;
            // Limpiar sugerencias
            let existing = guideInput.parentElement.querySelector('[style*="position: absolute"]');
            if (existing) existing.remove();
            saveData();
        }

        function setupOverlaySwipe() {
            const card = document.getElementById('detailCard');
            card.addEventListener('touchstart', e => { swipeStartX = e.changedTouches[0].screenX; }, {passive: true});
            card.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX;
                if (swipeStartX - endX > 50) navigateDetail(1); 
                if (endX - swipeStartX > 50) navigateDetail(-1); 
            }, {passive: true});
        }

        function navigateDetail(dir) {
            const idx = rawProducts.findIndex(p => p.sku === activeDetailSku);
            if(idx === -1) return;
            let nextIdx = idx + dir;
            if(nextIdx >= rawProducts.length) nextIdx = 0;
            if(nextIdx < 0) nextIdx = rawProducts.length - 1;
            openDetail(rawProducts[nextIdx].sku);
        }

        // ============================================
        // UTILS
        // ============================================
// ============================================
// B√öSQUEDA INTELIGENTE
// ============================================
function handleSearchInput(el) {
    searchTerm = el.value.toLowerCase().trim();
    document.querySelector('.clear-search').style.display = searchTerm ? 'block' : 'none';
    
    // Solo filtrar productos, sin sugerencias
    hideSuggestions();
    
    // Si estamos en modo gu√≠a, usar render especial
    if (window.productosGuiaActual && window.productosGuiaActual.length > 0) {
        renderProductsGuia();
    } else {
        renderProducts();
    }
}

function generateSuggestions() {
    // Funci√≥n deshabilitada - no usar sugerencias
    searchSuggestions = [];
}

function showSuggestions() {
    // Funci√≥n deshabilitada - no mostrar sugerencias
    hideSuggestions();
}

function hideSuggestions() {
    const container = document.getElementById('searchSuggestions');
    if (container) container.classList.remove('active');
}

function hideSuggestionsDelayed() {
    setTimeout(() => hideSuggestions(), 200);
}

function highlightMatch(text, term) {
    const index = text.toLowerCase().indexOf(term);
    if (index === -1) return text;
    
    const before = text.substring(0, index);
    const match = text.substring(index, index + term.length);
    const after = text.substring(index + term.length);
    
    return `${before}<span class="suggestion-highlight">${match}</span>${after}`;
}

function getSuggestionIcon(type) {
    const icons = {
        'SKU': '<svg class="suggestion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>',
        'Producto': '<svg class="suggestion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>',
        'Marca': '<svg class="suggestion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>',
        'Origen': '<svg class="suggestion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
    };
    return icons[type] || icons['Producto'];
}

function selectSuggestion(term) {
    document.getElementById('searchInput').value = term;
    searchTerm = term.toLowerCase();
    document.querySelector('.clear-search').style.display = 'block';
    
    addToSearchHistory(term);
    hideSuggestions();
    renderProducts();
}

function selectSuggestionProduct(sku) {
    const product = rawProducts.find(p => p.sku === sku);
    if (!product) return;
    
    document.getElementById('searchInput').value = product.name;
    searchTerm = product.name.toLowerCase();
    document.querySelector('.clear-search').style.display = 'block';
    
    addToSearchHistory(product.name);
    hideSuggestions();
    renderProducts();
    
    // Opcional: abrir detalle del producto
    setTimeout(() => openDetail(sku), 300);
}

function addToSearchHistory(term) {
    // Evitar duplicados
    searchHistory = searchHistory.filter(t => t !== term);
    // Agregar al inicio
    searchHistory.unshift(term);
    // Mantener solo √∫ltimas 10
    searchHistory = searchHistory.slice(0, 10);
    // Guardar
    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
}

function clearSearchHistory() {
    searchHistory = [];
    localStorage.removeItem('searchHistory');
    hideSuggestions();
    showToast('üóëÔ∏è Historial borrado');
}

function clearSearch() {
    searchTerm = '';
    searchSuggestions = [];
    document.getElementById('searchInput').value = '';
    document.querySelector('.clear-search').style.display = 'none';
    hideSuggestions();
    renderProducts();
}

function setupSearch() {
    // Ya no necesitamos addEventListener adicional, est√° en el HTML
}
        function handleFileImport() { showToast("Importaci√≥n no configurada en demo"); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        
        function mostrarLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'flex';
        }
        
        function ocultarLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }
        
        function handleScroll() {
            const btn = document.getElementById('floatingSaveBtn');
            const icon = document.getElementById('floatingIcon');
            if(window.scrollY > 150) btn.classList.add('visible');
            else btn.classList.remove('visible');
            
            const isBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100);
            if (isBottom) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />';
                btn.onclick = () => window.scrollTo({top:0, behavior:'smooth'});
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />';
                btn.onclick = () => window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
            }
        }

        // ============================================
        // M√ìDULO EXCEL - EXPORTAR / IMPORTAR
        // ============================================
        async function cargarLibreriaXLSX() {
            if (window.XLSX) return window.XLSX;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
                script.onload = () => resolve(window.XLSX);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function exportarPlantillaExcel(data) {
            const XLSX = await cargarLibreriaXLSX();
            
            const wb = XLSX.utils.book_new();
            
            const wsData = [];
            
            wsData.push(['COQUINARIA - RECEPCI√ìN DE MERCADER√çA']);
            wsData.push([]);
            wsData.push(['N¬∫ Gu√≠a:', data.numeroGuia || '', 'Fecha:', new Date().toLocaleDateString('es-CL')]);
            wsData.push(['Proveedor:', 'Kitchen Center']);
            wsData.push([]);
            
            wsData.push(['SKU', 'Descripci√≥n', 'Cantidad Gu√≠a', 'Cantidad Recepcionada', 'Diferencia', 'Comentarios']);
            
            data.productos.forEach(prod => {
                wsData.push([
                    prod.codigo,
                    prod.descripcion,
                    prod.cantidad,
                    '',
                    '=D' + (wsData.length + 1) + '-C' + (wsData.length + 1),
                    ''
                ]);
            });
            
            wsData.push([]);
            wsData.push([]);
            
            wsData.push(['RESUMEN']);
            wsData.push(['Total productos:', data.productos.length]);
            wsData.push(['Productos con diferencias:', '=COUNTIF(E7:E' + (6 + data.productos.length) + ',"<>0")']);
            wsData.push([]);
            
            wsData.push(['FIRMA Y AUTORIZACI√ìN']);
            wsData.push(['Recepcionado por:', '']);
            wsData.push(['Fecha y hora:', '']);
            wsData.push(['Observaciones:', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                { wch: 10 },
                { wch: 40 },
                { wch: 15 },
                { wch: 20 },
                { wch: 15 },
                { wch: 30 }
            ];
            
            const metaData = [
                ['METADATA'],
                ['numeroGuia', data.numeroGuia],
                ['fecha', new Date().toISOString()],
                ['productos', JSON.stringify(data.productos)],
                ['textoCompleto', data.textoCompleto || '']
            ];
            
            const wsMeta = XLSX.utils.aoa_to_sheet(metaData);
            
            XLSX.utils.book_append_sheet(wb, ws, 'Recepci√≥n');
            XLSX.utils.book_append_sheet(wb, wsMeta, 'Metadata');
            
            const fileName = `Recepcion_Plantilla_${data.numeroGuia}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('üì• Plantilla Excel descargada');
        }

        async function exportarRecepcionCompleta(numeroGuia) {
            const XLSX = await cargarLibreriaXLSX();
            
            const productos = [];
            let totalDiferencias = 0;
            const faltantes = [];
            
            rawProducts.forEach(p => {
                const cantGuia = dataReception[p.sku] || 0;
                if (cantGuia > 0) {
                    const cantRecep = cantGuia;
                    const diff = cantRecep - cantGuia;
                    
                    productos.push({
                        sku: p.sku,
                        nombre: p.name,
                        cantGuia: cantGuia,
                        cantRecep: cantRecep,
                        diferencia: diff,
                        comentario: ''
                    });
                    
                    if (diff !== 0) {
                        totalDiferencias++;
                        faltantes.push({ sku: p.sku, nombre: p.name, diff: diff });
                    }
                }
            });
            
            const wb = XLSX.utils.book_new();
            
            const wsData = [];
            
            wsData.push(['COQUINARIA - RECEPCI√ìN DE MERCADER√çA']);
            wsData.push([]);
            wsData.push(['N¬∫ Gu√≠a:', numeroGuia, 'Fecha:', new Date().toLocaleDateString('es-CL')]);
            wsData.push(['Proveedor:', 'Kitchen Center', 'Documento:', currentDocNumber]);
            wsData.push([]);
            
            wsData.push(['SKU', 'Descripci√≥n', 'Cant. Gu√≠a', 'Cant. Recepcionada', 'Diferencia', 'Estado', 'Comentarios']);
            
            productos.forEach(prod => {
                const estado = prod.diferencia === 0 ? 'OK' : (prod.diferencia < 0 ? 'FALTA' : 'EXTRA');
                wsData.push([
                    prod.sku,
                    prod.nombre,
                    prod.cantGuia,
                    prod.cantRecep,
                    prod.diferencia,
                    estado,
                    prod.comentario
                ]);
            });
            
            wsData.push([]);
            wsData.push([]);
            
            wsData.push(['---------------------------------------']);
            wsData.push(['RESUMEN DE RECEPCION']);
            wsData.push(['---------------------------------------']);
            wsData.push(['Total productos:', productos.length]);
            wsData.push(['Productos con diferencias:', totalDiferencias]);
            wsData.push(['Total unidades gu√≠a:', productos.reduce((sum, p) => sum + p.cantGuia, 0)]);
            wsData.push(['Total unidades recepcionadas:', productos.reduce((sum, p) => sum + p.cantRecep, 0)]);
            wsData.push([]);
            
            if (faltantes.length > 0) {
                wsData.push(['DETALLE DE DIFERENCIAS:']);
                faltantes.forEach(f => {
                    wsData.push(['', `SKU ${f.sku}: ${f.diff > 0 ? '+' : ''}${f.diff} unidades (${f.nombre})`]);
                });
                wsData.push([]);
            }
            
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['FIRMA Y AUTORIZACI√ìN']);
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['Recepcionado por:', '____________________']);
            wsData.push(['Fecha y hora:', new Date().toLocaleString('es-CL')]);
            wsData.push(['Observaciones:', '']);
            wsData.push(['', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                { wch: 10 },
                { wch: 45 },
                { wch: 12 },
                { wch: 18 },
                { wch: 12 },
                { wch: 12 },
                { wch: 30 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Recepci√≥n');
            
            const fileName = `Recepcion_${numeroGuia}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('‚úÖ Recepci√≥n exportada a Excel');
        
    }
async function procesarArchivoConIA(archivo) {
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        const base64 = e.target.result;
        
        try {
            const response = await fetch('/.netlify/functions/process-guia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64 })
            });

            // IMPORTANTE: Solo leemos el body una vez aqu√≠
            const resultado = await response.json();

            if (resultado.success) {
                ejecutarSumaInventario(resultado);
            } else {
                alert("Error en el escaneo: " + resultado.error);
            }
        } catch (err) {
            console.error("Fallo de red o servidor:", err);
            alert("No se pudo conectar con el servicio de IA.");
        }
    };
    
    reader.readAsDataURL(archivo);
}

function ejecutarSumaInventario(data) {
    let itemsActualizados = 0;

    data.productos.forEach(pIA => {
        // Buscamos en tu lista global 'products'
        const item = products.find(p => p.sku === pIA.sku);
        
        if (item) {
            // Suma al stock maestro
            item.units = (parseInt(item.units) || 0) + pIA.unidades;
            
            // Registro en la recepci√≥n del documento actual
            dataReception[pIA.sku] = (dataReception[pIA.sku] || 0) + pIA.unidades;
            itemsActualizados++;
        }
    });

    // Sincronizar UI y Almacenamiento
    if (typeof saveData === 'function') saveData();
    if (typeof renderProducts === 'function') renderProducts();

    alert(`‚úÖ Factura ${data.numeroGuia} procesada.\nSe actualizaron ${itemsActualizados} productos.`);
}
        async function importarExcelRecepcion(file) {
            const XLSX = await cargarLibreriaXLSX();
            
            showToast('üìÇ Leyendo archivo Excel...');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    let tipo = '';
                    let numeroGuia = '';
                    let fecha = '';
                    let responsable = '';
                    const productos = [];
                    
                    // Leer metadata (filas 1-3)
                    if (jsonData[0] && jsonData[0][0] === 'FECHA') fecha = jsonData[0][1];
                    if (jsonData[1] && jsonData[1][0] === 'TIPO') tipo = jsonData[1][1];
                    if (jsonData[2] && jsonData[2][0] === 'RESPONSABLE') responsable = jsonData[2][1];
                    
                    // Extraer n√∫mero de gu√≠a si est√° en el tipo
                    if (tipo && tipo.includes('Recepci√≥n')) {
                        const match = tipo.match(/#(.+)/);
                        if (match) numeroGuia = match[1];
                    }
                    
                    // Buscar headers (fila 5)
                    let headerRow = -1;
                    for (let i = 0; i < jsonData.length; i++) {
                        if (jsonData[i][0] === 'SKU' && (jsonData[i][1] === 'Producto' || jsonData[i][1] === 'Descripci√≥n')) {
                            headerRow = i;
                            break;
                        }
                    }
                    
                    // Leer productos
                    if (headerRow >= 0) {
                        for (let j = headerRow + 1; j < jsonData.length; j++) {
                            const row = jsonData[j];
                            if (!row[0] || row[0] === 'TOTAL') break;
                            
                            productos.push({
                                sku: row[0]?.toString() || '',
                                descripcion: row[1] || '',
                                cantidad: parseInt(row[2]) || 0
                            });
                        }
                    }
                    
                    // Aplicar autom√°ticamente si es local
                    aplicarImportacionAutomatica(tipo, fecha, numeroGuia, responsable, productos);
                    
                } catch (error) {
                    console.error('Error al importar:', error);
                    showToast('‚ùå Error al leer el archivo Excel');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // MODO SIMULACI√ìN - cambiar a false para producci√≥n
        const MODO_SIMULACION = false;
        
        async function importarGuidaPDF(file) {
            if (!file) return;
            
            mostrarLoading();
            
            // Si estamos en modo simulaci√≥n, usar datos de prueba
            if (MODO_SIMULACION) {
                setTimeout(() => {
                    ocultarLoading();
                    
                    // Datos simulados de una gu√≠a
                    const folio = '12345678';
                    const fecha = '28/01/2025';
                    const productos = [
                        { sku: '80003', descripcion: 'Esp√°tula Coquinaria', cantidad: 5 },
                        { sku: '80004', descripcion: 'Trincho para BBQ Coquinaria', cantidad: 3 },
                        { sku: '80006', descripcion: 'Cuchara para Servir Coquinaria', cantidad: 10 },
                        { sku: '80090', descripcion: 'Tabla quesos m√°rmol', cantidad: 2 },
                        { sku: '80420', descripcion: 'Mix 4 pimientas 340g', cantidad: 8 }
                    ];
                    
                    currentDocNumber = folio;
                    mostrarConfirmacionProductos(folio, fecha, productos);
                }, 1500); // Simular 1.5 segundos de carga
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Convertir PDF a imagen primero
                        let canvas;
                        try {
                            canvas = await convertirPDFaImagen(e.target.result);
                        } catch (pdfError) {
                            console.error('Error en PDF.js:', pdfError);
                            ocultarLoading();
                            showToast('‚ùå No se pudo procesar el PDF: ' + pdfError.message);
                            return;
                        }
                        
                        if (!canvas) {
                            ocultarLoading();
                            showToast('‚ùå Error al convertir PDF a imagen');
                            return;
                        }
                        
                        // Obtener imagen en base64
                        const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        console.log('üì∏ Imagen generada, tama√±o:', (imageBase64.length / 1024).toFixed(2), 'KB');
                        
                        // Enviar a AI
                        const response = await fetch('/.netlify/functions/process-guia', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: imageBase64 })
                        });
                        
                        let result;
                        try {
                            result = await response.json();
                        } catch (parseError) {
                            console.error('Error parseando JSON:', parseError);
                            const responseText = await response.text();
                            console.error('Respuesta recibida:', responseText.substring(0, 200));
                            ocultarLoading();
                            showToast('‚ùå Error en respuesta de servidor. Intenta de nuevo.');
                            return;
                        }
                        
                        ocultarLoading();
                        
                        if (!result || !result.success) {
                            showToast('‚ùå ' + (result?.error || 'Error desconocido'));
                            return;
                        }
                        
                        const folio = result.numeroFactura || result.numeroGuia || result.folio || '';
                        const fecha = result.fechaOrden || result.fechaFactura || '';
                        const productos = (result.productos || []).map(p => ({
                            sku: p.codigo,
                            descripcion: p.descripcion,
                            cantidad: p.cantidad
                        }));
                        
                        console.log('‚úÖ Datos extra√≠dos:', {folio, productos: productos.length});
                        
                        if (!folio || productos.length === 0) {
                            showToast('‚ùå No se pudieron extraer los datos del PDF');
                            return;
                        }
                        
                        currentDocNumber = folio;
                        document.getElementById('guideNumber').value = folio;
                        
                        mostrarConfirmacionProductos(folio, fecha, productos);
                        
                    } catch (error) {
                        console.error('Error procesando PDF:', error);
                        showToast('‚ùå Error al procesar el PDF: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al leer el PDF');
            }
        }
        
        async function convertirPDFaImagen(pdfArrayBuffer) {
            try {
                // Cargar PDF.js si no est√° disponible
                if (!window.pdfjsLib) {
                    try {
                        await cargarPDFJS();
                    } catch (loadError) {
                        console.warn('‚ö†Ô∏è PDF.js no disponible, usando fallback...');
                        return await convertirPDFconFallback(pdfArrayBuffer);
                    }
                }
                
                console.log('üìÑ Cargando PDF con PDF.js...');
                const pdf = await window.pdfjsLib.getDocument({data: pdfArrayBuffer}).promise;
                const page = await pdf.getPage(1);
                
                const scale = 2;
                const viewport = page.getViewport({scale: scale});
                
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const context = canvas.getContext('2d');
                if (!context) {
                    throw new Error('No se pudo obtener contexto 2D del canvas');
                }
                
                console.log('üñºÔ∏è Renderizando p√°gina...');
                const renderTask = page.render({
                    canvasContext: context,
                    viewport: viewport
                });
                
                await renderTask.promise;
                console.log('‚úÖ PDF convertido a imagen');
                
                return canvas;
            } catch (error) {
                console.error('‚ùå Error con PDF.js:', error);
                try {
                    console.log('üìÑ Intentando fallback...');
                    return await convertirPDFconFallback(pdfArrayBuffer);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback tambi√©n fall√≥:', fallbackError);
                    throw fallbackError;
                }
            }
        }
        
        async function convertirPDFconFallback(pdfArrayBuffer) {
            // Crear un canvas blanco como fallback
            // En producci√≥n, aqu√≠ ir√≠a una API externa como PDF2Pic o similiar
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 1600;
            
            const context = canvas.getContext('2d');
            context.fillStyle = '#ffffff';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.fillStyle = '#000000';
            context.font = '20px Arial';
            context.fillText('‚ùå No se pudo procesar el PDF', 50, 100);
            context.fillText('Por favor, intenta con una foto de la gu√≠a', 50, 150);
            
            throw new Error('PDF.js no disponible. Usa una foto de la gu√≠a en su lugar.');
        }
        
        async function cargarPDFJS() {
            return new Promise((resolve, reject) => {
                // Verificar si ya est√° cargado
                if (window.pdfjsLib) {
                    resolve();
                    return;
                }
                
                // Intentar con diferentes CDNs (usando versiones que S√ç existen)
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
                    'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js'
                ];
                
                let intentoActual = 0;
                
                const cargarDelCDN = () => {
                    if (intentoActual >= cdnUrls.length) {
                        reject(new Error('No se pudo cargar PDF.js desde ning√∫n CDN'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[intentoActual];
                    script.crossOrigin = 'anonymous';
                    
                    script.onload = () => {
                        try {
                            setTimeout(() => {
                                if (window.pdfjsLib) {
                                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = cdnUrls[intentoActual].replace('pdf.min.js', 'pdf.worker.min.js');
                                    console.log('‚úÖ PDF.js cargado desde:', cdnUrls[intentoActual]);
                                    resolve();
                                } else {
                                    intentoActual++;
                                    cargarDelCDN();
                                }
                            }, 100);
                        } catch (e) {
                            intentoActual++;
                            cargarDelCDN();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('‚ö†Ô∏è CDN fall√≥:', cdnUrls[intentoActual]);
                        intentoActual++;
                        cargarDelCDN();
                    };
                    
                    document.head.appendChild(script);
                };
                
                cargarDelCDN();
            });
        }
        
        function mostrarConfirmacionProductos(numeroFactura, fecha, productos) {
            // Guardar datos en variable global
            window.tempProductosCargar = {
                numeroFactura: numeroFactura,
                productos: productos.map(p => ({
                    sku: p.sku,
                    descripcion: p.descripcion,
                    cantidad: p.cantidad,
                    cantidadRecibida: p.cantidad, // Por defecto igual a lo esperado
                    verificado: false
                }))
            };
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const totalUnidades = productos.reduce((sum, p) => sum + p.cantidad, 0);
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 18px;">
                        Gu√≠a #${numeroFactura}
                    </div>
                    <div style="font-size: 13px; color: #64748b; margin-top: 5px;">
                        ${fecha ? `Fecha: ${fecha} | ` : ''}${productos.length} productos | ${totalUnidades} unidades
                    </div>
                </div>
                
                <div style="background: #f0fdf4; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 14px; color: #166534; font-weight: 600;">
                        ¬øIniciar verificaci√≥n de recepci√≥n?
                    </div>
                    <div style="font-size: 12px; color: #15803d; margin-top: 5px;">
                        Confirmar√°s la cantidad recibida de cada producto
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button onclick="window.verificacionIndex=0; mostrarProductoVerificacion();" class="btn-cta" style="width: 100%;">
                        Iniciar Verificaci√≥n
                    </button>
                    <button onclick="closeShareModal()" style="width: 100%; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        ‚úï Cancelar
                    </button>
                </div>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Gu√≠a Detectada';
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        function iniciarVerificacionEnModal() {
            if (!window.tempProductosCargar) {
                showToast('‚ùå Error: No hay datos');
                return;
            }
            
            window.verificacionIndex = 0;
            mostrarProductoVerificacion();
        }
        
        function mostrarProductoVerificacion() {
            const data = window.tempProductosCargar;
            if (!data) return;
            
            const index = window.verificacionIndex || 0;
            
            // Si terminamos todos, mostrar resumen
            if (index >= data.productos.length) {
                mostrarResumenVerificacion();
                return;
            }
            
            const producto = data.productos[index];
            const productoInfo = rawProducts.find(p => p.sku === producto.sku);
            const nombreProducto = productoInfo ? productoInfo.name : producto.descripcion;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const progreso = ((index + 1) / data.productos.length * 100).toFixed(0);
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #64748b;">Producto ${index + 1} de ${data.productos.length}</span>
                        <span style="font-size: 12px; font-weight: 600; color: #059669;">${progreso}%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${progreso}%; height: 100%; background: linear-gradient(90deg, #059669, #10b981); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">SKU ${producto.sku}</div>
                    <div style="font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 15px; line-height: 1.4;">${nombreProducto}</div>
                    
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid #e2e8f0;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 5px;">Cantidad en gu√≠a</div>
                        <div style="font-size: 42px; font-weight: 800; color: #1e293b;">${producto.cantidad}</div>
                    </div>
                </div>
                
                <div style="font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 15px; text-align: center;">
                    ¬øRecibi√≥ ${producto.cantidad} unidades?
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="confirmarProductoVerificacion(${producto.cantidad})" 
                            style="flex: 1; padding: 16px; border: 2px solid #059669; background: #f0fdf4; color: #059669; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer;">
                        S√≠
                    </button>
                    <button onclick="mostrarInputDiferencia()" 
                            style="flex: 1; padding: 16px; border: 2px solid #dc2626; background: #fef2f2; color: #dc2626; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer;">
                        No
                    </button>
                </div>
                
                <button onclick="cancelarVerificacion()" 
                        style="width: 100%; padding: 10px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    Cancelar
                </button>
            `;
            
            modalContent.innerHTML = `<h3 class="modal-title">Gu√≠a #${data.numeroFactura}</h3>` + html;
            modal.classList.add('active');
        }
        
        function mostrarInputDiferencia() {
            const data = window.tempProductosCargar;
            const index = window.verificacionIndex || 0;
            const producto = data.productos[index];
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #64748b;">SKU ${producto.sku}</div>
                    <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-top: 5px;">${producto.descripcion}</div>
                </div>
                
                <div style="background: #fef2f2; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #991b1b; margin-bottom: 15px; text-align: center;">
                        Esperado: <strong>${producto.cantidad}</strong> unidades
                    </div>
                    
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b; text-align: center;">¬øCu√°ntas recibi√≥?</label>
                    <input type="number" id="inputCantidadRecibida" min="0" value="0" 
                           style="width: 100%; padding: 15px; border: 2px solid #dc2626; border-radius: 8px; font-size: 28px; font-weight: 700; text-align: center;">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="mostrarProductoVerificacion()" 
                            style="flex: 1; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Volver
                    </button>
                    <button onclick="confirmarCantidadDiferenteModal()" 
                            style="flex: 1; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Confirmar
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = `<h3 class="modal-title">Cantidad diferente</h3>` + html;
            
            setTimeout(() => {
                const input = document.getElementById('inputCantidadRecibida');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }
        
        function confirmarProductoVerificacion(cantidad) {
            const data = window.tempProductosCargar;
            const index = window.verificacionIndex || 0;
            
            data.productos[index].cantidadRecibida = cantidad;
            data.productos[index].verificado = true;
            
            window.verificacionIndex = index + 1;
            mostrarProductoVerificacion();
        }
        
        function confirmarCantidadDiferenteModal() {
            const cantidad = parseInt(document.getElementById('inputCantidadRecibida')?.value) || 0;
            confirmarProductoVerificacion(cantidad);
        }
        
        function cancelarVerificacion() {
            if (confirm('¬øCancelar verificaci√≥n?\n\nSe perder√° el progreso.')) {
                window.tempProductosCargar = null;
                window.verificacionIndex = 0;
                closeShareModal();
            }
        }
        
        function mostrarResumenVerificacion() {
            const data = window.tempProductosCargar;
            if (!data) return;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let totalEsperado = 0;
            let totalRecibido = 0;
            let productosOK = 0;
            let productosDiff = 0;
            
            data.productos.forEach(p => {
                totalEsperado += p.cantidad;
                totalRecibido += p.cantidadRecibida;
                if (p.cantidadRecibida === p.cantidad) {
                    productosOK++;
                } else {
                    productosDiff++;
                }
            });
            
            const diferencia = totalRecibido - totalEsperado;
            
            let html = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">${productosDiff > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 16px;">Verificaci√≥n Completada</div>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div style="background: white; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #64748b;">Esperado</div>
                            <div style="font-size: 22px; font-weight: 700;">${totalEsperado}</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #64748b;">Recibido</div>
                            <div style="font-size: 22px; font-weight: 700; color: ${diferencia === 0 ? '#059669' : '#dc2626'};">${totalRecibido}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; text-align: center; padding: 8px; background: ${diferencia === 0 ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
                        <span style="color: ${diferencia === 0 ? '#059669' : '#dc2626'}; font-weight: 600; font-size: 13px;">
                            Diferencia: ${diferencia >= 0 ? '+' : ''}${diferencia}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 12px;">
                        <span style="color: #059669;">‚úì ${productosOK} OK</span>
                        <span style="color: #dc2626;">‚ö† ${productosDiff} dif.</span>
                    </div>
                </div>
                
                <div style="max-height: 150px; overflow-y: auto; margin-bottom: 15px; background: #f8fafc; border-radius: 8px; padding: 10px;">
                    <div style="font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 8px;">Detalle:</div>
                    ${data.productos.map(p => {
                        const diff = p.cantidadRecibida - p.cantidad;
                        const color = diff === 0 ? '#059669' : '#dc2626';
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 11px;">
                                <span style="color: #1e293b; flex: 1;">${p.sku}</span>
                                <span style="color: #64748b; margin-right: 10px;">${p.cantidad}‚Üí${p.cantidadRecibida}</span>
                                <span style="color: ${color}; font-weight: 600; width: 40px; text-align: right;">${diff >= 0 ? '+' : ''}${diff}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button onclick="editarVerificacion()" style="width: 100%; padding: 12px; background: #f8fafc; color: #1e293b; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Editar productos
                    </button>
                    <button onclick="irAFirmarVerificacion()" class="btn-cta" style="width: 100%;">
                        Firmar y Guardar
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = `<h3 class="modal-title">Gu√≠a #${data.numeroFactura}</h3>` + html;
        }
        
        function editarVerificacion() {
            const data = window.tempProductosCargar;
            if (!data) return;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: #64748b;">Edita las cantidades recibidas:</div>
                </div>
                
                <div style="max-height: 350px; overflow-y: auto; margin-bottom: 15px;">
                    ${data.productos.map((p, idx) => {
                        const productoInfo = rawProducts.find(r => r.sku === p.sku);
                        const nombre = productoInfo ? productoInfo.name : p.descripcion;
                        return `
                            <div style="background: #f8fafc; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="font-size: 11px; color: #64748b;">${p.sku}</div>
                                <div style="font-size: 13px; font-weight: 600; color: #1e293b; margin: 4px 0;">${nombre}</div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                    <span style="font-size: 12px; color: #64748b;">Gu√≠a: ${p.cantidad}</span>
                                    <span style="font-size: 12px; color: #64748b;">‚Üí</span>
                                    <input type="number" min="0" value="${p.cantidadRecibida}" 
                                           onchange="actualizarCantidadProducto(${idx}, this.value)"
                                           style="width: 70px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-weight: 600; text-align: center;">
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <button onclick="mostrarResumenVerificacion()" class="btn-cta" style="width: 100%;">
                    Volver al resumen
                </button>
            `;
            
            modalContent.innerHTML = `<h3 class="modal-title">Editar Cantidades</h3>` + html;
        }
        
        function actualizarCantidadProducto(index, valor) {
            const data = window.tempProductosCargar;
            if (data && data.productos[index]) {
                data.productos[index].cantidadRecibida = parseInt(valor) || 0;
            }
        }
        
        function irAFirmarVerificacion() {
            const data = window.tempProductosCargar;
            if (!data) return;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let totalEsperado = 0;
            let totalRecibido = 0;
            data.productos.forEach(p => {
                totalEsperado += p.cantidad;
                totalRecibido += p.cantidadRecibida;
            });
            
            let html = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #64748b;">Gu√≠a #${data.numeroFactura}</div>
                    <div style="font-size: 13px; color: #1e293b; margin-top: 5px;">
                        ${data.productos.length} productos | Recibido: ${totalRecibido}/${totalEsperado}
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Nombre del receptor:</label>
                    <input type="text" id="inputNombreVerif" placeholder="Ingrese su nombre" 
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Firma:</label>
                    <canvas id="canvasFirmaVerif" width="300" height="100" 
                            style="width: 100%; height: 100px; border: 2px dashed #e2e8f0; border-radius: 8px; background: white; touch-action: none;"></canvas>
                    <button onclick="limpiarCanvasVerif()" style="margin-top: 6px; padding: 6px 12px; background: #e2e8f0; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="mostrarResumenVerificacion()" style="flex: 1; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Volver
                    </button>
                    <button onclick="guardarVerificacionFinal()" class="btn-cta" style="flex: 1;">
                        Guardar
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = `<h3 class="modal-title">Firmar Recepci√≥n</h3>` + html;
            
            setTimeout(initCanvasVerif, 100);
        }
        
        function initCanvasVerif() {
            const canvas = document.getElementById('canvasFirmaVerif');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let drawing = false;
            
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x: x * (canvas.width / rect.width), y: y * (canvas.height / rect.height) };
            };
            
            const start = (e) => { e.preventDefault(); drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke(); };
            const stop = () => { drawing = false; };
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);
        }
        
        function limpiarCanvasVerif() {
            const canvas = document.getElementById('canvasFirmaVerif');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function guardarVerificacionFinal() {
            const data = window.tempProductosCargar;
            if (!data) return;
            
            const nombre = document.getElementById('inputNombreVerif')?.value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirmaVerif');
            
            if (!canvas) {
                showToast('‚ùå Error');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some((channel, i) => i % 4 !== 3 && channel !== 0);
            
            if (!hasDrawing) {
                showToast('‚ö†Ô∏è Por favor firme');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            
            let totalEsperado = 0;
            let totalRecibido = 0;
            let productosOK = 0;
            let productosDiff = 0;
            
            data.productos.forEach(p => {
                totalEsperado += p.cantidad;
                totalRecibido += p.cantidadRecibida;
                if (p.cantidadRecibida === p.cantidad) productosOK++;
                else productosDiff++;
            });
            
            const hoy = new Date().toISOString().split('T')[0];
            const conteo = {
                id: `Recepcion_${data.numeroFactura}_${Date.now()}`,
                tipo: `Recepci√≥n Gu√≠a #${data.numeroFactura}`,
                fecha: hoy,
                nombre: nombre,
                firma: firmaDataURL,
                numeroGuia: data.numeroFactura,
                datos: {},
                productosDetalle: data.productos.map(p => ({
                    sku: p.sku,
                    descripcion: p.descripcion,
                    esperado: p.cantidad,
                    recibido: p.cantidadRecibida,
                    diferencia: p.cantidadRecibida - p.cantidad
                })),
                totalEsperado,
                totalRecibido,
                productosOK,
                productosDiff,
                timestamp: new Date().getTime()
            };
            
            data.productos.forEach(p => {
                conteo.datos[p.sku] = p.cantidadRecibida;
            });
            
            // Guardar en historial
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            historial.unshift(conteo);
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = conteo;
            window.tempProductosCargar = null;
            window.verificacionIndex = 0;
            
            showToast('‚úÖ Recepci√≥n guardada');
            closeShareModal();
            
            setTimeout(() => {
                mostrarModalExportarConteo();
            }, 200);
        }
        
        function mostrarModalReemplazar(numeroFactura, productos, existente) {
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const fechaExistente = new Date(existente.timestamp).toLocaleDateString('es-CL');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                    <div style="font-weight: 600; color: #1e293b; font-size: 16px;">
                        Ya existe una recepci√≥n con este n√∫mero
                    </div>
                    <div style="font-size: 13px; color: #64748b; margin-top: 10px;">
                        Factura #${numeroFactura}<br>
                        Guardada el ${fechaExistente}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button onclick="reemplazarRecepcion('${numeroFactura}')" class="btn-cta" style="width: 100%; background: #dc2626;">
                        üîÑ Reemplazar existente
                    </button>
                    <button onclick="continuarSinReemplazar('${numeroFactura}')" class="btn-cta" style="width: 100%;">
                        ‚ûï Crear nueva recepci√≥n
                    </button>
                    <button onclick="closeShareModal()" style="width: 100%; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        ‚úï Cancelar
                    </button>
                </div>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Recepci√≥n duplicada';
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        function reemplazarRecepcion(numeroFactura) {
            // Eliminar la recepci√≥n existente del historial
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            historial = historial.filter(h => !(h.numeroGuia === numeroFactura && h.tipo && h.tipo.includes('Recepci√≥n')));
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            const { productos } = window.tempProductosCargar;
            closeShareModal();
            setTimeout(() => {
                ejecutarCargaProductos(numeroFactura, productos);
            }, 100);
        }
        
        function continuarSinReemplazar(numeroFactura) {
            const { productos } = window.tempProductosCargar;
            closeShareModal();
            setTimeout(() => {
                ejecutarCargaProductos(numeroFactura, productos);
            }, 100);
        }
        
        function ejecutarCargaProductos(numeroFactura, productos) {
            // Guardar datos para verificaci√≥n uno por uno
            window.verificacionGuia = {
                numeroFactura: numeroFactura,
                productos: productos.map(p => ({
                    sku: p.sku,
                    descripcion: p.descripcion,
                    cantidadEsperada: p.cantidad,
                    cantidadRecibida: null,
                    verificado: false
                })),
                indexActual: 0
            };
            
            currentDocNumber = numeroFactura;
            closeShareModal();
            
            // Limpiar variable temporal
            window.tempProductosCargar = null;
            
            // Iniciar verificaci√≥n
            setTimeout(() => {
                mostrarVerificacionProductoGuia();
            }, 150);
        }
        
        function mostrarVerificacionProductoGuia() {
            const data = window.verificacionGuia;
            if (!data) return;
            
            // Si ya terminamos todos los productos
            if (data.indexActual >= data.productos.length) {
                finalizarVerificacionGuia();
                return;
            }
            
            const producto = data.productos[data.indexActual];
            const productoInfo = rawProducts.find(p => p.sku === producto.sku);
            const nombreProducto = productoInfo ? productoInfo.name : producto.descripcion;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const progreso = ((data.indexActual + 1) / data.productos.length * 100).toFixed(0);
            
            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #64748b;">Producto ${data.indexActual + 1} de ${data.productos.length}</span>
                        <span style="font-size: 12px; font-weight: 600; color: #059669;">${progreso}%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${progreso}%; height: 100%; background: linear-gradient(90deg, #059669, #10b981); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">SKU ${producto.sku}</div>
                    <div style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 15px; line-height: 1.4;">${nombreProducto}</div>
                    
                    <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid #e2e8f0;">
                        <div style="font-size: 13px; color: #64748b; margin-bottom: 5px;">Cantidad esperada seg√∫n gu√≠a</div>
                        <div style="font-size: 42px; font-weight: 800; color: #1e293b;">${producto.cantidadEsperada}</div>
                    </div>
                </div>
                
                <div style="font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 15px; text-align: center;">
                    ¬øRecibi√≥ ${producto.cantidadEsperada} unidades?
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="confirmarCantidadGuia(${producto.cantidadEsperada})" 
                            style="flex: 1; padding: 18px; border: 2px solid #059669; background: #f0fdf4; color: #059669; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer;">
                        S√≠, correcto
                    </button>
                    <button onclick="mostrarInputCantidadDiferente()" 
                            style="flex: 1; padding: 18px; border: 2px solid #dc2626; background: #fef2f2; color: #dc2626; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer;">
                        No, diferente
                    </button>
                </div>
                
                <button onclick="cancelarVerificacionGuia()" 
                        style="width: 100%; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Cancelar verificaci√≥n
                </button>
            `;
            
            modal.querySelector('.modal-title').textContent = `Factura #${data.numeroFactura}`;
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        
        function mostrarInputCantidadDiferente() {
            const data = window.verificacionGuia;
            const producto = data.productos[data.indexActual];
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">SKU ${producto.sku}</div>
                    <div style="font-size: 16px; font-weight: 600; color: #1e293b;">${producto.descripcion}</div>
                </div>
                
                <div style="background: #fef2f2; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #991b1b; margin-bottom: 10px;">Esperado: <strong>${producto.cantidadEsperada}</strong> unidades</div>
                    
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b;">¬øCu√°ntas recibi√≥ realmente?</label>
                    <input type="number" id="inputCantidadReal" min="0" value="0" 
                           style="width: 100%; padding: 15px; border: 2px solid #dc2626; border-radius: 8px; font-size: 24px; font-weight: 700; text-align: center;"
                           autofocus>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="mostrarVerificacionProductoGuia()" 
                            style="flex: 1; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Volver
                    </button>
                    <button onclick="confirmarCantidadDiferente()" 
                            style="flex: 1; padding: 12px; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Confirmar cantidad
                    </button>
                </div>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Cantidad diferente';
            modalContent.innerHTML = html;
            
            // Focus en el input
            setTimeout(() => {
                document.getElementById('inputCantidadReal')?.focus();
                document.getElementById('inputCantidadReal')?.select();
            }, 100);
        }
        
        function confirmarCantidadGuia(cantidad) {
            const data = window.verificacionGuia;
            data.productos[data.indexActual].cantidadRecibida = cantidad;
            data.productos[data.indexActual].verificado = true;
            data.indexActual++;
            
            mostrarVerificacionProductoGuia();
        }
        
        function confirmarCantidadDiferente() {
            const cantidad = parseInt(document.getElementById('inputCantidadReal')?.value) || 0;
            confirmarCantidadGuia(cantidad);
        }
        
        function cancelarVerificacionGuia() {
            if (confirm('¬øCancelar la verificaci√≥n?\n\nSe perder√° el progreso actual.')) {
                window.verificacionGuia = null;
                closeShareModal();
                showToast('Verificaci√≥n cancelada');
            }
        }
        
        function finalizarVerificacionGuia() {
            const data = window.verificacionGuia;
            
            // Calcular totales
            let totalEsperado = 0;
            let totalRecibido = 0;
            let productosOK = 0;
            let productosDiff = 0;
            
            data.productos.forEach(p => {
                totalEsperado += p.cantidadEsperada;
                totalRecibido += p.cantidadRecibida;
                if (p.cantidadRecibida === p.cantidadEsperada) {
                    productosOK++;
                } else {
                    productosDiff++;
                }
            });
            
            // Guardar para firma
            window.recepcionParaFirmar = {
                numeroFactura: data.numeroFactura,
                productos: data.productos.map(p => ({
                    sku: p.sku,
                    descripcion: p.descripcion,
                    esperado: p.cantidadEsperada,
                    recibido: p.cantidadRecibida,
                    diferencia: p.cantidadRecibida - p.cantidadEsperada
                })),
                totalEsperado,
                totalRecibido,
                productosOK,
                productosDiff
            };
            
            // Limpiar verificaci√≥n
            window.verificacionGuia = null;
            
            // Mostrar resumen y firma
            mostrarResumenYFirmaGuia();
        }
        
        function mostrarResumenYFirmaGuia() {
            const data = window.recepcionParaFirmar;
            if (!data) return;
            
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const diferencia = data.totalRecibido - data.totalEsperado;
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${data.productosDiff > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 18px;">Verificaci√≥n Completada</div>
                    <div style="font-size: 14px; color: #64748b; margin-top: 5px;">Factura #${data.numeroFactura}</div>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div style="background: white; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #64748b;">Esperado</div>
                            <div style="font-size: 24px; font-weight: 700;">${data.totalEsperado}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 11px; color: #64748b;">Recibido</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${diferencia === 0 ? '#059669' : '#dc2626'};">${data.totalRecibido}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; text-align: center; padding: 10px; background: ${diferencia === 0 ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
                        <span style="color: ${diferencia === 0 ? '#059669' : '#dc2626'}; font-weight: 600;">
                            Diferencia: ${diferencia >= 0 ? '+' : ''}${diferencia}
                        </span>
                    </div>
                    <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 13px;">
                        <span style="color: #059669;">‚úì Correctos: ${data.productosOK}</span>
                        <span style="color: #dc2626;">‚ö† Diferencias: ${data.productosDiff}</span>
                    </div>
                </div>
                
                ${data.productosDiff > 0 ? `
                <div style="background: #fef2f2; border-radius: 8px; padding: 10px; margin-bottom: 15px; max-height: 120px; overflow-y: auto;">
                    <div style="font-size: 12px; font-weight: 600; color: #991b1b; margin-bottom: 8px;">Productos con diferencia:</div>
                    ${data.productos.filter(p => p.diferencia !== 0).map(p => `
                        <div style="font-size: 11px; color: #7f1d1d; padding: 4px 0; border-bottom: 1px solid #fecaca;">
                            ${p.sku}: esperado ${p.esperado}, recibido ${p.recibido} (${p.diferencia >= 0 ? '+' : ''}${p.diferencia})
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Nombre del receptor:</label>
                    <input type="text" id="inputNombreRecepcion" placeholder="Ingrese su nombre" 
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Firma:</label>
                    <canvas id="canvasFirmaRecepcion" width="300" height="120" 
                            style="width: 100%; height: 120px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; touch-action: none;"></canvas>
                    <button onclick="limpiarCanvasFirma()" style="margin-top: 6px; padding: 6px 12px; background: #e2e8f0; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                
                <button onclick="guardarRecepcionVerificada()" class="btn-cta" style="width: 100%;">
                    Guardar y Exportar
                </button>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Firmar Recepci√≥n';
            modalContent.innerHTML = html;
            
            // Inicializar canvas
            setTimeout(() => initCanvasFirma(), 100);
        }
        
        function initCanvasFirma() {
            const canvas = document.getElementById('canvasFirmaRecepcion');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let drawing = false;
            
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x: x * (canvas.width / rect.width), y: y * (canvas.height / rect.height) };
            };
            
            const start = (e) => { e.preventDefault(); drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); };
            const draw = (e) => { if (!drawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke(); };
            const stop = () => { drawing = false; };
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);
        }
        
        function limpiarCanvasFirma() {
            const canvas = document.getElementById('canvasFirmaRecepcion');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function guardarRecepcionVerificada() {
            const nombre = document.getElementById('inputNombreRecepcion')?.value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirmaRecepcion');
            
            if (!canvas) {
                showToast('‚ùå Error: Canvas no encontrado');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some((channel, i) => i % 4 !== 3 && channel !== 0);
            
            if (!hasDrawing) {
                showToast('‚ö†Ô∏è Por favor dibuje su firma');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            const data = window.recepcionParaFirmar;
            
            const hoy = new Date().toISOString().split('T')[0];
            const conteo = {
                id: `Recepcion_${data.numeroFactura}_${Date.now()}`,
                tipo: `Recepci√≥n Gu√≠a #${data.numeroFactura}`,
                fecha: hoy,
                nombre: nombre,
                firma: firmaDataURL,
                numeroGuia: data.numeroFactura,
                datos: {},
                productosDetalle: data.productos,
                totalEsperado: data.totalEsperado,
                totalRecibido: data.totalRecibido,
                productosOK: data.productosOK,
                productosDiff: data.productosDiff,
                timestamp: new Date().getTime()
            };
            
            // Guardar datos
            data.productos.forEach(p => {
                conteo.datos[p.sku] = p.recibido;
            });
            
            // Guardar en historial
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            historial.unshift(conteo);
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = conteo;
            window.recepcionParaFirmar = null;
            
            showToast('‚úÖ Recepci√≥n guardada');
            closeShareModal();
            
            setTimeout(() => {
                mostrarModalExportarConteo();
            }, 200);
        }
        
        function renderProductsGuia() {
            const container = document.getElementById('productsContainer');
            const ctaContainer = document.getElementById('ctaContainer');
            
            if (!container) return;
            
            const productosGuia = window.productosGuiaActual || [];
            const cantidadesEsperadas = window.cantidadesEsperadas || {};
            
            if (productosGuia.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay productos en la gu√≠a</div>';
                return;
            }
            
            // Filtrar solo productos de la gu√≠a
            const filtered = rawProducts.filter(p => productosGuia.includes(p.sku));
            
            // Header con info de la gu√≠a
            let headerHtml = `
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #86efac;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: #166534; font-size: 14px;">Factura #${currentDocNumber}</div>
                            <div style="font-size: 12px; color: #15803d; margin-top: 2px;">${filtered.length} productos por verificar</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 11px; color: #166534;">Esperado</div>
                            <div style="font-weight: 700; color: #166534; font-size: 18px;">${Object.values(cantidadesEsperadas).reduce((a,b) => a+b, 0)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = headerHtml + filtered.map(p => {
                const qtyRecibida = dataReception[p.sku] || 0;
                const qtyEsperada = cantidadesEsperadas[p.sku] || 0;
                const diferencia = qtyRecibida - qtyEsperada;
                
                let statusClass = '';
                let statusIcon = '';
                if (qtyRecibida === 0) {
                    statusClass = 'pending';
                    statusIcon = '‚è≥';
                } else if (qtyRecibida === qtyEsperada) {
                    statusClass = 'ok';
                    statusIcon = '‚úì';
                } else {
                    statusClass = 'diff';
                    statusIcon = '‚ö†Ô∏è';
                }
                
                return `
                    <div class="product-card reception-counted" style="border-left-color: ${statusClass === 'ok' ? '#059669' : statusClass === 'diff' ? '#dc2626' : '#94a3b8'};">
                        <div class="product-info">
                            <h4>${p.name}</h4>
                            <div class="product-sku">SKU: ${p.sku}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                Esperado: <strong>${qtyEsperada}</strong>
                                ${qtyRecibida > 0 ? ` | Diferencia: <strong style="color: ${diferencia === 0 ? '#059669' : '#dc2626'}">${diferencia >= 0 ? '+' : ''}${diferencia}</strong>` : ''}
                            </div>
                        </div>
                        <div class="stock-control reception-mode" onclick="event.stopPropagation()">
                            <button class="btn-stock" onclick="modificarRecepcion('${p.sku}', -1)">-</button>
                            <input class="stock-input" value="${qtyRecibida}" onchange="setRecepcion('${p.sku}', this.value)" type="number" min="0">
                            <button class="btn-stock" onclick="modificarRecepcion('${p.sku}', 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Bot√≥n finalizar
            ctaContainer.innerHTML = `
                <button class="btn-cta" onclick="finalizarRecepcionGuia()" style="width: 100%;">
                    ‚úÖ Finalizar Recepci√≥n
                </button>
                <button class="btn-cta secondary" onclick="volverARecepcionNormal()" style="width: 100%; margin-top: 10px;">
                    Volver
                </button>
            `;
        }
        
        function modificarRecepcion(sku, delta) {
            const current = dataReception[sku] || 0;
            dataReception[sku] = Math.max(0, current + delta);
            saveData();
            renderProductsGuia();
        }
        
        function setRecepcion(sku, value) {
            dataReception[sku] = Math.max(0, parseInt(value) || 0);
            saveData();
            renderProductsGuia();
        }
        
        function volverARecepcionNormal() {
            window.productosGuiaActual = null;
            window.cantidadesEsperadas = null;
            window.filtrarSoloGuia = false;
            dataReception = {};
            currentDocNumber = '';
            saveData();
            renderProducts();
            showToast('Recepci√≥n cancelada');
        }
        
        function finalizarRecepcionGuia() {
            const productosGuia = window.productosGuiaActual || [];
            const cantidadesEsperadas = window.cantidadesEsperadas || {};
            
            if (productosGuia.length === 0) {
                showToast('‚ùå No hay productos para finalizar');
                return;
            }
            
            // Preparar resumen
            let totalEsperado = 0;
            let totalRecibido = 0;
            let productosOK = 0;
            let productosDiff = 0;
            
            productosGuia.forEach(sku => {
                const esperado = cantidadesEsperadas[sku] || 0;
                const recibido = dataReception[sku] || 0;
                totalEsperado += esperado;
                totalRecibido += recibido;
                if (recibido === esperado) productosOK++;
                else productosDiff++;
            });
            
            // Guardar datos para la firma
            window.recepcionParaFirmar = {
                numeroFactura: currentDocNumber,
                productos: productosGuia.map(sku => ({
                    sku: sku,
                    esperado: cantidadesEsperadas[sku] || 0,
                    recibido: dataReception[sku] || 0,
                    diferencia: (dataReception[sku] || 0) - (cantidadesEsperadas[sku] || 0)
                })),
                totalEsperado,
                totalRecibido,
                productosOK,
                productosDiff
            };
            
            // Mostrar modal de firma
            mostrarModalFirmaRecepcionGuia();
        }
        
        function mostrarModalFirmaRecepcionGuia() {
            const data = window.recepcionParaFirmar;
            if (!data) return;
            
            const modal = document.getElementById('firmaModal');
            const modalContent = document.getElementById('firmaModalContent');
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${data.productosDiff > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                    <div style="font-weight: 700; color: #1e293b; font-size: 18px;">Resumen Recepci√≥n</div>
                    <div style="font-size: 14px; color: #64748b; margin-top: 5px;">Factura #${data.numeroFactura}</div>
                </div>
                
                <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #64748b;">Total esperado:</span>
                        <span style="font-weight: 700;">${data.totalEsperado}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #64748b;">Total recibido:</span>
                        <span style="font-weight: 700;">${data.totalRecibido}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: #64748b;">Diferencia:</span>
                        <span style="font-weight: 700; color: ${data.totalRecibido - data.totalEsperado === 0 ? '#059669' : '#dc2626'};">
                            ${data.totalRecibido - data.totalEsperado >= 0 ? '+' : ''}${data.totalRecibido - data.totalEsperado}
                        </span>
                    </div>
                    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #059669;">‚úì Correctos: ${data.productosOK}</span>
                        <span style="color: #dc2626;">‚ö† Con diferencia: ${data.productosDiff}</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Nombre del receptor:</label>
                    <input type="text" id="inputNombreRecepcion" placeholder="Ingrese su nombre" 
                           style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px;">Firma:</label>
                    <canvas id="canvasFirmaRecepcion" width="300" height="150" 
                            style="width: 100%; border: 1px solid #e2e8f0; border-radius: 8px; background: white; touch-action: none;"></canvas>
                    <button onclick="limpiarFirmaRecepcion()" style="margin-top: 8px; padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        üóëÔ∏è Limpiar firma
                    </button>
                </div>
                
                <button onclick="guardarRecepcionFirmada()" class="btn-cta" style="width: 100%;">
                    Guardar y Exportar
                </button>
            `;
            
            modal.querySelector('.modal-title').textContent = 'Firmar Recepci√≥n';
            modalContent.innerHTML = html;
            modal.classList.add('active');
            
            // Inicializar canvas de firma
            setTimeout(() => {
                initCanvasFirmaRecepcion();
            }, 100);
        }
        
        function initCanvasFirmaRecepcion() {
            const canvas = document.getElementById('canvasFirmaRecepcion');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let drawing = false;
            
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x: x * (canvas.width / rect.width), y: y * (canvas.height / rect.height) };
            };
            
            const start = (e) => {
                e.preventDefault();
                drawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            };
            
            const draw = (e) => {
                if (!drawing) return;
                e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.stroke();
            };
            
            const stop = () => { drawing = false; };
            
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stop);
        }
        
        function limpiarFirmaRecepcion() {
            const canvas = document.getElementById('canvasFirmaRecepcion');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        function guardarRecepcionFirmada() {
            const nombre = document.getElementById('inputNombreRecepcion')?.value || 'Sin nombre';
            const canvas = document.getElementById('canvasFirmaRecepcion');
            
            if (!canvas) {
                showToast('‚ùå Error: No se encontr√≥ el canvas');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some((channel, i) => i % 4 !== 3 && channel !== 0);
            
            if (!hasDrawing) {
                showToast('‚ö†Ô∏è Por favor dibuje su firma');
                return;
            }
            
            const firmaDataURL = canvas.toDataURL('image/png');
            const data = window.recepcionParaFirmar;
            
            const hoy = new Date().toISOString().split('T')[0];
            const conteo = {
                id: `Recepcion_${data.numeroFactura}_${Date.now()}`,
                tipo: `Recepci√≥n Gu√≠a #${data.numeroFactura}`,
                fecha: hoy,
                nombre: nombre,
                firma: firmaDataURL,
                numeroGuia: data.numeroFactura,
                datos: {},
                productosDetalle: data.productos,
                totalEsperado: data.totalEsperado,
                totalRecibido: data.totalRecibido,
                timestamp: new Date().getTime()
            };
            
            // Guardar datos de recepci√≥n
            data.productos.forEach(p => {
                conteo.datos[p.sku] = p.recibido;
            });
            
            // Guardar en historial
            let historial = JSON.parse(localStorage.getItem('historial_conteos')) || [];
            historial.unshift(conteo);
            localStorage.setItem('historial_conteos', JSON.stringify(historial));
            
            conteoActualGuardado = conteo;
            
            // Limpiar estado
            window.productosGuiaActual = null;
            window.cantidadesEsperadas = null;
            window.recepcionParaFirmar = null;
            dataReception = {};
            currentDocNumber = '';
            saveData();
            
            showToast('‚úÖ Recepci√≥n guardada');
            
            // Cerrar modal de firma y mostrar opciones de exportaci√≥n
            document.getElementById('firmaModal').classList.remove('active');
            setTimeout(() => {
                mostrarModalExportarConteo();
            }, 200);
        }
        
        function aplicarImportacionAutomatica(tipo, fecha, numeroGuia, responsable, productos) {
            if (tipo.includes('Inventario')) {
                dataCount = {};
                productos.forEach(p => {
                    dataCount[p.sku] = p.cantidad;
                });
                currentBrand = 'Todos';
                mainView = 'inventory';
                switchMainView('inventory');
                saveData();
                renderProducts();
                showToast(`‚úÖ Inventario del ${fecha} cargado`);
            } else if (tipo.includes('Recepci√≥n')) {
                dataReception = {};
                productos.forEach(p => {
                    dataReception[p.sku] = p.cantidad;
                });
                currentDocNumber = numeroGuia;
                currentBrand = 'Todos';
                mainView = 'reception';
                switchMainView('reception');
                saveData();
                renderProducts();
                showToast(`‚úÖ Recepci√≥n ${numeroGuia} cargada`);
            }
        }

        function mostrarResumenImportacion(numeroGuia, fecha, productos) {
            const modal = document.getElementById('shareModal');
            const modalContent = modal.querySelector('.modal-content');
            
            const conDiferencias = productos.filter(p => p.diferencia !== 0);
            const faltantes = productos.filter(p => p.diferencia < 0);
            const extras = productos.filter(p => p.diferencia > 0);
            
            let html = `
                <h3 class="modal-title">üìä Recepci√≥n Importada</h3>
                
                <div style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px solid #38bdf8; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #075985; font-weight: 600; margin-bottom: 3px;">N¬∫ GU√çA</div>
                    <div style="font-size: 24px; font-weight: 700; color: #0369a1; letter-spacing: 1px;">${numeroGuia}</div>
                    <div style="font-size: 11px; color: #0c4a6e; margin-top: 5px;">Fecha: ${fecha}</div>
                </div>
                
                <div style="background: #f0fdf4; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #166534; font-weight: 600;">Total productos:</span>
                        <span style="color: #166534; font-weight: 700; font-size: 18px;">${productos.length}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #166534; font-weight: 600;">Productos OK:</span>
                        <span style="color: #059669; font-weight: 700; font-size: 18px;">‚úì ${productos.length - conDiferencias.length}</span>
                    </div>
            `;
            
            if (conDiferencias.length > 0) {
                html += `
                    <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #86efac;">
                        <span style="color: #dc2626; font-weight: 600;">Con diferencias:</span>
                        <span style="color: #dc2626; font-weight: 700; font-size: 18px;">‚ö†Ô∏è ${conDiferencias.length}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (faltantes.length > 0) {
                html += '<div style="background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 6px; padding: 12px; margin-bottom: 10px;">';
                html += '<div style="font-weight: 700; color: #991b1b; margin-bottom: 8px;">‚ùå FALTANTES:</div>';
                faltantes.forEach(p => {
                    html += `
                        <div style="font-size: 12px; color: #7f1d1d; margin-bottom: 4px;">
                            ‚Ä¢ SKU ${p.sku}: ${p.diferencia} unidades (${p.descripcion.substring(0, 40)}...)
                            ${p.comentario ? `<br><span style="color: #64748b; font-style: italic;">üí¨ ${p.comentario}</span>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            if (extras.length > 0) {
                html += '<div style="background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 10px;">';
                html += '<div style="font-weight: 700; color: #1e40af; margin-bottom: 8px;">üì¶ EXTRAS:</div>';
                extras.forEach(p => {
                    html += `
                        <div style="font-size: 12px; color: #1e3a8a; margin-bottom: 4px;">
                            ‚Ä¢ SKU ${p.sku}: +${p.diferencia} unidades (${p.descripcion.substring(0, 40)}...)
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            const productosEscaped = JSON.stringify(productos).replace(/"/g, '&quot;');
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-cta" onclick='aplicarImportacion("${numeroGuia}", ${productosEscaped})' style="flex: 1;">
                        ‚úÖ Aplicar a Recepci√≥n
                    </button>
                    <button class="btn-cta secondary" onclick="closeShareModal()" style="flex: 1;">
                        Cancelar
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }

        function aplicarImportacion(numeroGuia, productos) {
            currentDocNumber = numeroGuia;
            
            dataReception = {};
            
            productos.forEach(p => {
                dataReception[p.sku] = p.cantRecep;
            });
            
            saveData();
            renderProducts();
            closeShareModal();
            
            showToast(`‚úÖ Recepci√≥n ${numeroGuia} aplicada correctamente`);
        }
        let recepcionActual = {
    numeroGuia: '',
    productos: [],
    index: 0,
    verificados: []
};

function iniciarRecepcionGuia() {
    // Obtener datos de la variable global
    if (!window.tempRecepcionData) {
        showToast('‚ùå Error: No se encontraron datos');
        return;
    }
    
    const { productos, numeroGuia, numeroFactura } = window.tempRecepcionData;
    
    recepcionActual = {
        numeroGuia: numeroFactura || numeroGuia,
        productos: productos,
        index: 0,
        verificados: []
    };
    
    currentDocNumber = numeroFactura || numeroGuia;
    const docInput = document.getElementById('docNumberInput');
    if (docInput) docInput.value = currentDocNumber;
    
    // Cerrar modal actual y esperar un momento antes de mostrar el siguiente
    closeShareModal();
    setTimeout(() => {
        mostrarVerificacionProducto();
    }, 100);
}

function mostrarVerificacionProducto() {
    if (recepcionActual.index >= recepcionActual.productos.length) {
        mostrarPantallaFirma();
        return;
    }
    
    const prod = recepcionActual.productos[recepcionActual.index];
    const productoExiste = rawProducts.find(p => p.sku === prod.codigo);
    
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">Producto ${recepcionActual.index + 1} de ${recepcionActual.productos.length}</div>
            <div style="width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden;">
                <div style="width: ${((recepcionActual.index + 1) / recepcionActual.productos.length) * 100}%; height: 100%; background: #059669; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">SKU ${prod.codigo}</div>
            <div style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 15px;">${prod.descripcion}</div>
            
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="font-size: 13px; color: #64748b; margin-bottom: 5px;">Cantidad seg√∫n gu√≠a</div>
                <div style="font-size: 32px; font-weight: 700; color: #1e293b;">${prod.cantidad}</div>
            </div>
            
            <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 10px;">¬øRecibi√≥ esta cantidad?</div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="verificarProducto(${prod.cantidad}, true)" style="flex: 1; padding: 15px; border: 2px solid #059669; background: #f0fdf4; color: #059669; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer;">
                    S√≠
                </button>
                <button onclick="mostrarAjustarCantidad()" style="flex: 1; padding: 15px; border: 2px solid #dc2626; background: #fef2f2; color: #dc2626; border-radius: 8px; font-weight: 600; font-size: 15px; cursor: pointer;">
                    ‚úï No
                </button>
            </div>
        </div>
    `;
    
    modalContent.innerHTML = html;
    modal.classList.add('active');
}

function verificarProducto(cantidad, correcto) {
    const prod = recepcionActual.productos[recepcionActual.index];
    
    recepcionActual.verificados.push({
        sku: prod.codigo,
        descripcion: prod.descripcion,
        cantidadGuia: prod.cantidad,
        cantidadRecibida: cantidad,
        correcto: correcto
    });
    
    // Aplicar a dataReception
    dataReception[prod.codigo] = cantidad;
    saveData();
    
    recepcionActual.index++;
    mostrarVerificacionProducto();
}

function mostrarAjustarCantidad() {
    const prod = recepcionActual.productos[recepcionActual.index];
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: 700; color: #1e293b;">Ajustar Cantidad</div>
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #64748b; margin-bottom: 10px;">Cantidad recibida real</div>
            
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px;">
                <button onclick="ajustarCantidadTemp(-1)" style="width: 50px; height: 50px; border: 2px solid #e2e8f0; background: white; border-radius: 8px; font-size: 24px; font-weight: 700; color: #1e293b; cursor: pointer;">‚àí</button>
                <input type="number" id="cantidadAjustada" value="${prod.cantidad}" style="width: 80px; height: 50px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 24px; font-weight: 700; color: #1e293b;">
                <button onclick="ajustarCantidadTemp(1)" style="width: 50px; height: 50px; border: 2px solid #e2e8f0; background: white; border-radius: 8px; font-size: 24px; font-weight: 700; color: #1e293b; cursor: pointer;">+</button>
            </div>
            
            <button onclick="confirmarCantidadAjustada()" class="btn-cta" style="width: 100%;">
                Confirmar Cantidad
            </button>
        </div>
    `;
    
    modalContent.innerHTML = html;
}

function ajustarCantidadTemp(delta) {
    const input = document.getElementById('cantidadAjustada');
    const newVal = Math.max(0, parseInt(input.value) + delta);
    input.value = newVal;
}

function confirmarCantidadAjustada() {
    const cantidad = parseInt(document.getElementById('cantidadAjustada').value);
    verificarProducto(cantidad, false);
}


function mostrarPantallaFirma() {
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    const totalOK = recepcionActual.verificados.filter(v => v.correcto).length;
    const totalDiff = recepcionActual.verificados.filter(v => !v.correcto).length;
    
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 10px;">Firma de Recepci√≥n</div>
        </div>
        
        <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #64748b;">Productos OK:</span>
                <span style="font-weight: 700; color: #059669;">‚úì ${totalOK}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b;">Con diferencias:</span>
                <span style="font-weight: 700; color: #dc2626;">‚ö†Ô∏è ${totalDiff}</span>
            </div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 10px;">Firme aqu√≠:</div>
            <canvas id="signatureCanvas" style="width: 100%; height: 200px; border: 2px dashed #e2e8f0; border-radius: 8px; background: white; cursor: crosshair;"></canvas>
            <div style="text-align: center; margin-top: 10px;">
                <button onclick="limpiarFirma()" style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; font-size: 13px; color: #64748b; cursor: pointer;">
                    üîÑ Limpiar Firma
                </button>
            </div>
        </div>
        
        <button class="btn-cta" onclick="finalizarRecepcionConFirma()" style="width: 100%;">
            üìÑ Generar PDF Firmado
        </button>
    `;
    
    modalContent.innerHTML = html;
    
    // ‚ö†Ô∏è IMPORTANTE: Inicializar canvas DESPU√âS de insertar HTML
    setTimeout(() => {
        inicializarCanvasFirma();
    }, 100);
}

async function finalizarRecepcionConFirma() {
    const canvas = document.getElementById('signatureCanvas');
    
    if (!canvas) {
        showToast('‚ùå Error: Canvas no encontrado');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const hasDrawing = imageData.data.some(channel => channel !== 0);
    
    if (!hasDrawing) {
        showToast('‚ö†Ô∏è Por favor dibuje su firma');
        return;
    }
    
    const firmaDataURL = canvas.toDataURL('image/png');
    
    showToast('üìÑ Generando PDF formato Kitchen Center...');
    
    if (!window.jspdf) {
        showToast('‚è≥ Cargando librer√≠a PDF...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        await new Promise(resolve => {
            script.onload = resolve;
            document.head.appendChild(script);
        });
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const data = window.tempRecepcionData || {};
    
    // HEADER KITCHEN CENTER
    doc.setFillColor(74, 4, 4);
    doc.rect(0, 0, 210, 20, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('KITCHEN CENTER', 105, 13, { align: 'center' });
    
    // INFO DOCUMENTO
    let y = 30;
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(`INGRESO ORDEN DE COMPRA FOLIO [ ${data.folio || '---'} ]`, 105, y, { align: 'center' });
    
    y += 10;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Fecha Orden de Compra: ${data.fechaOrden || new Date().toLocaleDateString('es-CL')}`, 20, y);
    
    y += 6;
    const tiendaText = data.tienda || 'COQUINARIA PARQUE ARAUCO';
    doc.text(`Tienda: ${tiendaText.substring(0, 70)}`, 20, y);
    
    y += 6;
    doc.text(`Factura: ${data.numeroFactura || '---'}`, 20, y);
    doc.text(`Fecha Factura: ${data.fechaFactura || new Date().toLocaleDateString('es-CL')}`, 110, y);
    
    // TABLA DE PRODUCTOS
    y += 10;
    
    // Headers
    doc.setFillColor(240, 240, 240);
    doc.rect(15, y, 180, 8, 'F');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.text('C√≥digo', 17, y + 5);
    doc.text('Descripci√≥n', 40, y + 5);
    doc.text('Cant.', 120, y + 5);
    doc.text('Recep.', 140, y + 5);
    doc.text('Dif.', 162, y + 5);
    doc.text('Estado', 175, y + 5);
    
    y += 10;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    
    // Productos
    recepcionActual.verificados.forEach((item, i) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
            
            // Repetir headers
            doc.setFillColor(240, 240, 240);
            doc.rect(15, y, 180, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('C√≥digo', 17, y + 5);
            doc.text('Descripci√≥n', 40, y + 5);
            doc.text('Cant.', 120, y + 5);
            doc.text('Recep.', 140, y + 5);
            doc.text('Dif.', 162, y + 5);
            doc.text('Estado', 175, y + 5);
            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
        }
        
        // Alternar color
        if (i % 2 === 0) {
            doc.setFillColor(250, 250, 250);
            doc.rect(15, y - 3, 180, 10, 'F');
        }
        
        doc.text(item.sku, 17, y + 3);
        
        const descripcionCorta = item.descripcion.length > 45 
            ? item.descripcion.substring(0, 45) + '...' 
            : item.descripcion;
        doc.text(descripcionCorta, 40, y + 3);
        
        doc.text(item.cantidadGuia.toString(), 125, y + 3, { align: 'right' });
        doc.text(item.cantidadRecibida.toString(), 145, y + 3, { align: 'right' });
        
        const diferencia = item.cantidadRecibida - item.cantidadGuia;
        const diferenciaTexto = diferencia === 0 ? '0' : (diferencia > 0 ? `+${diferencia}` : diferencia.toString());
        
        if (diferencia !== 0) {
            doc.setTextColor(diferencia > 0 ? 0 : 220, diferencia > 0 ? 100 : 38, diferencia > 0 ? 200 : 38);
        }
        doc.text(diferenciaTexto, 167, y + 3, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        
        const estado = item.correcto ? '‚úì' : '‚ö†';
        const estadoColor = item.correcto ? [5, 150, 105] : [220, 38, 38];
        doc.setTextColor(...estadoColor);
        doc.setFont('helvetica', 'bold');
        doc.text(estado, 177, y + 3);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(0, 0, 0);
        
        y += 10;
    });
    
    // TOTALES
    y += 5;
    doc.setDrawColor(200, 200, 200);
    doc.line(15, y, 195, y);
    y += 8;
    
    const totalOK = recepcionActual.verificados.filter(v => v.correcto).length;
    const totalDiff = recepcionActual.verificados.filter(v => !v.correcto).length;
    const totalUnidades = recepcionActual.verificados.reduce((sum, v) => sum + v.cantidadGuia, 0);
    const totalRecibidas = recepcionActual.verificados.reduce((sum, v) => sum + v.cantidadRecibida, 0);
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('RESUMEN DE RECEPCI√ìN:', 20, y);
    
    y += 7;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text(`Total productos: ${recepcionActual.verificados.length}`, 20, y);
    doc.setTextColor(5, 150, 105);
    doc.text(`Productos OK: ${totalOK}`, 80, y);
    doc.setTextColor(220, 38, 38);
    doc.text(`Con diferencias: ${totalDiff}`, 130, y);
    
    y += 6;
    doc.setTextColor(0, 0, 0);
    doc.text(`Total unidades gu√≠a: ${totalUnidades}`, 20, y);
    doc.text(`Total recibidas: ${totalRecibidas}`, 80, y);
    
    const diferenciaTotal = totalRecibidas - totalUnidades;
    if (diferenciaTotal !== 0) {
        doc.setTextColor(diferenciaTotal > 0 ? 0 : 220, diferenciaTotal > 0 ? 100 : 38, diferenciaTotal > 0 ? 200 : 38);
        doc.text(`Diferencia: ${diferenciaTotal > 0 ? '+' : ''}${diferenciaTotal}`, 130, y);
    }
    
    // FIRMA
    y += 15;
    if (y > 240) {
        doc.addPage();
        y = 20;
    }
    
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('FIRMA DE RECEPCI√ìN:', 20, y);
    
    y += 5;
    doc.addImage(firmaDataURL, 'PNG', 20, y, 70, 25);
    
    y += 27;
    doc.setDrawColor(0, 0, 0);
    doc.line(20, y, 90, y);
    
    y += 5;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.text(`Recepcionado por: _______________________`, 20, y);
    
    y += 5;
    doc.text(`Fecha y hora: ${new Date().toLocaleString('es-CL')}`, 20, y);
    
    // FOOTER
    doc.setFontSize(7);
    doc.setTextColor(100, 100, 100);
    doc.text('Proveedor: 96999930-7 KITCHEN CENTER SPA', 20, 285);
    doc.text('Documento generado por Sistema Coquinaria', 105, 285, { align: 'center' });
    
    // GUARDAR
    const fileName = `KC_Factura_${data.numeroFactura}_${new Date().toISOString().split('T')[0]}_FIRMADO.pdf`;
    doc.save(fileName);
    
    showToast('‚úÖ PDF formato Kitchen Center descargado');
    
    setTimeout(() => {
        closeShareModal();
        renderProducts();
    }, 1000);
}

// ============================================
// GESTI√ìN DE CAT√ÅLOGO
// ============================================
function mostrarModalAgregarProducto() {
    const modal = document.getElementById('shareModal');
    const modalContent = modal.querySelector('.modal-content');
    
    let html = `
        <div style="margin-bottom: 20px;">
            <div style="font-size: 14px; color: #64748b; margin-bottom: 15px;">Complete los datos del nuevo producto:</div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">SKU *</label>
                <input type="text" id="nuevoSku" placeholder="Ej: 80500" 
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Nombre del producto *</label>
                <input type="text" id="nuevoNombre" placeholder="Nombre del producto" 
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Marca</label>
                <input type="text" id="nuevaMarca" placeholder="Marca (opcional)" 
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px;">Descripci√≥n</label>
                <textarea id="nuevaDescripcion" placeholder="Descripci√≥n del producto (opcional)" rows="3"
                          style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="closeShareModal()" 
                    style="flex: 1; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Cancelar
            </button>
            <button onclick="agregarProducto()" 
                    style="flex: 1; padding: 12px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                ‚ûï Agregar
            </button>
        </div>
    `;
    
    modal.querySelector('.modal-title').textContent = 'Agregar Producto';
    modalContent.innerHTML = html;
    modal.classList.add('active');
}

function agregarProducto() {
    const sku = document.getElementById('nuevoSku')?.value.trim();
    const nombre = document.getElementById('nuevoNombre')?.value.trim();
    const marca = document.getElementById('nuevaMarca')?.value.trim() || 'Sin marca';
    const descripcion = document.getElementById('nuevaDescripcion')?.value.trim() || '';
    
    if (!sku || !nombre) {
        showToast('‚ö†Ô∏è SKU y nombre son obligatorios');
        return;
    }
    
    // Verificar si ya existe
    if (rawProducts.find(p => p.sku === sku)) {
        showToast('‚ùå Ya existe un producto con ese SKU');
        return;
    }
    
    // Agregar al cat√°logo
    const nuevoProducto = {
        sku: sku,
        name: nombre,
        brand: marca,
        descripcion: descripcion
    };
    
    rawProducts.push(nuevoProducto);
    
    // Guardar en localStorage
    guardarCatalogoLocal();
    
    closeShareModal();
    renderProducts();
    showToast(`‚úÖ Producto ${sku} agregado`);
}

function guardarCatalogoLocal() {
    localStorage.setItem('catalogo_productos', JSON.stringify(rawProducts));
}

// ============================================
// GOOGLE SHEETS - SINCRONIZACI√ìN
// ============================================

function initGoogleAPI() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: (response) => {
            if (response.error) {
                console.error('Error OAuth:', response);
                showToast('Error de autenticaci√≥n');
                return;
            }
            googleToken = response.access_token;
            localStorage.setItem('googleToken', googleToken);
            showToast('Conectado a Google');
            sincronizarCatalogoDesdeSheets();
        },
    });
}

function conectarGoogle() {
    if (!tokenClient) {
        initGoogleAPI();
    }
    tokenClient.requestAccessToken();
}

async function sincronizarCatalogoDesdeSheets() {
    const token = googleToken || localStorage.getItem('googleToken');
    
    if (!token) {
        // Mostrar modal para conectar
        const modal = document.getElementById('shareModal');
        const modalContent = modal.querySelector('.modal-content');
        
        modalContent.innerHTML = `
            <h3 class="modal-title">Conectar con Google</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚òÅÔ∏è</div>
                <div style="font-size: 14px; color: #1e293b; margin-bottom: 10px;">
                    Conecta tu cuenta de Google para sincronizar el cat√°logo desde la nube
                </div>
                <div style="font-size: 12px; color: #64748b;">
                    Solo necesitas hacerlo una vez
                </div>
            </div>
            <button onclick="conectarGoogle(); closeShareModal();" class="btn-cta" style="width: 100%;">
                Conectar Google
            </button>
            <button onclick="closeShareModal()" style="width: 100%; margin-top: 10px; padding: 12px; background: #e2e8f0; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Cancelar
            </button>
        `;
        modal.classList.add('active');
        return;
    }
    
    mostrarLoading();
    
    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A:E`,
            {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        if (response.status === 401) {
            localStorage.removeItem('googleToken');
            googleToken = null;
            ocultarLoading();
            showToast('Sesi√≥n expirada, conecta de nuevo');
            return;
        }
        
        if (!response.ok) {
            throw new Error('Error al obtener datos');
        }
        
        const data = await response.json();
        const rows = data.values;
        
        if (!rows || rows.length < 2) {
            ocultarLoading();
            showToast('La hoja est√° vac√≠a');
            return;
        }
        
        // Convertir filas a productos (saltar encabezado)
        const productosNuevos = [];
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row[0]) { // Si tiene SKU
                productosNuevos.push({
                    sku: row[0] || '',
                    brand: row[1] || '',
                    name: row[2] || '',
                    description: row[3] || '',
                    origin: row[4] || ''
                });
            }
        }
        
        if (productosNuevos.length > 0) {
            rawProducts = productosNuevos;
            guardarCatalogoLocal();
            renderProducts();
            ocultarLoading();
            showToast(`Cat√°logo sincronizado: ${productosNuevos.length} productos`);
        } else {
            ocultarLoading();
            showToast('No se encontraron productos');
        }
        
    } catch (error) {
        console.error('Error sincronizando:', error);
        ocultarLoading();
        showToast('Error al sincronizar');
    }
}

function verificarConexionGoogle() {
    const token = localStorage.getItem('googleToken');
    if (token) {
        googleToken = token;
        return true;
    }
    return false;
}

async function subirArchivoDrive(blob, nombreArchivo, folderId) {
    const token = googleToken || localStorage.getItem('googleToken');
    
    if (!token) {
        showToast('Conecta Google para subir a la nube');
        return null;
    }
    
    try {
        const metadata = {
            name: nombreArchivo,
            parents: [folderId]
        };
        
        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        formData.append('file', blob);
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.status === 401) {
            localStorage.removeItem('googleToken');
            googleToken = null;
            showToast('Sesi√≥n expirada, conecta de nuevo');
            return null;
        }
        
        if (!response.ok) {
            throw new Error('Error al subir archivo');
        }
        
        const data = await response.json();
        return data;
        
    } catch (error) {
        console.error('Error subiendo a Drive:', error);
        return null;
    }
}

async function subirRecepcionDrive(blob, nombreArchivo) {
    const resultado = await subirArchivoDrive(blob, nombreArchivo, FOLDER_RECEPCIONES);
    if (resultado) {
        showToast('Recepci√≥n subida a Drive');
    }
    return resultado;
}

async function subirInventarioDrive(blob, nombreArchivo) {
    const resultado = await subirArchivoDrive(blob, nombreArchivo, FOLDER_INVENTARIOS);
    if (resultado) {
        showToast('Inventario subido a Drive');
    }
    return resultado;
}

async function listarArchivosDrive(folderId) {
    const token = googleToken || localStorage.getItem('googleToken');
    
    if (!token) {
        return [];
    }
    
    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&fields=files(id,name,createdTime,modifiedTime)&orderBy=modifiedTime desc`,
            {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }
        );
        
        if (!response.ok) {
            return [];
        }
        
        const data = await response.json();
        return data.files || [];
        
    } catch (error) {
        console.error('Error listando archivos:', error);
        return [];
    }
}

function cargarCatalogoLocal() {
    const catalogoGuardado = localStorage.getItem('catalogo_productos');
    if (catalogoGuardado) {
        try {
            const productos = JSON.parse(catalogoGuardado);
            if (Array.isArray(productos) && productos.length > 0) {
                rawProducts = productos;
            }
        } catch (e) {
            console.error('Error cargando cat√°logo local:', e);
        }
    }
}

async function exportarCatalogo() {
    showToast('üìä Generando Excel del cat√°logo...');
    
    try {
        const XLSX = await cargarLibreriaXLSX();
        
        const data = rawProducts.map(p => ({
            'SKU': p.sku,
            'Nombre': p.name,
            'Marca': p.brand || '',
            'Descripci√≥n': p.descripcion || ''
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        
        ws['!cols'] = [
            { wch: 10 },  // SKU
            { wch: 50 },  // Nombre
            { wch: 20 },  // Marca
            { wch: 60 }   // Descripci√≥n
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Cat√°logo');
        
        const fileName = `Catalogo_Coquinaria_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showToast('‚úÖ Cat√°logo exportado');
    } catch (error) {
        console.error('Error exportando:', error);
        showToast('‚ùå Error al exportar');
    }
}

async function importarCatalogo(file) {
    if (!file) return;
    
    showToast('üìÇ Importando cat√°logo...');
    
    try {
        if (file.name.endsWith('.json')) {
            // Importar JSON
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const productos = JSON.parse(e.target.result);
                    if (Array.isArray(productos)) {
                        rawProducts = productos;
                        guardarCatalogoLocal();
                        renderProducts();
                        showToast(`‚úÖ ${productos.length} productos importados`);
                    }
                } catch (err) {
                    showToast('‚ùå Error en formato JSON');
                }
            };
            reader.readAsText(file);
        } else {
            // Importar Excel
            const XLSX = await cargarLibreriaXLSX();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws);
                    
                    const productosImportados = jsonData.map(row => ({
                        sku: (row['SKU'] || row['sku'] || row['Codigo'] || row['codigo'] || '').toString(),
                        name: row['Nombre'] || row['nombre'] || row['Producto'] || row['producto'] || '',
                        brand: row['Marca'] || row['marca'] || '',
                        descripcion: row['Descripci√≥n'] || row['descripcion'] || row['Descripcion'] || ''
                    })).filter(p => p.sku && p.name);
                    
                    if (productosImportados.length > 0) {
                        // Preguntar si reemplazar o agregar
                        if (confirm(`Se encontraron ${productosImportados.length} productos.\n\n¬øReemplazar cat√°logo completo?\n\nS√≠ = Reemplazar todo\nNo = Agregar a existentes`)) {
                            rawProducts = productosImportados;
                        } else {
                            // Agregar solo los nuevos
                            let agregados = 0;
                            productosImportados.forEach(p => {
                                if (!rawProducts.find(existing => existing.sku === p.sku)) {
                                    rawProducts.push(p);
                                    agregados++;
                                }
                            });
                            showToast(`‚úÖ ${agregados} productos nuevos agregados`);
                        }
                        guardarCatalogoLocal();
                        renderBrandFilters(document.getElementById('toolbarMenu'));
                        renderProducts();
                        showToast(`‚úÖ Cat√°logo actualizado`);
                    } else {
                        showToast('‚ö†Ô∏è No se encontraron productos v√°lidos');
                    }
                } catch (err) {
                    console.error('Error:', err);
                    showToast('‚ùå Error al procesar Excel');
                }
            };
            reader.readAsArrayBuffer(file);
        }
    } catch (error) {
        console.error('Error importando:', error);
        showToast('‚ùå Error al importar');
    }
    
    // Limpiar input
    document.getElementById('importCatalogo').value = '';
}

async function importarGuiaDesdeExcel(file) {
    if (!file) return;
    
    showToast('üìÇ Leyendo gu√≠a Excel...');
    
    try {
        const XLSX = await cargarLibreriaXLSX();
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws);
                
                // Buscar productos con SKU que empiecen con 80
                const productos = [];
                let numeroGuia = '';
                
                jsonData.forEach(row => {
                    // Buscar n√∫mero de gu√≠a/factura
                    Object.values(row).forEach(val => {
                        if (typeof val === 'string' && val.match(/\d{7,}/)) {
                            if (!numeroGuia) numeroGuia = val.match(/\d{7,}/)[0];
                        }
                    });
                    
                    // Buscar SKU y cantidad
                    const sku = (row['SKU'] || row['sku'] || row['Codigo'] || row['codigo'] || row['C√≥digo'] || '').toString();
                    const cantidad = parseInt(row['Cantidad'] || row['cantidad'] || row['Cant'] || row['Unidades'] || 0);
                    const descripcion = row['Descripcion'] || row['descripcion'] || row['Descripci√≥n'] || row['Producto'] || row['producto'] || '';
                    
                    if (sku.startsWith('80') && cantidad > 0) {
                        productos.push({
                            sku: sku,
                            descripcion: descripcion,
                            cantidad: cantidad
                        });
                    }
                });
                
                if (productos.length > 0) {
                    window.tempProductosCargar = {
                        numeroFactura: numeroGuia || 'Excel-' + Date.now(),
                        productos: productos
                    };
                    
                    mostrarConfirmacionProductos(
                        numeroGuia || 'Importado',
                        new Date().toLocaleDateString('es-CL'),
                        productos
                    );
                } else {
                    showToast('‚ö†Ô∏è No se encontraron productos con SKU v√°lido');
                }
            } catch (err) {
                console.error('Error:', err);
                showToast('‚ùå Error al procesar Excel');
            }
        };
        reader.readAsArrayBuffer(file);
    } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Error al leer archivo');
    }
    
    document.getElementById('importGuiaExcel').value = '';
}

// Cargar cat√°logo local al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarCatalogoLocal();
});
    </script>
</body>
</html>
