// Creating complete HTML file with signature and PDF functionality
const completeHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Coquinaria</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4a0404">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --header-bg-gradient: linear-gradient(135deg, #4a0404 0%, #2c0202 100%);
            --accent-burdeo: #5e0808;
            --text-rosa-palo: #b85c67;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --body-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-light: #e2e8f0;
            --color-green: #059669;
            --progress-color: #27ae60;
            
            --pantone-7747c: #2F5C39;
            --pantone-131c: #CC8A00;
            --pantone-2379c: #C31F75;
            
            --btn-cta-gradient: linear-gradient(135deg, #d48790 0%, #b85c67 100%); 
            --btn-cta-shadow: rgba(184, 92, 103, 0.4);

            --header-height: 75px; 
            --controls-height: 115px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: calc(var(--header-height) + var(--controls-height)); 
            padding-bottom: 90px; 
            font-weight: 400;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background: var(--header-bg-gradient);
            height: var(--header-height);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header-logo { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 200; color: white; letter-spacing: 2px; text-transform: uppercase; }
        .header-actions { display: flex; flex-direction: column; align-items: flex-end; color: rgba(255, 255, 255, 0.95); }
        .header-date { font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 6px; }
        #lastSavedIndicator { font-size: 10px; opacity: 0.8; margin-top: 3px; font-weight: 300; }
        .progress-line { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }

        /* CONTROLES */
        .sticky-controls {
            position: fixed; top: var(--header-height); left: 0; right: 0;
            height: var(--controls-height); background: var(--body-bg); z-index: 900;
            display: flex; flex-direction: column; justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 6px -4px rgba(0,0,0,0.05);
        }
        .search-container { padding: 10px 20px 8px 20px; }
        .search-wrapper { position: relative; width: 100%; }
        .search-input { width: 100%; background: white; border: 1px solid var(--border-light); padding: 10px 40px; border-radius: 12px; font-size: 14px; height: 44px; transition: all 0.2s; outline: none; }
        .search-input:focus { border-color: var(--text-rosa-palo); box-shadow: 0 0 0 3px rgba(184, 92, 103, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; }
        .clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background:none; border:none; font-size:16px; color:#999; display:none; padding:5px; }

        .menu-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 10px 20px; scrollbar-width: none; align-items: center; height: 50px; }
        .menu-scroll::-webkit-scrollbar { display: none; }

        .menu-chip { display: inline-flex; align-items: center; gap: 6px; background: white; border: 1px solid var(--border-light); padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.03); flex-shrink: 0; height: 38px; }
        .menu-chip.active { background: var(--text-rosa-palo); color: white; border-color: var(--text-rosa-palo); box-shadow: 0 4px 10px rgba(184, 92, 103, 0.3); font-weight: 600; }
        .menu-chip.count-active { background: var(--pantone-7747c); color: white; border-color: var(--pantone-7747c); box-shadow: 0 4px 10px rgba(47, 92, 57, 0.3); }
        .menu-chip.recep-active { background: var(--pantone-131c); color: white; border-color: var(--pantone-131c); box-shadow: 0 4px 10px rgba(204, 138, 0, 0.3); }
        .menu-chip.sugg-active { background: var(--pantone-2379c); color: white; border-color: var(--pantone-2379c); box-shadow: 0 4px 10px rgba(195, 31, 117, 0.3); }
        
        .menu-chip svg { width: 16px; height: 16px; stroke-width: 2; }
        .menu-chip:active { transform: scale(0.97); }

        /* LISTA */
        .products-list { padding: 0 20px; }
        .product-card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .product-card:active { transform: scale(0.99); background-color: #fafafa; }
        .product-card.counted { border-left: 4px solid var(--pantone-7747c); }
        .product-card.reception-counted { border-left: 4px solid var(--pantone-131c); }
        .product-card.suggestion-counted { border-left: 4px solid var(--pantone-2379c); }

        .product-info { flex: 1; margin-right: 15px; }
        .product-info h4 { font-size: 14px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; font-weight: 600; }
        .product-sku { font-size: 11px; color: var(--text-secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; display: inline-block; font-weight: 500; }
        
        .stock-control { display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .stock-control.count-mode { border-color: var(--pantone-7747c); background: #f0fdf4; }
        .stock-control.reception-mode { border-color: var(--pantone-131c); background: #fffbf0; }
        .stock-control.suggestion-mode { border-color: var(--pantone-2379c); background: #fdf2f8; }

        .btn-stock { width: 30px; height: 30px; border: none; background: white; border-radius: 6px; color: var(--text-primary); font-weight: 700; font-size: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-stock:active { background: #e2e8f0; }
        .stock-input { width: 34px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 15px; color: var(--text-primary); }
        .catalog-display { font-size: 13px; font-weight: 600; color: #94a3b8; min-width: 40px; text-align: center; }

        /* Document Input */
        .doc-input-container {
            padding: 10px 20px;
            background: #fffbf0;
            border-bottom: 1px solid #f0e6d2;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }
        .doc-input {
            width: 100%; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;
            font-size: 14px; outline: none;
        }

        /* CTA */
        .cta-container { padding: 20px; padding-bottom: 40px; display: flex; gap: 10px; flex-direction: column; }
        .btn-cta { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px var(--btn-cta-shadow); background: var(--btn-cta-gradient); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-cta:active { transform: scale(0.98); }
        .btn-cta.secondary { background: white; color: var(--text-primary); border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* OVERLAY */
        .product-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .product-overlay.active { opacity: 1; pointer-events: auto; }
        .detail-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; max-height: 85vh; display: flex; flex-direction: column; }
        .product-overlay.active .detail-card { transform: scale(1); }
        .detail-image-box { width: 100%; height: 180px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #f1f5f9; }
        .detail-img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
        .detail-placeholder { font-size: 64px; opacity: 0.15; filter: grayscale(100%); }
        .detail-content { padding: 25px; overflow-y: auto; }
        .detail-brand { font-size: 11px; text-transform: uppercase; color: var(--text-rosa-palo); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
        .detail-origin { font-size: 10px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; margin-left: 8px; }
        .detail-title { font-size: 20px; font-weight: 700; color: var(--text-primary); line-height: 1.3; margin-bottom: 8px; }
        .detail-sku { font-size: 13px; color: #94a3b8; font-family: monospace; margin-bottom: 15px; }
        .detail-desc { font-size: 15px; line-height: 1.6; color: #475569; }
        .close-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.9); border: none; font-size: 20px; color: #333; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); height: 80px; display: flex; justify-content: space-around; align-items: flex-start; padding-top: 12px; border-top: 1px solid var(--border-light); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; cursor: pointer; }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }
        .nav-item.active { color: var(--accent-burdeo); }
        .nav-item.active svg { stroke-width: 2.5; }

        .floating-scroll-btn { position: fixed; bottom: 100px; right: 20px; width: 30px; height: 30px; background: var(--text-rosa-palo); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(184, 92, 103, 0.4); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; z-index: 1900; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; pointer-events: none; transform: translateY(20px); }
        .floating-scroll-btn.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .floating-scroll-btn svg { width: 16px; height: 16px; stroke-width: 2.5; }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 5000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }
        #dateInput { position: absolute; opacity: 0; width: 0; height: 0; bottom: 0; right: 0; pointer-events: none; }
        .history-item { background: white; padding: 18px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        #scanInput { display: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }

        /* SIGNATURE MODAL */
        .signature-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; align-items: center; justify-content: center; }
        .signature-modal.active { display: flex; }
        .signature-content { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 500px; }
        .signature-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; color: var(--text-primary); text-align: center; }
        .signature-canvas-wrapper { border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; margin-bottom: 15px; overflow: hidden; }
        #signatureCanvas { display: block; touch-action: none; cursor: crosshair; }
        .signature-actions { display: flex; gap: 10px; }
        .signature-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-clear-signature { background: #f1f5f9; color: #475569; }
        .btn-confirm-signature { background: var(--btn-cta-gradient); color: white; }
    </style>
</head>
<body>

    <input type="file" id="fileImport" accept=".csv,.txt" style="display:none" onchange="handleFileImport(this)">
    <input type="file" id="scanInput" accept="image/*" capture="environment" onchange="handleScan(this)">
    <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none" onchange="importarExcelRecepcion(this.files[0])">
    
    <!-- HEADER -->
    <div class="header">
        <div class="header-logo">üç∑ COQUINARIA</div>
        <div class="header-actions">
            <div class="header-date" onclick="openDate()">
                <span id="dateDisplay">--/--</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </div>
            <div id="lastSavedIndicator">Guardado</div>
        </div>
        <input type="date" id="dateInput">
        <div class="progress-line"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <!-- STICKY TOOLBAR -->
    <div class="sticky-controls" id="stickyControls">
        <div class="search-container">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar producto..." onkeyup="handleSearch(this)">
                <button class="clear-search" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        <div id="toolbarMenu" class="menu-scroll"></div>
    </div>

    <!-- MAIN PRODUCT LIST -->
    <div id="view-products">
        <div id="docInputContainer"></div>
        <div id="productsContainer" class="products-list"></div>
        <div class="cta-container" id="ctaContainer"></div>
        <button id="floatingSaveBtn" class="floating-scroll-btn" onclick="handleFloatingClick()">
            <svg id="floatingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
        </button>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" style="display:none; padding: 20px;">
        <h3 style="margin-bottom:15px; color:#1e293b; font-size:18px;">Historial</h3>
        <div id="historyContent"></div>
    </div>

    <!-- PRODUCT DETAIL OVERLAY -->
    <div id="productOverlay" class="product-overlay">
        <div class="detail-card" id="detailCard">
            <button class="close-btn" onclick="closeOverlay()">‚úï</button>
            <div class="detail-image-box">
                <img id="dImg" class="detail-img" src="" style="display:none">
                <div id="dPlace" class="detail-placeholder">üì¶</div>
            </div>
            <div class="detail-content">
                <div style="display:flex; align-items:center; margin-bottom:5px;">
                    <div class="detail-brand" id="dBrand">MARCA</div>
                    <div class="detail-origin" id="dOrigin" style="display:none;"></div>
                </div>
                <div class="detail-title" id="dName">Producto</div>
                <div class="detail-sku">SKU: <span id="dSku"></span></div>
                <div class="detail-desc" id="dDesc">Descripci√≥n...</div>
            </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="shareModalTitle">Compartir Reporte</h3>
            <div class="modal-actions">
                <button class="btn-cta" onclick="executeShare('whatsapp')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                    Enviar por WhatsApp
                </button>
                <button class="btn-cta secondary" onclick="executeShare('email')">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/></svg>
                    Enviar por Correo
                </button>
                <button class="btn-cta secondary" style="border:none; color:#64748b; margin-top:5px;" onclick="closeShareModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- SIGNATURE MODAL -->
    <div id="signatureModal" class="signature-modal">
        <div class="signature-content">
            <h3 class="signature-title">‚úçÔ∏è Firma Digital</h3>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">Firma con tu dedo para confirmar la recepci√≥n</p>
            <div class="signature-canvas-wrapper">
                <canvas id="signatureCanvas" width="460" height="200"></canvas>
            </div>
            <div class="signature-actions">
                <button class="btn-clear-signature" onclick="clearSignature()">üóëÔ∏è Limpiar</button>
                <button class="btn-confirm-signature" onclick="confirmSignature()">‚úÖ Confirmar</button>
            </div>
            <button class="btn-cta secondary" style="margin-top: 10px; width: 100%;" onclick="closeSignatureModal()">Cancelar</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-item active" id="nav-catalog" onclick="switchMainView('catalog')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
            <span>Cat√°logo</span>
        </button>
        <button class="nav-item" id="nav-stock" onclick="switchMainView('stock')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            <span>Stock</span>
        </button>
        <button class="nav-item" id="nav-history" onclick="switchMainView('history')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Historial</span>
        </button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ============================================
        // DATOS DE PRODUCTOS
        // ============================================

        // Creating complete HTML file with signature and PDF functionality
const completeHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario Coquinaria</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4a0404">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --header-bg-gradient: linear-gradient(135deg, #4a0404 0%, #2c0202 100%);
            --accent-burdeo: #5e0808;
            --text-rosa-palo: #b85c67;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --body-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-light: #e2e8f0;
            --color-green: #059669;
            --progress-color: #27ae60;
            
            --pantone-7747c: #2F5C39;
            --pantone-131c: #CC8A00;
            --pantone-2379c: #C31F75;
            
            --btn-cta-gradient: linear-gradient(135deg, #d48790 0%, #b85c67 100%); 
            --btn-cta-shadow: rgba(184, 92, 103, 0.4);

            --header-height: 75px; 
            --controls-height: 115px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: calc(var(--header-height) + var(--controls-height)); 
            padding-bottom: 90px; 
            font-weight: 400;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background: var(--header-bg-gradient);
            height: var(--header-height);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header-logo { font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 200; color: white; letter-spacing: 2px; text-transform: uppercase; }
        .header-actions { display: flex; flex-direction: column; align-items: flex-end; color: rgba(255, 255, 255, 0.95); }
        .header-date { font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 6px; }
        #lastSavedIndicator { font-size: 10px; opacity: 0.8; margin-top: 3px; font-weight: 300; }
        .progress-line { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.1); }
        .progress-fill { height: 100%; background: #4ade80; width: 0%; transition: width 0.5s; }

        /* CONTROLES */
        .sticky-controls {
            position: fixed; top: var(--header-height); left: 0; right: 0;
            height: var(--controls-height); background: var(--body-bg); z-index: 900;
            display: flex; flex-direction: column; justify-content: center;
            border-bottom: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 6px -4px rgba(0,0,0,0.05);
        }
        .search-container { padding: 10px 20px 8px 20px; }
        .search-wrapper { position: relative; width: 100%; }
        .search-input { width: 100%; background: white; border: 1px solid var(--border-light); padding: 10px 40px; border-radius: 12px; font-size: 14px; height: 44px; transition: all 0.2s; outline: none; }
        .search-input:focus { border-color: var(--text-rosa-palo); box-shadow: 0 0 0 3px rgba(184, 92, 103, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; width: 18px; }
        .clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background:none; border:none; font-size:16px; color:#999; display:none; padding:5px; }

        .menu-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 10px 20px; scrollbar-width: none; align-items: center; height: 50px; }
        .menu-scroll::-webkit-scrollbar { display: none; }

        .menu-chip { display: inline-flex; align-items: center; gap: 6px; background: white; border: 1px solid var(--border-light); padding: 8px 16px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.03); flex-shrink: 0; height: 38px; }
        .menu-chip.active { background: var(--text-rosa-palo); color: white; border-color: var(--text-rosa-palo); box-shadow: 0 4px 10px rgba(184, 92, 103, 0.3); font-weight: 600; }
        .menu-chip.count-active { background: var(--pantone-7747c); color: white; border-color: var(--pantone-7747c); box-shadow: 0 4px 10px rgba(47, 92, 57, 0.3); }
        .menu-chip.recep-active { background: var(--pantone-131c); color: white; border-color: var(--pantone-131c); box-shadow: 0 4px 10px rgba(204, 138, 0, 0.3); }
        .menu-chip.sugg-active { background: var(--pantone-2379c); color: white; border-color: var(--pantone-2379c); box-shadow: 0 4px 10px rgba(195, 31, 117, 0.3); }
        
        .menu-chip svg { width: 16px; height: 16px; stroke-width: 2; }
        .menu-chip:active { transform: scale(0.97); }

        /* LISTA */
        .products-list { padding: 0 20px; }
        .product-card { background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .product-card:active { transform: scale(0.99); background-color: #fafafa; }
        .product-card.counted { border-left: 4px solid var(--pantone-7747c); }
        .product-card.reception-counted { border-left: 4px solid var(--pantone-131c); }
        .product-card.suggestion-counted { border-left: 4px solid var(--pantone-2379c); }

        .product-info { flex: 1; margin-right: 15px; }
        .product-info h4 { font-size: 14px; color: var(--text-primary); margin-bottom: 4px; line-height: 1.4; font-weight: 600; }
        .product-sku { font-size: 11px; color: var(--text-secondary); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; display: inline-block; font-weight: 500; }
        
        .stock-control { display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .stock-control.count-mode { border-color: var(--pantone-7747c); background: #f0fdf4; }
        .stock-control.reception-mode { border-color: var(--pantone-131c); background: #fffbf0; }
        .stock-control.suggestion-mode { border-color: var(--pantone-2379c); background: #fdf2f8; }

        .btn-stock { width: 30px; height: 30px; border: none; background: white; border-radius: 6px; color: var(--text-primary); font-weight: 700; font-size: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-stock:active { background: #e2e8f0; }
        .stock-input { width: 34px; border: none; background: transparent; text-align: center; font-weight: 700; font-size: 15px; color: var(--text-primary); }
        .catalog-display { font-size: 13px; font-weight: 600; color: #94a3b8; min-width: 40px; text-align: center; }

        /* Document Input */
        .doc-input-container {
            padding: 10px 20px;
            background: #fffbf0;
            border-bottom: 1px solid #f0e6d2;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px;
        }
        .doc-input {
            width: 100%; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px;
            font-size: 14px; outline: none;
        }

        /* CTA */
        .cta-container { padding: 20px; padding-bottom: 40px; display: flex; gap: 10px; flex-direction: column; }
        .btn-cta { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; color: white; cursor: pointer; box-shadow: 0 4px 15px var(--btn-cta-shadow); background: var(--btn-cta-gradient); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-cta:active { transform: scale(0.98); }
        .btn-cta.secondary { background: white; color: var(--text-primary); border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* OVERLAY */
        .product-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .product-overlay.active { opacity: 1; pointer-events: auto; }
        .detail-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.95); transition: transform 0.2s; max-height: 85vh; display: flex; flex-direction: column; }
        .product-overlay.active .detail-card { transform: scale(1); }
        .detail-image-box { width: 100%; height: 180px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; position: relative; border-bottom: 1px solid #f1f5f9; }
        .detail-img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
        .detail-placeholder { font-size: 64px; opacity: 0.15; filter: grayscale(100%); }
        .detail-content { padding: 25px; overflow-y: auto; }
        .detail-brand { font-size: 11px; text-transform: uppercase; color: var(--text-rosa-palo); font-weight: 700; letter-spacing: 1px; margin-bottom: 5px; }
        .detail-origin { font-size: 10px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; margin-left: 8px; }
        .detail-title { font-size: 20px; font-weight: 700; color: var(--text-primary); line-height: 1.3; margin-bottom: 8px; }
        .detail-sku { font-size: 13px; color: #94a3b8; font-family: monospace; margin-bottom: 15px; }
        .detail-desc { font-size: 15px; line-height: 1.6; color: #475569; }
        .close-btn { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.9); border: none; font-size: 20px; color: #333; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); height: 80px; display: flex; justify-content: space-around; align-items: flex-start; padding-top: 12px; border-top: 1px solid var(--border-light); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { background: none; border: none; color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; cursor: pointer; }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }
        .nav-item.active { color: var(--accent-burdeo); }
        .nav-item.active svg { stroke-width: 2.5; }

        .floating-scroll-btn { position: fixed; bottom: 100px; right: 20px; width: 30px; height: 30px; background: var(--text-rosa-palo); color: white; border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(184, 92, 103, 0.4); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; z-index: 1900; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; pointer-events: none; transform: translateY(20px); }
        .floating-scroll-btn.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .floating-scroll-btn svg { width: 16px; height: 16px; stroke-width: 2.5; }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 5000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; }
        .empty-state { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }
        #dateInput { position: absolute; opacity: 0; width: 0; height: 0; bottom: 0; right: 0; pointer-events: none; }
        .history-item { background: white; padding: 18px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        #scanInput { display: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }

        /* SIGNATURE MODAL */
        .signature-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 5000; align-items: center; justify-content: center; }
        .signature-modal.active { display: flex; }
        .signature-content { background: white; padding: 20px; border-radius: 16px; width: 90%; max-width: 500px; }
        .signature-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; color: var(--text-primary); text-align: center; }
        .signature-canvas-wrapper { border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; margin-bottom: 15px; overflow: hidden; }
        #signatureCanvas { display: block; touch-action: none; cursor: crosshair; }
        .signature-actions { display: flex; gap: 10px; }
        .signature-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-clear-signature { background: #f1f5f9; color: #475569; }
        .btn-confirm-signature { background: var(--btn-cta-gradient); color: white; }
    </style>
</head>
<body>

    <input type="file" id="fileImport" accept=".csv,.txt" style="display:none" onchange="handleFileImport(this)">
    <input type="file" id="scanInput" accept="image/*" capture="environment" onchange="handleScan(this)">
    <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none" onchange="importarExcelRecepcion(this.files[0])">
    
    <!-- HEADER -->
    <div class="header">
        <div class="header-logo">üç∑ COQUINARIA</div>
        <div class="header-actions">
            <div class="header-date" onclick="openDate()">
                <span id="dateDisplay">--/--</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </div>
            <div id="lastSavedIndicator">Guardado</div>
        </div>
        <input type="date" id="dateInput">
        <div class="progress-line"><div class="progress-fill" id="progressBar"></div></div>
    </div>

    <!-- STICKY TOOLBAR -->
    <div class="sticky-controls" id="stickyControls">
        <div class="search-container">
            <div class="search-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar producto..." onkeyup="handleSearch(this)">
                <button class="clear-search" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        <div id="toolbarMenu" class="menu-scroll"></div>
    </div>

    <!-- MAIN PRODUCT LIST -->
    <div id="view-products">
        <div id="docInputContainer"></div>
        <div id="productsContainer" class="products-list"></div>
        <div class="cta-container" id="ctaContainer"></div>
        <button id="floatingSaveBtn" class="floating-scroll-btn" onclick="handleFloatingClick()">
            <svg id="floatingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
        </button>
    </div>

    <!-- HISTORY VIEW -->
    <div id="view-history" style="display:none; padding: 20px;">
        <h3 style="margin-bottom:15px; color:#1e293b; font-size:18px;">Historial</h3>
        <div id="historyContent"></div>
    </div>

    <!-- PRODUCT DETAIL OVERLAY -->
    <div id="productOverlay" class="product-overlay">
        <div class="detail-card" id="detailCard">
            <button class="close-btn" onclick="closeOverlay()">‚úï</button>
            <div class="detail-image-box">
                <img id="dImg" class="detail-img" src="" style="display:none">
                <div id="dPlace" class="detail-placeholder">üì¶</div>
            </div>
            <div class="detail-content">
                <div style="display:flex; align-items:center; margin-bottom:5px;">
                    <div class="detail-brand" id="dBrand">MARCA</div>
                    <div class="detail-origin" id="dOrigin" style="display:none;"></div>
                </div>
                <div class="detail-title" id="dName">Producto</div>
                <div class="detail-sku">SKU: <span id="dSku"></span></div>
                <div class="detail-desc" id="dDesc">Descripci√≥n...</div>
            </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title" id="shareModalTitle">Compartir Reporte</h3>
            <div class="modal-actions">
                <button class="btn-cta" onclick="executeShare('whatsapp')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                    Enviar por WhatsApp
                </button>
                <button class="btn-cta secondary" onclick="executeShare('email')">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z"/></svg>
                    Enviar por Correo
                </button>
                <button class="btn-cta secondary" style="border:none; color:#64748b; margin-top:5px;" onclick="closeShareModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- SIGNATURE MODAL -->
    <div id="signatureModal" class="signature-modal">
        <div class="signature-content">
            <h3 class="signature-title">‚úçÔ∏è Firma Digital</h3>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">Firma con tu dedo para confirmar la recepci√≥n</p>
            <div class="signature-canvas-wrapper">
                <canvas id="signatureCanvas" width="460" height="200"></canvas>
            </div>
            <div class="signature-actions">
                <button class="btn-clear-signature" onclick="clearSignature()">üóëÔ∏è Limpiar</button>
                <button class="btn-confirm-signature" onclick="confirmSignature()">‚úÖ Confirmar</button>
            </div>
            <button class="btn-cta secondary" style="margin-top: 10px; width: 100%;" onclick="closeSignatureModal()">Cancelar</button>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <button class="nav-item active" id="nav-catalog" onclick="switchMainView('catalog')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
            <span>Cat√°logo</span>
        </button>
        <button class="nav-item" id="nav-stock" onclick="switchMainView('stock')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            <span>Stock</span>
        </button>
        <button class="nav-item" id="nav-history" onclick="switchMainView('history')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <span>Historial</span>
        </button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ============================================
        // DATOS DE PRODUCTOS
        // ============================================
${document.body.textContent.match(/const rawProducts = \[[\s\S]*?\];/)[0]}

        const CATEGORIES = ["Aperitivo", "Aderezos y Condimentos", "Bar y Mixolog√≠a", "Gourmet", "Mesa y Cocina", "Momentos Dulces", "Regalos", "T√© y Caf√©", "Otros"];

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let mainView = 'catalog'; 
        let stockMode = 'count'; 
        let currentCategory = 'Todos';
        let selectedDateKey = "";
        let searchTerm = '';
        
        let dataCount = {};
        let dataReception = {};
        let dataSuggestion = {};
        let currentDocNumber = "";
        
        let swipeStartX = 0;
        let activeDetailSku = null;
        let shareTypeTemp = '';
        
        // SIGNATURE STATE
        let currentSignature = null;
        let signatureCanvas, signatureCtx, isDrawing = false;

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            initDate();
            loadAllData();
            setupSignatureCanvas();
            switchMainView('catalog'); 
            setupSearch();
            setupOverlaySwipe();
            window.addEventListener('scroll', handleScroll);
        });

        function initDate() {
            const dateInput = document.getElementById('dateInput');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            selectedDateKey = today;
            updateDateDisplay(today);
            dateInput.addEventListener('change', (e) => {
                selectedDateKey = e.target.value;
                updateDateDisplay(selectedDateKey);
                loadAllData();
                renderProducts();
            });
        }

        function updateDateDisplay(dateStr) {
            const parts = dateStr.split('-');
            document.querySelector('.header-date span').textContent = \`\${parts[2]}/\${parts[1]}\`;
        }
        function openDate() { document.getElementById('dateInput').showPicker(); }

        // ============================================
        // SIGNATURE CANVAS SETUP
        // ============================================
        function setupSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            
            signatureCtx.strokeStyle = '#1e293b';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            signatureCtx.beginPath();
            signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            signatureCtx.stroke();
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        function openSignatureModal() {
            document.getElementById('signatureModal').classList.add('active');
            clearSignature();
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.remove('active');
        }

        async function confirmSignature() {
            currentSignature = signatureCanvas.toDataURL('image/png');
            closeSignatureModal();
            
            showToast('üìù Generando PDF firmado...');
            
            await generarPDFFirmado();
        }

        // ============================================
        // GENERAR PDF CON FIRMA
        // ============================================
        async function generarPDFFirmado() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // HEADER
            doc.setFillColor(74, 4, 4);
            doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('üç∑ COQUINARIA', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('RECEPCI√ìN DE MERCADER√çA', 105, 23, { align: 'center' });

            // INFO
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(\`N¬∫ Gu√≠a: \${currentDocNumber}\`, 20, 40);
            doc.text(\`Fecha: \${new Date().toLocaleDateString('es-CL')}\`, 20, 47);
            doc.text(\`Hora: \${new Date().toLocaleTimeString('es-CL')}\`, 20, 54);

            // TABLA
            let y = 65;
            doc.setFillColor(241, 245, 249);
            doc.rect(20, y, 170, 8, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('SKU', 25, y + 5);
            doc.text('Producto', 50, y + 5);
            doc.text('Cantidad', 160, y + 5);

            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);

            let totalProductos = 0;
            let totalUnidades = 0;

            rawProducts.forEach(p => {
                const qty = dataReception[p.sku] || 0;
                if (qty > 0) {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(p.sku, 25, y);
                    const nombre = p.name.length > 45 ? p.name.substring(0, 45) + '...' : p.name;
                    doc.text(nombre, 50, y);
                    doc.text(qty.toString(), 165, y);

                    y += 7;
                    totalProductos++;
                    totalUnidades += qty;
                }
            });

            // RESUMEN
            y += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, y, 190, y);
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(\`Total productos: \${totalProductos}\`, 25, y);
            doc.text(\`Total unidades: \${totalUnidades}\`, 25, y + 7);

            // FIRMA
            y += 20;
            if (currentSignature) {
                doc.addImage(currentSignature, 'PNG', 25, y, 60, 25);
            }
            
            y += 30;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('_______________________________', 25, y);
            doc.text('Firma Recepcionista', 25, y + 5);
            doc.text(\`Firmado el: \${new Date().toLocaleString('es-CL')}\`, 25, y + 10);

            // FOOTER
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Documento generado autom√°ticamente por Sistema Coquinaria', 105, 285, { align: 'center' });

            // GUARDAR
            const fileName = \`Recepcion_\${currentDocNumber}_\${new Date().toISOString().split('T')[0]}_FIRMADO.pdf\`;
            doc.save(fileName);

            showToast('‚úÖ PDF firmado descargado');
        }

        // ============================================
        // DATA MANAGER
        // ============================================
        function loadAllData() {
            try {
                dataCount = JSON.parse(localStorage.getItem(\`inv_count_\${selectedDateKey}\`)) || {};
                dataReception = JSON.parse(localStorage.getItem(\`inv_recep_\${selectedDateKey}\`)) || {};
                dataSuggestion = JSON.parse(localStorage.getItem(\`inv_sugg_\${selectedDateKey}\`)) || {};
                const savedDoc = localStorage.getItem(\`inv_recep_doc_\${selectedDateKey}\`);
                if(savedDoc) currentDocNumber = savedDoc;
            } catch (e) {
                dataCount = {}; dataReception = {}; dataSuggestion = {};
            }
        }

        function saveData() {
            localStorage.setItem(\`inv_count_\${selectedDateKey}\`, JSON.stringify(dataCount));
            localStorage.setItem(\`inv_recep_\${selectedDateKey}\`, JSON.stringify(dataReception));
            localStorage.setItem(\`inv_sugg_\${selectedDateKey}\`, JSON.stringify(dataSuggestion));
            if(stockMode === 'reception') localStorage.setItem(\`inv_recep_doc_\${selectedDateKey}\`, currentDocNumber);
            document.getElementById('lastSavedIndicator').textContent = 'Guardado ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function switchMainView(view) {
            mainView = view;
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(\`nav-\${view}\`).classList.add('active');
            
            const prodView = document.getElementById('view-products');
            const histView = document.getElementById('view-history');
            
            if (view === 'history') {
                prodView.style.display = 'none';
                histView.style.display = 'block';
                renderHistory();
            } else {
                prodView.style.display = 'block';
                histView.style.display = 'none';
            }
            
            const toolbar = document.getElementById('toolbarMenu');
            toolbar.innerHTML = ''; 

            if (view === 'catalog') {
                renderCategories(toolbar);
            } else if (view === 'stock') {
                renderStockTools(toolbar);
            }
            
            renderProducts();
            window.scrollTo(0,0);
        }

        function renderCategories(container) {
            const cats = ['Todos', ...CATEGORIES];
            container.innerHTML = cats.map(cat => \`
                <div class="menu-chip \${currentCategory === cat ? 'active' : ''}" 
                     onclick="selectCategory('\${cat}')"> \${cat}</div>
            \`).join('');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            switchMainView('catalog');
        }

        function renderStockTools(container) {
            const modes = [
                {id: 'date', label: 'Fecha', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />'},
                {id: 'count', label: 'Conteo', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />'},
                {id: 'reception', label: 'Recepci√≥n', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />'},
                {id: 'suggestion', label: 'Sugerido', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />'},
                {id: 'import', label: 'Importar', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />'}
            ];

            container.innerHTML = modes.map(m => {
                let activeClass = '';
                if(stockMode === m.id) {
                    if(m.id === 'count') activeClass = 'count-active';
                    else if(m.id === 'reception') activeClass = 'recep-active';
                    else if(m.id === 'suggestion') activeClass = 'sugg-active';
                }

                let onclick = \`setStockMode('\${m.id}')\`;
                if(m.id === 'date') onclick = \`openDate()\`;
                if(m.id === 'import') onclick = \`document.getElementById('fileImport').click()\`;

                return \`
                <div class="menu-chip \${activeClass}" onclick="\${onclick}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\${m.icon}</svg>
                    \${m.label}
                </div>\`;
            }).join('');
            
            if (stockMode === 'reception') {
                container.innerHTML += \`
                <div class="menu-chip" onclick="triggerCamera()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Escanear Gu√≠a
                </div>
                <div class="menu-chip" onclick="document.getElementById('importExcelInput').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    Importar Excel
                </div>\`;
            }
        }

        function setStockMode(mode) {
            stockMode = mode;
            switchMainView('stock');
        }

        function triggerCamera() { document.getElementById('scanInput').click(); }

        // ============================================
        // RENDER PRODUCTS
        // ============================================
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const ctaContainer = document.getElementById('ctaContainer');
            const docContainer = document.getElementById('docInputContainer');
            
            if(!container) return;

            ctaContainer.innerHTML = ''; 
            docContainer.innerHTML = '';

            let filtered = rawProducts.filter(p => {
                if (searchTerm) {
                    const term = searchTerm;
                    const matchesName = p.name.toLowerCase().includes(term);
                    const matchesSku = p.sku.includes(term);
                    const matchesBrand = p.brand.toLowerCase().includes(term);
                    const matchesOrigin = p.origin ? p.origin.toLowerCase().includes(term) : false;
                    
                    if (!matchesName && !matchesSku && !matchesBrand && !matchesOrigin) return false;
                }
                
                if (mainView === 'catalog') {
                    if (currentCategory !== 'Todos') {
                        if (currentCategory === 'Otros') return !p.category;
                        return p.category === currentCategory;
                    }
                }
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No se encontraron productos</div>';
                return;
            }

            if (mainView === 'stock' && stockMode === 'reception') {
                docContainer.innerHTML = \`
                <div class="doc-input-container">
                    <span style="font-weight:600; font-size:13px; color:#1e293b;">N¬∞ Gu√≠a:</span>
                    <input type="text" id="docNumberInput" class="doc-input" placeholder="Ej: 123456" value="\${currentDocNumber}" onchange="updateDocNumber(this.value)">
                </div>\`;
            }

            if (mainView === 'stock') {
                let btnText = "";
                let modeLabel = "";
                if (stockMode === 'count') { btnText = "Finalizar Conteo"; modeLabel="Conteo"; }
                if (stockMode === 'reception') { btnText = "Finalizar Recepci√≥n"; modeLabel="Recepci√≥n"; }
                if (stockMode === 'suggestion') { btnText = "Finalizar Sugerido"; modeLabel="Sugerido"; }
                
                if(btnText) {
                    ctaContainer.innerHTML = \`
                        <button class="btn-cta" onclick="openShareModal('\${modeLabel}')">
                            \${btnText}
                        </button>
                    \`;
                    
                    if (stockMode === 'reception' && currentDocNumber) {
                        ctaContainer.innerHTML += \`
                            <button class="btn-cta secondary" onclick="exportarRecepcionCompleta('\${currentDocNumber}')" style="margin-top: 10px;">
                                üìä Exportar a Excel
                            </button>
                            <button class="btn-cta" onclick="openSignatureModal()" style="margin-top: 10px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
                                üìÑ Generar PDF Firmado
                            </button>
                        \`;
                    }
                }
            }

            container.innerHTML = filtered.map(p => {
                const qtyCount = dataCount[p.sku] || 0;
                const qtyRecep = dataReception[p.sku] || 0;
                const qtySugg = dataSuggestion[p.sku] || 0;

                let controls = '';
                let borderClass = '';
                let displayVal = 0;

                if (mainView === 'stock') {
                    let currentModeClass = '';
                    if (stockMode === 'count') {
                        displayVal = qtyCount;
                        currentModeClass = 'count-mode';
                        if(qtyCount > 0) borderClass = 'counted';
                    } else if (stockMode === 'reception') {
                        displayVal = qtyRecep;
                        currentModeClass = 'reception-mode';
                        if(qtyRecep > 0) borderClass = 'reception-counted';
                    } else if (stockMode === 'suggestion') {
                        displayVal = qtySugg;
                        currentModeClass = 'suggestion-mode';
                        if(qtySugg > 0) borderClass = 'suggestion-counted';
                    }

                    controls = \`
                        <div class="stock-control \${currentModeClass}" onclick="event.stopPropagation()">
                            <button class="btn-stock" onclick="modifyStock('\${p.sku}', -1)">-</button>
                            <input class="stock-input" value="\${displayVal}" readonly>
                            <button class="btn-stock" onclick="modifyStock('\${p.sku}', 1)">+</button>
                        </div>
                    \`;
                } else {
                    controls = \`<div class="catalog-display">\${qtyCount} un.</div>\`;
                }

                return \`
                    <div class="product-card \${borderClass}" onclick="openDetail('\${p.sku}')">
                        <div class="product-info">
                            <h4>\${p.name}</h4>
                            <div class="product-sku">SKU: \${p.sku}</div>
                        </div>
                        \${controls}
                    </div>
                \`;
            }).join('');
        }

        // ============================================
        // LOGIC
        // ============================================
        function updateDocNumber(val) {
            currentDocNumber = val;
            saveData();
        }

        function modifyStock(sku, delta) {
            let db;
            if (stockMode === 'count') db = dataCount;
            else if (stockMode === 'reception') db = dataReception;
            else if (stockMode === 'suggestion') db = dataSuggestion;
            
            const current = db[sku] || 0;
            const newVal = Math.max(0, current + delta);
            db[sku] = newVal;
            
            saveData();
            renderProducts(); 
        }

        // ============================================
        // SHARE MODAL & EXPORT
        // ============================================
        function openShareModal(type) {
            shareTypeTemp = type;
            document.getElementById('shareModalTitle').textContent = \`Compartir \${type}\`;
            document.getElementById('shareModal').classList.add('active');
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function executeShare(method) {
            const type = shareTypeTemp;
            closeShareModal();
            
            let db;
            let docInfo = "";
            if (type === 'Conteo') db = dataCount;
            else if (type === 'Recepci√≥n') { 
                db = dataReception; 
                if(currentDocNumber) docInfo = \`\\n*Documento:* \${currentDocNumber}\`;
            }
            else if (type === 'Sugerido') db = dataSuggestion;

            let text = \`*Reporte \${type} - \${selectedDateKey}*\${docInfo}\\n\\n\`;
            let bodyEmail = \`Reporte \${type} - \${selectedDateKey} \${docInfo}%0D%0A%0D%0A\`;
            
            let hasItems = false;
            
            rawProducts.forEach(p => {
                const val = db[p.sku] || 0;
                if(val > 0) {
                    text += \`- \${p.name}: \${val}\\n\`;
                    bodyEmail += \`- \${p.name}: \${val}%0D%0A\`;
                    hasItems = true;
                }
            });

            if (!hasItems) { showToast("No hay items para enviar"); return; }
            
            const hist = JSON.parse(localStorage.getItem('appHistory') || '[]');
            let label = type;
            if (type === 'Recepci√≥n' && currentDocNumber) label += \` #\${currentDocNumber}\`;
            
            hist.push({ 
                date: selectedDateKey, 
                type: label, 
                timestamp: new Date().toISOString(),
                docNum: currentDocNumber 
            });
            localStorage.setItem('appHistory', JSON.stringify(hist));

            if (method === 'whatsapp') {
                window.open(\`https://wa.me/?text=\${encodeURIComponent(text)}\`, '_blank');
            } else if (method === 'email') {
                window.open(\`mailto:?subject=Reporte \${type} \${selectedDateKey}&body=\${bodyEmail}\`, '_blank');
            }
        }
        
        function renderHistory() {
            const hist = JSON.parse(localStorage.getItem('appHistory') || '[]');
            const container = document.getElementById('historyContent');
            if(hist.length === 0) { container.innerHTML = '<div class="empty-state">Sin registros a√∫n</div>'; return; }
            container.innerHTML = hist.reverse().map(h => \`
                <div class="history-item">
                    <div>
                        <div style="color:#333; font-weight:600; margin-bottom:4px;">\${h.type}</div>
                        <div style="font-size:12px; color:#888;">\${new Date(h.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            \`).join('');
        }

        // ============================================
        // OVERLAY
        // ============================================
        function openDetail(sku) {
            const p = rawProducts.find(x => x.sku === sku);
            if(!p) return;
            activeDetailSku = sku;
            
            document.getElementById('dBrand').innerText = p.brand;
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dSku').innerText = p.sku;
            document.getElementById('dDesc').innerText = p.description || 'Sin descripci√≥n disponible.';
            
            const imgEl = document.getElementById('dImg');
            const ph = document.getElementById('dPlace');
            
            if(p.image) {
                imgEl.src = p.image; imgEl.style.display = 'block'; ph.style.display = 'none';
            } else {
                imgEl.style.display = 'none'; ph.style.display = 'block';
            }
            
            const originEl = document.getElementById('dOrigin');
            if (p.origin) {
                originEl.textContent = p.origin;
                originEl.style.display = 'inline-block';
            } else {
                originEl.style.display = 'none';
            }

            document.getElementById('productOverlay').classList.add('active');
        }

        function closeOverlay() {
            document.getElementById('productOverlay').classList.remove('active');
        }

        function setupOverlaySwipe() {
            const card = document.getElementById('detailCard');
            card.addEventListener('touchstart', e => { swipeStartX = e.changedTouches[0].screenX; }, {passive: true});
            card.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX;
                if (swipeStartX - endX > 50) navigateDetail(1); 
                if (endX - swipeStartX > 50) navigateDetail(-1); 
            }, {passive: true});
        }

        function navigateDetail(dir) {
            const idx = rawProducts.findIndex(p => p.sku === activeDetailSku);
            if(idx === -1) return;
            let nextIdx = idx + dir;
            if(nextIdx >= rawProducts.length) nextIdx = 0;
            if(nextIdx < 0) nextIdx = rawProducts.length - 1;
            openDetail(rawProducts[nextIdx].sku);
        }

        // ============================================
        // UTILS
        // ============================================
        function handleSearch(el) {
            searchTerm = el.value.toLowerCase();
            document.querySelector('.clear-search').style.display = searchTerm ? 'block' : 'none';
            renderProducts();
        }
        function clearSearch() {
            searchTerm = '';
            document.getElementById('searchInput').value = '';
            document.querySelector('.clear-search').style.display = 'none';
            renderProducts();
        }
        function setupSearch() {
             document.getElementById('searchInput').addEventListener('keyup', (e) => handleSearch(e.target));
        }
        function handleFileImport() { showToast("Importaci√≥n no configurada en demo"); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        
        function handleScroll() {
            const btn = document.getElementById('floatingSaveBtn');
            const icon = document.getElementById('floatingIcon');
            if(window.scrollY > 150) btn.classList.add('visible');
            else btn.classList.remove('visible');
            
            const isBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100);
            if (isBottom) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />';
                btn.onclick = () => window.scrollTo({top:0, behavior:'smooth'});
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />';
                btn.onclick = () => window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
            }
        }

        function handleFloatingClick() {
            const isBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100);
            if (isBottom) {
                window.scrollTo({top:0, behavior:'smooth'});
            } else {
                window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
            }
        }

        // ============================================
        // M√ìDULO EXCEL
        // ============================================
        async function cargarLibreriaXLSX() {
            if (window.XLSX) return window.XLSX;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
                script.onload = () => resolve(window.XLSX);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function exportarRecepcionCompleta(numeroGuia) {
            const XLSX = await cargarLibreriaXLSX();
            
            const productos = [];
            let totalDiferencias = 0;
            const faltantes = [];
            
            rawProducts.forEach(p => {
                const cantGuia = dataReception[p.sku] || 0;
                if (cantGuia > 0) {
                    const cantRecep = cantGuia;
                    const diff = cantRecep - cantGuia;
                    
                    productos.push({
                        sku: p.sku,
                        nombre: p.name,
                        cantGuia: cantGuia,
                        cantRecep: cantRecep,
                        diferencia: diff,
                        comentario: ''
                    });
                    
                    if (diff !== 0) {
                        totalDiferencias++;
                        faltantes.push({ sku: p.sku, nombre: p.name, diff: diff });
                    }
                }
            });
            
            const wb = XLSX.utils.book_new();
            
            const wsData = [];
            
            wsData.push(['COQUINARIA - RECEPCI√ìN DE MERCADER√çA']);
            wsData.push([]);
            wsData.push(['N¬∫ Gu√≠a:', numeroGuia, 'Fecha:', new Date().toLocaleDateString('es-CL')]);
            wsData.push(['Proveedor:', 'Kitchen Center', 'Documento:', currentDocNumber]);
            wsData.push([]);
            
            wsData.push(['SKU', 'Descripci√≥n', 'Cant. Gu√≠a', 'Cant. Recepcionada', 'Diferencia', 'Estado', 'Comentarios']);
            
            productos.forEach(prod => {
                const estado = prod.diferencia === 0 ? '‚úì OK' : (prod.diferencia < 0 ? '‚ö†Ô∏è FALTA' : 'üì¶ EXTRA');
                wsData.push([
                    prod.sku,
                    prod.nombre,
                    prod.cantGuia,
                    prod.cantRecep,
                    prod.diferencia,
                    estado,
                    prod.comentario
                ]);
            });
            
            wsData.push([]);
            wsData.push([]);
            
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['RESUMEN DE RECEPCI√ìN']);
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['Total productos:', productos.length]);
            wsData.push(['Productos con diferencias:', totalDiferencias]);
            wsData.push(['Total unidades gu√≠a:', productos.reduce((sum, p) => sum + p.cantGuia, 0)]);
            wsData.push(['Total unidades recepcionadas:', productos.reduce((sum, p) => sum + p.cantRecep, 0)]);
            wsData.push([]);
            
            if (faltantes.length > 0) {
                wsData.push(['DETALLE DE DIFERENCIAS:']);
                faltantes.forEach(f => {
                    wsData.push(['', \`SKU \${f.sku}: \${f.diff > 0 ? '+' : ''}\${f.diff} unidades (\${f.nombre})\`]);
                });
                wsData.push([]);
            }
            
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['FIRMA Y AUTORIZACI√ìN']);
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['Recepcionado por:', '____________________']);
            wsData.push(['Fecha y hora:', new Date().toLocaleString('es-CL')]);
            wsData.push(['Observaciones:', '']);
            wsData.push(['', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                { wch: 10 },
                { wch: 45 },
                { wch: 12 },
                { wch: 18 },
                { wch: 12 },
                { wch: 12 },
                { wch: 30 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Recepci√≥n');
            
            const fileName = \`Recepcion_\${numeroGuia}_\${new Date().toISOString().split('T')[0]}.xlsx\`;
            XLSX.writeFile(wb, fileName);
            
            showToast('‚úÖ Recepci√≥n exportada a Excel');
        }

        async function handleScan(input) {
            showToast("Funci√≥n de escaneo no disponible en esta versi√≥n");
        }

        async function importarExcelRecepcion(file) {
            showToast("Funci√≥n de importaci√≥n no disponible en esta versi√≥n");
        }
    </script>
</body>
</html>`;

// Save to file
const fs = require('fs');
fs.writeFileSync('/mnt/user-data/outputs/inventario-coquinaria-completo.html', completeHTML, 'utf8');
${document.body.textContent.match(/const rawProducts = \[[\s\S]*?\];/)[0]}

        const CATEGORIES = ["Aperitivo", "Aderezos y Condimentos", "Bar y Mixolog√≠a", "Gourmet", "Mesa y Cocina", "Momentos Dulces", "Regalos", "T√© y Caf√©", "Otros"];

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let mainView = 'catalog'; 
        let stockMode = 'count'; 
        let currentCategory = 'Todos';
        let selectedDateKey = "";
        let searchTerm = '';
        
        let dataCount = {};
        let dataReception = {};
        let dataSuggestion = {};
        let currentDocNumber = "";
        
        let swipeStartX = 0;
        let activeDetailSku = null;
        let shareTypeTemp = '';
        
        // SIGNATURE STATE
        let currentSignature = null;
        let signatureCanvas, signatureCtx, isDrawing = false;

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            initDate();
            loadAllData();
            setupSignatureCanvas();
            switchMainView('catalog'); 
            setupSearch();
            setupOverlaySwipe();
            window.addEventListener('scroll', handleScroll);
        });

        function initDate() {
            const dateInput = document.getElementById('dateInput');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            selectedDateKey = today;
            updateDateDisplay(today);
            dateInput.addEventListener('change', (e) => {
                selectedDateKey = e.target.value;
                updateDateDisplay(selectedDateKey);
                loadAllData();
                renderProducts();
            });
        }

        function updateDateDisplay(dateStr) {
            const parts = dateStr.split('-');
            document.querySelector('.header-date span').textContent = \`\${parts[2]}/\${parts[1]}\`;
        }
        function openDate() { document.getElementById('dateInput').showPicker(); }

        // ============================================
        // SIGNATURE CANVAS SETUP
        // ============================================
        function setupSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');
            
            signatureCtx.strokeStyle = '#1e293b';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            signatureCtx.beginPath();
            signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            signatureCtx.stroke();
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }

        function openSignatureModal() {
            document.getElementById('signatureModal').classList.add('active');
            clearSignature();
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.remove('active');
        }

        async function confirmSignature() {
            currentSignature = signatureCanvas.toDataURL('image/png');
            closeSignatureModal();
            
            showToast('üìù Generando PDF firmado...');
            
            await generarPDFFirmado();
        }

        // ============================================
        // GENERAR PDF CON FIRMA
        // ============================================
        async function generarPDFFirmado() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // HEADER
            doc.setFillColor(74, 4, 4);
            doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('üç∑ COQUINARIA', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('RECEPCI√ìN DE MERCADER√çA', 105, 23, { align: 'center' });

            // INFO
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(\`N¬∫ Gu√≠a: \${currentDocNumber}\`, 20, 40);
            doc.text(\`Fecha: \${new Date().toLocaleDateString('es-CL')}\`, 20, 47);
            doc.text(\`Hora: \${new Date().toLocaleTimeString('es-CL')}\`, 20, 54);

            // TABLA
            let y = 65;
            doc.setFillColor(241, 245, 249);
            doc.rect(20, y, 170, 8, 'F');
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text('SKU', 25, y + 5);
            doc.text('Producto', 50, y + 5);
            doc.text('Cantidad', 160, y + 5);

            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);

            let totalProductos = 0;
            let totalUnidades = 0;

            rawProducts.forEach(p => {
                const qty = dataReception[p.sku] || 0;
                if (qty > 0) {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(p.sku, 25, y);
                    const nombre = p.name.length > 45 ? p.name.substring(0, 45) + '...' : p.name;
                    doc.text(nombre, 50, y);
                    doc.text(qty.toString(), 165, y);

                    y += 7;
                    totalProductos++;
                    totalUnidades += qty;
                }
            });

            // RESUMEN
            y += 5;
            doc.setDrawColor(200, 200, 200);
            doc.line(20, y, 190, y);
            
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.text(\`Total productos: \${totalProductos}\`, 25, y);
            doc.text(\`Total unidades: \${totalUnidades}\`, 25, y + 7);

            // FIRMA
            y += 20;
            if (currentSignature) {
                doc.addImage(currentSignature, 'PNG', 25, y, 60, 25);
            }
            
            y += 30;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('_______________________________', 25, y);
            doc.text('Firma Recepcionista', 25, y + 5);
            doc.text(\`Firmado el: \${new Date().toLocaleString('es-CL')}\`, 25, y + 10);

            // FOOTER
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Documento generado autom√°ticamente por Sistema Coquinaria', 105, 285, { align: 'center' });

            // GUARDAR
            const fileName = \`Recepcion_\${currentDocNumber}_\${new Date().toISOString().split('T')[0]}_FIRMADO.pdf\`;
            doc.save(fileName);

            showToast('‚úÖ PDF firmado descargado');
        }

        // ============================================
        // DATA MANAGER
        // ============================================
        function loadAllData() {
            try {
                dataCount = JSON.parse(localStorage.getItem(\`inv_count_\${selectedDateKey}\`)) || {};
                dataReception = JSON.parse(localStorage.getItem(\`inv_recep_\${selectedDateKey}\`)) || {};
                dataSuggestion = JSON.parse(localStorage.getItem(\`inv_sugg_\${selectedDateKey}\`)) || {};
                const savedDoc = localStorage.getItem(\`inv_recep_doc_\${selectedDateKey}\`);
                if(savedDoc) currentDocNumber = savedDoc;
            } catch (e) {
                dataCount = {}; dataReception = {}; dataSuggestion = {};
            }
        }

        function saveData() {
            localStorage.setItem(\`inv_count_\${selectedDateKey}\`, JSON.stringify(dataCount));
            localStorage.setItem(\`inv_recep_\${selectedDateKey}\`, JSON.stringify(dataReception));
            localStorage.setItem(\`inv_sugg_\${selectedDateKey}\`, JSON.stringify(dataSuggestion));
            if(stockMode === 'reception') localStorage.setItem(\`inv_recep_doc_\${selectedDateKey}\`, currentDocNumber);
            document.getElementById('lastSavedIndicator').textContent = 'Guardado ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function switchMainView(view) {
            mainView = view;
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(\`nav-\${view}\`).classList.add('active');
            
            const prodView = document.getElementById('view-products');
            const histView = document.getElementById('view-history');
            
            if (view === 'history') {
                prodView.style.display = 'none';
                histView.style.display = 'block';
                renderHistory();
            } else {
                prodView.style.display = 'block';
                histView.style.display = 'none';
            }
            
            const toolbar = document.getElementById('toolbarMenu');
            toolbar.innerHTML = ''; 

            if (view === 'catalog') {
                renderCategories(toolbar);
            } else if (view === 'stock') {
                renderStockTools(toolbar);
            }
            
            renderProducts();
            window.scrollTo(0,0);
        }

        function renderCategories(container) {
            const cats = ['Todos', ...CATEGORIES];
            container.innerHTML = cats.map(cat => \`
                <div class="menu-chip \${currentCategory === cat ? 'active' : ''}" 
                     onclick="selectCategory('\${cat}')"> \${cat}</div>
            \`).join('');
        }

        function selectCategory(cat) {
            currentCategory = cat;
            switchMainView('catalog');
        }

        function renderStockTools(container) {
            const modes = [
                {id: 'date', label: 'Fecha', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />'},
                {id: 'count', label: 'Conteo', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />'},
                {id: 'reception', label: 'Recepci√≥n', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />'},
                {id: 'suggestion', label: 'Sugerido', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />'},
                {id: 'import', label: 'Importar', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />'}
            ];

            container.innerHTML = modes.map(m => {
                let activeClass = '';
                if(stockMode === m.id) {
                    if(m.id === 'count') activeClass = 'count-active';
                    else if(m.id === 'reception') activeClass = 'recep-active';
                    else if(m.id === 'suggestion') activeClass = 'sugg-active';
                }

                let onclick = \`setStockMode('\${m.id}')\`;
                if(m.id === 'date') onclick = \`openDate()\`;
                if(m.id === 'import') onclick = \`document.getElementById('fileImport').click()\`;

                return \`
                <div class="menu-chip \${activeClass}" onclick="\${onclick}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\${m.icon}</svg>
                    \${m.label}
                </div>\`;
            }).join('');
            
            if (stockMode === 'reception') {
                container.innerHTML += \`
                <div class="menu-chip" onclick="triggerCamera()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Escanear Gu√≠a
                </div>
                <div class="menu-chip" onclick="document.getElementById('importExcelInput').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    Importar Excel
                </div>\`;
            }
        }

        function setStockMode(mode) {
            stockMode = mode;
            switchMainView('stock');
        }

        function triggerCamera() { document.getElementById('scanInput').click(); }

        // ============================================
        // RENDER PRODUCTS
        // ============================================
        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const ctaContainer = document.getElementById('ctaContainer');
            const docContainer = document.getElementById('docInputContainer');
            
            if(!container) return;

            ctaContainer.innerHTML = ''; 
            docContainer.innerHTML = '';

            let filtered = rawProducts.filter(p => {
                if (searchTerm) {
                    const term = searchTerm;
                    const matchesName = p.name.toLowerCase().includes(term);
                    const matchesSku = p.sku.includes(term);
                    const matchesBrand = p.brand.toLowerCase().includes(term);
                    const matchesOrigin = p.origin ? p.origin.toLowerCase().includes(term) : false;
                    
                    if (!matchesName && !matchesSku && !matchesBrand && !matchesOrigin) return false;
                }
                
                if (mainView === 'catalog') {
                    if (currentCategory !== 'Todos') {
                        if (currentCategory === 'Otros') return !p.category;
                        return p.category === currentCategory;
                    }
                }
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No se encontraron productos</div>';
                return;
            }

            if (mainView === 'stock' && stockMode === 'reception') {
                docContainer.innerHTML = \`
                <div class="doc-input-container">
                    <span style="font-weight:600; font-size:13px; color:#1e293b;">N¬∞ Gu√≠a:</span>
                    <input type="text" id="docNumberInput" class="doc-input" placeholder="Ej: 123456" value="\${currentDocNumber}" onchange="updateDocNumber(this.value)">
                </div>\`;
            }

            if (mainView === 'stock') {
                let btnText = "";
                let modeLabel = "";
                if (stockMode === 'count') { btnText = "Finalizar Conteo"; modeLabel="Conteo"; }
                if (stockMode === 'reception') { btnText = "Finalizar Recepci√≥n"; modeLabel="Recepci√≥n"; }
                if (stockMode === 'suggestion') { btnText = "Finalizar Sugerido"; modeLabel="Sugerido"; }
                
                if(btnText) {
                    ctaContainer.innerHTML = \`
                        <button class="btn-cta" onclick="openShareModal('\${modeLabel}')">
                            \${btnText}
                        </button>
                    \`;
                    
                    if (stockMode === 'reception' && currentDocNumber) {
                        ctaContainer.innerHTML += \`
                            <button class="btn-cta secondary" onclick="exportarRecepcionCompleta('\${currentDocNumber}')" style="margin-top: 10px;">
                                üìä Exportar a Excel
                            </button>
                            <button class="btn-cta" onclick="openSignatureModal()" style="margin-top: 10px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);">
                                üìÑ Generar PDF Firmado
                            </button>
                        \`;
                    }
                }
            }

            container.innerHTML = filtered.map(p => {
                const qtyCount = dataCount[p.sku] || 0;
                const qtyRecep = dataReception[p.sku] || 0;
                const qtySugg = dataSuggestion[p.sku] || 0;

                let controls = '';
                let borderClass = '';
                let displayVal = 0;

                if (mainView === 'stock') {
                    let currentModeClass = '';
                    if (stockMode === 'count') {
                        displayVal = qtyCount;
                        currentModeClass = 'count-mode';
                        if(qtyCount > 0) borderClass = 'counted';
                    } else if (stockMode === 'reception') {
                        displayVal = qtyRecep;
                        currentModeClass = 'reception-mode';
                        if(qtyRecep > 0) borderClass = 'reception-counted';
                    } else if (stockMode === 'suggestion') {
                        displayVal = qtySugg;
                        currentModeClass = 'suggestion-mode';
                        if(qtySugg > 0) borderClass = 'suggestion-counted';
                    }

                    controls = \`
                        <div class="stock-control \${currentModeClass}" onclick="event.stopPropagation()">
                            <button class="btn-stock" onclick="modifyStock('\${p.sku}', -1)">-</button>
                            <input class="stock-input" value="\${displayVal}" readonly>
                            <button class="btn-stock" onclick="modifyStock('\${p.sku}', 1)">+</button>
                        </div>
                    \`;
                } else {
                    controls = \`<div class="catalog-display">\${qtyCount} un.</div>\`;
                }

                return \`
                    <div class="product-card \${borderClass}" onclick="openDetail('\${p.sku}')">
                        <div class="product-info">
                            <h4>\${p.name}</h4>
                            <div class="product-sku">SKU: \${p.sku}</div>
                        </div>
                        \${controls}
                    </div>
                \`;
            }).join('');
        }

        // ============================================
        // LOGIC
        // ============================================
        function updateDocNumber(val) {
            currentDocNumber = val;
            saveData();
        }

        function modifyStock(sku, delta) {
            let db;
            if (stockMode === 'count') db = dataCount;
            else if (stockMode === 'reception') db = dataReception;
            else if (stockMode === 'suggestion') db = dataSuggestion;
            
            const current = db[sku] || 0;
            const newVal = Math.max(0, current + delta);
            db[sku] = newVal;
            
            saveData();
            renderProducts(); 
        }

        // ============================================
        // SHARE MODAL & EXPORT
        // ============================================
        function openShareModal(type) {
            shareTypeTemp = type;
            document.getElementById('shareModalTitle').textContent = \`Compartir \${type}\`;
            document.getElementById('shareModal').classList.add('active');
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function executeShare(method) {
            const type = shareTypeTemp;
            closeShareModal();
            
            let db;
            let docInfo = "";
            if (type === 'Conteo') db = dataCount;
            else if (type === 'Recepci√≥n') { 
                db = dataReception; 
                if(currentDocNumber) docInfo = \`\\n*Documento:* \${currentDocNumber}\`;
            }
            else if (type === 'Sugerido') db = dataSuggestion;

            let text = \`*Reporte \${type} - \${selectedDateKey}*\${docInfo}\\n\\n\`;
            let bodyEmail = \`Reporte \${type} - \${selectedDateKey} \${docInfo}%0D%0A%0D%0A\`;
            
            let hasItems = false;
            
            rawProducts.forEach(p => {
                const val = db[p.sku] || 0;
                if(val > 0) {
                    text += \`- \${p.name}: \${val}\\n\`;
                    bodyEmail += \`- \${p.name}: \${val}%0D%0A\`;
                    hasItems = true;
                }
            });

            if (!hasItems) { showToast("No hay items para enviar"); return; }
            
            const hist = JSON.parse(localStorage.getItem('appHistory') || '[]');
            let label = type;
            if (type === 'Recepci√≥n' && currentDocNumber) label += \` #\${currentDocNumber}\`;
            
            hist.push({ 
                date: selectedDateKey, 
                type: label, 
                timestamp: new Date().toISOString(),
                docNum: currentDocNumber 
            });
            localStorage.setItem('appHistory', JSON.stringify(hist));

            if (method === 'whatsapp') {
                window.open(\`https://wa.me/?text=\${encodeURIComponent(text)}\`, '_blank');
            } else if (method === 'email') {
                window.open(\`mailto:?subject=Reporte \${type} \${selectedDateKey}&body=\${bodyEmail}\`, '_blank');
            }
        }
        
        function renderHistory() {
            const hist = JSON.parse(localStorage.getItem('appHistory') || '[]');
            const container = document.getElementById('historyContent');
            if(hist.length === 0) { container.innerHTML = '<div class="empty-state">Sin registros a√∫n</div>'; return; }
            container.innerHTML = hist.reverse().map(h => \`
                <div class="history-item">
                    <div>
                        <div style="color:#333; font-weight:600; margin-bottom:4px;">\${h.type}</div>
                        <div style="font-size:12px; color:#888;">\${new Date(h.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            \`).join('');
        }

        // ============================================
        // OVERLAY
        // ============================================
        function openDetail(sku) {
            const p = rawProducts.find(x => x.sku === sku);
            if(!p) return;
            activeDetailSku = sku;
            
            document.getElementById('dBrand').innerText = p.brand;
            document.getElementById('dName').innerText = p.name;
            document.getElementById('dSku').innerText = p.sku;
            document.getElementById('dDesc').innerText = p.description || 'Sin descripci√≥n disponible.';
            
            const imgEl = document.getElementById('dImg');
            const ph = document.getElementById('dPlace');
            
            if(p.image) {
                imgEl.src = p.image; imgEl.style.display = 'block'; ph.style.display = 'none';
            } else {
                imgEl.style.display = 'none'; ph.style.display = 'block';
            }
            
            const originEl = document.getElementById('dOrigin');
            if (p.origin) {
                originEl.textContent = p.origin;
                originEl.style.display = 'inline-block';
            } else {
                originEl.style.display = 'none';
            }

            document.getElementById('productOverlay').classList.add('active');
        }

        function closeOverlay() {
            document.getElementById('productOverlay').classList.remove('active');
        }

        function setupOverlaySwipe() {
            const card = document.getElementById('detailCard');
            card.addEventListener('touchstart', e => { swipeStartX = e.changedTouches[0].screenX; }, {passive: true});
            card.addEventListener('touchend', e => {
                const endX = e.changedTouches[0].screenX;
                if (swipeStartX - endX > 50) navigateDetail(1); 
                if (endX - swipeStartX > 50) navigateDetail(-1); 
            }, {passive: true});
        }

        function navigateDetail(dir) {
            const idx = rawProducts.findIndex(p => p.sku === activeDetailSku);
            if(idx === -1) return;
            let nextIdx = idx + dir;
            if(nextIdx >= rawProducts.length) nextIdx = 0;
            if(nextIdx < 0) nextIdx = rawProducts.length - 1;
            openDetail(rawProducts[nextIdx].sku);
        }

        // ============================================
        // UTILS
        // ============================================
        function handleSearch(el) {
            searchTerm = el.value.toLowerCase();
            document.querySelector('.clear-search').style.display = searchTerm ? 'block' : 'none';
            renderProducts();
        }
        function clearSearch() {
            searchTerm = '';
            document.getElementById('searchInput').value = '';
            document.querySelector('.clear-search').style.display = 'none';
            renderProducts();
        }
        function setupSearch() {
             document.getElementById('searchInput').addEventListener('keyup', (e) => handleSearch(e.target));
        }
        function handleFileImport() { showToast("Importaci√≥n no configurada en demo"); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        
        function handleScroll() {
            const btn = document.getElementById('floatingSaveBtn');
            const icon = document.getElementById('floatingIcon');
            if(window.scrollY > 150) btn.classList.add('visible');
            else btn.classList.remove('visible');
            
            const isBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100);
            if (isBottom) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />';
                btn.onclick = () => window.scrollTo({top:0, behavior:'smooth'});
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />';
                btn.onclick = () => window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
            }
        }

        function handleFloatingClick() {
            const isBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 100);
            if (isBottom) {
                window.scrollTo({top:0, behavior:'smooth'});
            } else {
                window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
            }
        }

        // ============================================
        // M√ìDULO EXCEL
        // ============================================
        async function cargarLibreriaXLSX() {
            if (window.XLSX) return window.XLSX;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
                script.onload = () => resolve(window.XLSX);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function exportarRecepcionCompleta(numeroGuia) {
            const XLSX = await cargarLibreriaXLSX();
            
            const productos = [];
            let totalDiferencias = 0;
            const faltantes = [];
            
            rawProducts.forEach(p => {
                const cantGuia = dataReception[p.sku] || 0;
                if (cantGuia > 0) {
                    const cantRecep = cantGuia;
                    const diff = cantRecep - cantGuia;
                    
                    productos.push({
                        sku: p.sku,
                        nombre: p.name,
                        cantGuia: cantGuia,
                        cantRecep: cantRecep,
                        diferencia: diff,
                        comentario: ''
                    });
                    
                    if (diff !== 0) {
                        totalDiferencias++;
                        faltantes.push({ sku: p.sku, nombre: p.name, diff: diff });
                    }
                }
            });
            
            const wb = XLSX.utils.book_new();
            
            const wsData = [];
            
            wsData.push(['COQUINARIA - RECEPCI√ìN DE MERCADER√çA']);
            wsData.push([]);
            wsData.push(['N¬∫ Gu√≠a:', numeroGuia, 'Fecha:', new Date().toLocaleDateString('es-CL')]);
            wsData.push(['Proveedor:', 'Kitchen Center', 'Documento:', currentDocNumber]);
            wsData.push([]);
            
            wsData.push(['SKU', 'Descripci√≥n', 'Cant. Gu√≠a', 'Cant. Recepcionada', 'Diferencia', 'Estado', 'Comentarios']);
            
            productos.forEach(prod => {
                const estado = prod.diferencia === 0 ? '‚úì OK' : (prod.diferencia < 0 ? '‚ö†Ô∏è FALTA' : 'üì¶ EXTRA');
                wsData.push([
                    prod.sku,
                    prod.nombre,
                    prod.cantGuia,
                    prod.cantRecep,
                    prod.diferencia,
                    estado,
                    prod.comentario
                ]);
            });
            
            wsData.push([]);
            wsData.push([]);
            
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['RESUMEN DE RECEPCI√ìN']);
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['Total productos:', productos.length]);
            wsData.push(['Productos con diferencias:', totalDiferencias]);
            wsData.push(['Total unidades gu√≠a:', productos.reduce((sum, p) => sum + p.cantGuia, 0)]);
            wsData.push(['Total unidades recepcionadas:', productos.reduce((sum, p) => sum + p.cantRecep, 0)]);
            wsData.push([]);
            
            if (faltantes.length > 0) {
                wsData.push(['DETALLE DE DIFERENCIAS:']);
                faltantes.forEach(f => {
                    wsData.push(['', \`SKU \${f.sku}: \${f.diff > 0 ? '+' : ''}\${f.diff} unidades (\${f.nombre})\`]);
                });
                wsData.push([]);
            }
            
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['FIRMA Y AUTORIZACI√ìN']);
            wsData.push(['‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê']);
            wsData.push(['Recepcionado por:', '____________________']);
            wsData.push(['Fecha y hora:', new Date().toLocaleString('es-CL')]);
            wsData.push(['Observaciones:', '']);
            wsData.push(['', '']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            ws['!cols'] = [
                { wch: 10 },
                { wch: 45 },
                { wch: 12 },
                { wch: 18 },
                { wch: 12 },
                { wch: 12 },
                { wch: 30 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Recepci√≥n');
            
            const fileName = \`Recepcion_\${numeroGuia}_\${new Date().toISOString().split('T')[0]}.xlsx\`;
            XLSX.writeFile(wb, fileName);
            
            showToast('‚úÖ Recepci√≥n exportada a Excel');
        }

        async function handleScan(input) {
            showToast("Funci√≥n de escaneo no disponible en esta versi√≥n");
        }

        async function importarExcelRecepcion(file) {
            showToast("Funci√≥n de importaci√≥n no disponible en esta versi√≥n");
        }
    </script>
</body>
</html>`;

// Save to file
const fs = require('fs');
fs.writeFileSync('/mnt/user-data/outputs/inventario-coquinaria-completo.html', completeHTML, 'utf8');
